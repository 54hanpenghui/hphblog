<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="baidu-site-verification" content="L6Lm9d5Crl"/>
  
  
  
  
  <title>Spark内核解析3 | 菜鸟清风</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Spark的交互流程 - 应用提交：">
<meta property="og:type" content="article">
<meta property="og:title" content="Spark内核解析3">
<meta property="og:url" content="https://www.hphblog.cn/2019/06/10/Spark%E5%86%85%E6%A0%B8%E8%A7%A3%E6%9E%903/index.html">
<meta property="og:site_name" content="菜鸟清风">
<meta property="og:description" content="Spark的交互流程 - 应用提交：">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://hphimages-1253879422.cos.ap-beijing.myqcloud.com/%E5%A4%A7%E6%95%B0%E6%8D%AE/Spark/%E5%86%85%E6%A0%B8/20190610123821.png">
<meta property="og:image" content="https://hphimages-1253879422.cos.ap-beijing.myqcloud.com/%E5%A4%A7%E6%95%B0%E6%8D%AE/Spark/%E5%86%85%E6%A0%B8/20190610213205.png">
<meta property="og:image" content="https://hphimages-1253879422.cos.ap-beijing.myqcloud.com/%E5%A4%A7%E6%95%B0%E6%8D%AE/Spark/%E5%86%85%E6%A0%B8/20190611230725.png">
<meta property="og:image" content="https://hphimages-1253879422.cos.ap-beijing.myqcloud.com/%E5%A4%A7%E6%95%B0%E6%8D%AE/Spark/%E5%86%85%E6%A0%B8/20190611233512.png">
<meta property="article:published_time" content="2019-06-10T04:37:00.000Z">
<meta property="article:modified_time" content="2020-01-12T13:08:27.611Z">
<meta property="article:author" content="清风笑丶">
<meta property="article:tag" content="Spark">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hphimages-1253879422.cos.ap-beijing.myqcloud.com/%E5%A4%A7%E6%95%B0%E6%8D%AE/Spark/%E5%86%85%E6%A0%B8/20190610123821.png">
  
    <link rel="alternative" href="/https://blog.csdn.net/weixin_39084521/rss/list" title="菜鸟清风" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.png">
  
  
  
<link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet" />
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
<meta name="generator" content="Hexo 4.2.0"></head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        
<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>

        <a href="/" class="profilepic">
            
            <img lazy-src="/img/avatar.jpg" class="js-avatar">
            
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">清风笑丶</a></h1>
        </hgroup>
        
        
            <form>
                <input type="text" class="st-default-search-input search" id="local-search-input" placeholder="搜索一下" autocomplete="off">
            </form>
            <div id="local-search-result"></div>
        
        
            <script type="text/javascript">
                (function() {
                    'use strict';
                    function getMatchData(keyword, data) {
                        var matchData = [];
                        for(var i =0;i<data.length;i++){
                            if(data[i].title.toLowerCase().indexOf(keyword)>=0) 
                                matchData.push(data[i])
                        }
                        return matchData;
                    }
                    var $input = $('#local-search-input');
                    var $resultContent = $('#local-search-result');
                    $input.keyup(function(){
                        $.ajax({
                            url: '/search.json',
                            dataType: "json",
                            success: function( json ) {
                                var str='<ul class=\"search-result-list\">';                
                                var keyword = $input.val().trim().toLowerCase();
                                $resultContent.innerHTML = "";
                                if ($input.val().trim().length <= 0) {
                                    $resultContent.empty();
                                    $('#switch-area').show();
                                    return;
                                }
                                var results = getMatchData(keyword, json);
                                if(results.length === 0){
                                    $resultContent.empty();
                                    $('#switch-area').show();
                                    return;
                                } 
                                for(var i =0; i<results.length; i++){
                                    str += "<li><a href='"+ results[i].url +"' class='search-result-title'>"+ results[i].title +"</a></li>";
                                }
                                str += "</ul>";
                                $resultContent.empty();
                                $resultContent.append(str);
                                $('#switch-area').hide();
                            }
                        });
                    });
                })();
            </script>
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        
        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a  href="/archives/">所有文章</a></li>
                        
                            <li><a  href="/categories/Java/">Java</a></li>
                        
                            <li><a  href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE">大数据</a></li>
                        
                            <li><a  href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93">数据库</a></li>
                        
                            <li><a  href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">数据结构</a></li>
                        
                            <li><a  href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl github"  target="_blank" href="https://github.com/bigdataxiaohan" title="github">github</a>
                            
                                <a class="fl zhihu"  target="_blank" href="https://www.zhihu.com/people/qing-feng-xiao-zhu-15/activities" title="zhihu">zhihu</a>
                            
                                <a class="fl mail"  target="_blank" href="mailto:467008580@qq.com" title="mail">mail</a>
                            
                        </ul>
                    </nav>
                </section>
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/AVL%E6%A0%91/" style="font-size: 10px;">AVL树</a> <a href="/tags/Docker/" style="font-size: 14.44px;">Docker</a> <a href="/tags/Dubbo/" style="font-size: 10px;">Dubbo</a> <a href="/tags/Elasticsearch/" style="font-size: 17.78px;">Elasticsearch</a> <a href="/tags/Eureka/" style="font-size: 10px;">Eureka</a> <a href="/tags/Feign/" style="font-size: 10px;">Feign</a> <a href="/tags/Flink/" style="font-size: 10px;">Flink</a> <a href="/tags/Flume/" style="font-size: 11.11px;">Flume</a> <a href="/tags/Git/" style="font-size: 10px;">Git</a> <a href="/tags/GraphX/" style="font-size: 10px;">GraphX</a> <a href="/tags/HBase/" style="font-size: 11.11px;">HBase</a> <a href="/tags/HDFS/" style="font-size: 11.11px;">HDFS</a> <a href="/tags/Hadoop/" style="font-size: 13.33px;">Hadoop</a> <a href="/tags/Hbase/" style="font-size: 11.11px;">Hbase</a> <a href="/tags/Hive/" style="font-size: 13.33px;">Hive</a> <a href="/tags/Hystrix/" style="font-size: 10px;">Hystrix</a> <a href="/tags/JPA/" style="font-size: 10px;">JPA</a> <a href="/tags/JSP/" style="font-size: 10px;">JSP</a> <a href="/tags/JSR107/" style="font-size: 10px;">JSR107</a> <a href="/tags/JVM/" style="font-size: 14.44px;">JVM</a> <a href="/tags/JavaWeb/" style="font-size: 10px;">JavaWeb</a> <a href="/tags/Kafka/" style="font-size: 14.44px;">Kafka</a> <a href="/tags/MapReduce/" style="font-size: 14.44px;">MapReduce</a> <a href="/tags/Memcached/" style="font-size: 10px;">Memcached</a> <a href="/tags/MongoDB/" style="font-size: 15.56px;">MongoDB</a> <a href="/tags/Mybatis/" style="font-size: 15.56px;">Mybatis</a> <a href="/tags/Oozie/" style="font-size: 10px;">Oozie</a> <a href="/tags/RDD/" style="font-size: 14.44px;">RDD</a> <a href="/tags/REST/" style="font-size: 10px;">REST</a> <a href="/tags/RPC/" style="font-size: 10px;">RPC</a> <a href="/tags/RabbitMQ/" style="font-size: 11.11px;">RabbitMQ</a> <a href="/tags/Redis/" style="font-size: 15.56px;">Redis</a> <a href="/tags/Ribbon/" style="font-size: 10px;">Ribbon</a> <a href="/tags/SSM/" style="font-size: 11.11px;">SSM</a> <a href="/tags/SparKSQL/" style="font-size: 12.22px;">SparKSQL</a> <a href="/tags/Spark/" style="font-size: 20px;">Spark</a> <a href="/tags/SparkStreaming/" style="font-size: 12.22px;">SparkStreaming</a> <a href="/tags/Spring/" style="font-size: 14.44px;">Spring</a> <a href="/tags/Spring-Security/" style="font-size: 10px;">Spring Security</a> <a href="/tags/SpringBoot/" style="font-size: 16.67px;">SpringBoot</a> <a href="/tags/SpringBoot-Admin/" style="font-size: 10px;">SpringBoot Admin</a> <a href="/tags/SpringCloud/" style="font-size: 18.89px;">SpringCloud</a> <a href="/tags/SpringConfig/" style="font-size: 10px;">SpringConfig</a> <a href="/tags/SpringMVC/" style="font-size: 15.56px;">SpringMVC</a> <a href="/tags/Sqoop/" style="font-size: 10px;">Sqoop</a> <a href="/tags/Structured-Streaming/" style="font-size: 10px;">Structured Streaming</a> <a href="/tags/Thymeleaf/" style="font-size: 10px;">Thymeleaf</a> <a href="/tags/Zookeeper/" style="font-size: 11.11px;">Zookeeper</a> <a href="/tags/zuul/" style="font-size: 10px;">zuul</a> <a href="/tags/%E4%BA%8C%E5%8F%89%E6%A0%91/" style="font-size: 11.11px;">二叉树</a> <a href="/tags/%E4%BB%BB%E5%8A%A1/" style="font-size: 10px;">任务</a> <a href="/tags/%E4%BC%98%E5%85%88%E9%98%9F%E5%88%97/" style="font-size: 10px;">优先队列</a> <a href="/tags/%E5%93%88%E5%B8%8C%E8%A1%A8/" style="font-size: 10px;">哈希表</a> <a href="/tags/%E5%A0%86/" style="font-size: 10px;">堆</a> <a href="/tags/%E5%AD%97%E5%85%B8%E6%A0%91/" style="font-size: 10px;">字典树</a> <a href="/tags/%E5%B9%B6%E6%9F%A5%E9%9B%86/" style="font-size: 10px;">并查集</a> <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" style="font-size: 10px;">微服务</a> <a href="/tags/%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B/" style="font-size: 10px;">技术选型</a> <a href="/tags/%E6%95%B0%E7%BB%84/" style="font-size: 10px;">数组</a> <a href="/tags/%E6%97%A5%E5%BF%97%E6%A1%86%E6%9E%B6/" style="font-size: 10px;">日志框架</a> <a href="/tags/%E6%A0%88/" style="font-size: 10px;">栈</a> <a href="/tags/%E7%BA%A2%E9%BB%91%E6%A0%91/" style="font-size: 10px;">红黑树</a> <a href="/tags/%E7%BB%AA%E8%AE%BA/" style="font-size: 10px;">绪论</a> <a href="/tags/%E9%80%92%E5%BD%92/" style="font-size: 10px;">递归</a> <a href="/tags/%E9%93%BE%E8%A1%A8/" style="font-size: 10px;">链表</a> <a href="/tags/%E9%98%9F%E5%88%97/" style="font-size: 10px;">队列</a>
                    </div>
                </section>
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank"  class="main-nav-link switch-friends-link" href="https://blog.csdn.net/weixin_39084521?t=1">csdn</a>
                    
                      <a target="_blank"  class="main-nav-link switch-friends-link" href="https://segmentfault.com/u/qingfengxiao">segmentfault</a>
                    
                      <a target="_blank"  class="main-nav-link switch-friends-link" href="https://www.jianshu.com/u/67dbb2933255">简书</a>
                    
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">文科男,理工芯。有借必有贷,有问必有答。</div>
                </section>
                
            </div>
        </div>
    </header>
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">清风笑丶</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="/img/avatar.jpg" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">清风笑丶</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/categories/Java/">Java</a></li>
                
                    <li><a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE">大数据</a></li>
                
                    <li><a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93">数据库</a></li>
                
                    <li><a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">数据结构</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="github" target="_blank" href="https://github.com/bigdataxiaohan" title="github">github</a>
                    
                        <a class="zhihu" target="_blank" href="https://www.zhihu.com/people/qing-feng-xiao-zhu-15/activities" title="zhihu">zhihu</a>
                    
                        <a class="mail" target="_blank" href="mailto:467008580@qq.com" title="mail">mail</a>
                    
                </div>
            </nav>
        </header>
    </div>
</nav>
      <div class="body-wrap"><article id="post-Spark内核解析3" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a  href="/2019/06/10/Spark%E5%86%85%E6%A0%B8%E8%A7%A3%E6%9E%903/" class="article-date">
      <time datetime="2019-06-10T04:37:00.000Z" itemprop="datePublished">2019-06-10</time>
</a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Spark内核解析3
    </h1>
  


      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spark/" rel="tag">Spark</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
         Spark的交互流程 - 应用提交：<Excerpt in index | 首页摘要><a id="more"></a> 


<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><p><img src="https://hphimages-1253879422.cos.ap-beijing.myqcloud.com/%E5%A4%A7%E6%95%B0%E6%8D%AE/Spark/%E5%86%85%E6%A0%B8/20190610123821.png" alt=""></p>
<p><code>橙色：提交用户Spark程序</code></p>
<p>1) 用户提交一个Spark程序，主要的流程如下所示：<br>2) 用户spark-submit脚本提交一个Spark程序，会创建一个ClientEndpoint对象，该对象负责与Master通信交互<br>3) ClientEndpoint向Master发送一个RequestSubmitDriver消息，表示提交用户程序<br>4) Master收到RequestSubmitDriver消息，向ClientEndpoint回复SubmitDriverResponse，表示用户程序已经完成注册<br>ClientEndpoint向Master发送RequestDriverStatus消息，请求Driver状态<br>5) 如果当前用户程序对应的Driver已经启动，则ClientEndpoint直接退出，完成提交用户程序<br>紫色：启动Driver进程<br>当用户提交用户Spark程序后，需要启动Driver来处理用户程序的计算逻辑，完成计算任务，这时Master协调需要启动一个Driver，具体流程如下所示：</p>
<p>1) Maser内存中维护着用户提交计算的任务Application，每次内存结构变更都会触发调度，向Worker发送LaunchDriver请求<br>2) Worker收到LaunchDriver消息，会启动一个DriverRunner线程去执行LaunchDriver的任务<br>3) DriverRunner线程在Worker上启动一个新的JVM实例，该JVM实例内运行一个Driver进程，该Driver会创建SparkContext对象<br><code>红色：注册Application</code><br>Dirver启动以后，它会创建SparkContext对象，初始化计算过程中必需的基本组件，并向Master注册Application，流程描述如下：</p>
<p>1) 创建SparkEnv对象，创建并管理一些基本组件<br>2) 创建TaskScheduler，负责Task调度<br>3) 创建StandaloneSchedulerBackend，负责与ClusterManager进行资源协商<br>4) 创建DriverEndpoint，其它组件可以与Driver进行通信<br>5) 在StandaloneSchedulerBackend内部创建一个StandaloneAppClient，负责处理与Master的通信交互<br>6) StandaloneAppClient创建一个ClientEndpoint，实际负责与Master通信<br>7) ClientEndpoint向Master发送RegisterApplication消息，注册Application<br>8) Master收到RegisterApplication请求后，回复ClientEndpoint一个RegisteredApplication消息，表示已经注册成功<br><code>蓝色：启动Executor进程</code><br>1)Master向Worker发送LaunchExecutor消息，请求启动Executor；同时Master会向Driver发送ExecutorAdded消息，表示Master已经新增了一个Executor（此时还未启动）<br>2) Worker收到LaunchExecutor消息，会启动一个ExecutorRunner线程去执行LaunchExecutor的任务<br>3) Worker向Master发送ExecutorStageChanged消息，通知Executor状态已发生变化<br>4) Master向Driver发送ExecutorUpdated消息，此时Executor已经启动<br><code>粉色：启动Task执行</code></p>
<p>1) StandaloneSchedulerBackend启动一个DriverEndpoint<br>2) DriverEndpoint启动后，会周期性地检查Driver维护的Executor的状态，如果有空闲的Executor便会调度任务执行<br>3) DriverEndpoint向TaskScheduler发送Resource Offer请求<br>4) 如果有可用资源启动Task，则DriverEndpoint向Executor发送LaunchTask请求<br>5) Executor进程内部的CoarseGrainedExecutorBackend调用内部的Executor线程的launchTask方法启动Task<br>6) Executor线程内部维护一个线程池，创建一个TaskRunner线程并提交到线程池执行<br><code>绿色：Task运行完成</code></p>
<p>1) Executor进程内部的Executor线程通知CoarseGrainedExecutorBackend，Task运行完成<br>2) CoarseGrainedExecutorBackend向DriverEndpoint发送StatusUpdated消息，通知Driver运行的Task状态发生变更<br>3) StandaloneSchedulerBackend调用TaskScheduler的updateStatus方法更新Task状态<br>4) StandaloneSchedulerBackend继续调用TaskScheduler的resourceOffers方法，调度其他任务运行</p>
<h2 id="应用提交"><a href="#应用提交" class="headerlink" title="应用提交"></a>应用提交</h2><h3 id="SparkSubumit"><a href="#SparkSubumit" class="headerlink" title="SparkSubumit"></a>SparkSubumit</h3><p>提交任务需要用到SparkSubumit这个类我们先看一下<code>main</code>方法</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">  <span class="keyword">val</span> appArgs = <span class="keyword">new</span> <span class="type">SparkSubmitArguments</span>(args) <span class="comment">//解析参数</span></span><br><span class="line">  <span class="keyword">if</span> (appArgs.verbose) &#123;</span><br><span class="line">    <span class="comment">// scalastyle:off println</span></span><br><span class="line">    printStream.println(appArgs)</span><br><span class="line">    <span class="comment">// scalastyle:on println</span></span><br><span class="line">  &#125;</span><br><span class="line">  appArgs.action <span class="keyword">match</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">SparkSubmitAction</span>.<span class="type">SUBMIT</span> =&gt; submit(appArgs) <span class="comment">//提交</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">SparkSubmitAction</span>.<span class="type">KILL</span> =&gt; kill(appArgs) <span class="comment">//杀死</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">SparkSubmitAction</span>.<span class="type">REQUEST_STATUS</span> =&gt; requestStatus(appArgs) <span class="comment">//查看状态</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以看一下SparkSubmitArguments里面的参数是什么</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> master: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> deployMode: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> executorMemory: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> executorCores: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> totalExecutorCores: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> propertiesFile: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> driverMemory: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> driverExtraClassPath: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> driverExtraLibraryPath: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> driverExtraJavaOptions: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> queue: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> numExecutors: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> files: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> archives: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> mainClass: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> primaryResource: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> name: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> childArgs: <span class="type">ArrayBuffer</span>[<span class="type">String</span>] = <span class="keyword">new</span> <span class="type">ArrayBuffer</span>[<span class="type">String</span>]()</span><br><span class="line"><span class="keyword">var</span> jars: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> packages: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> repositories: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> ivyRepoPath: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> packagesExclusions: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> verbose: <span class="type">Boolean</span> = <span class="literal">false</span></span><br><span class="line"><span class="keyword">var</span> isPython: <span class="type">Boolean</span> = <span class="literal">false</span></span><br><span class="line"><span class="keyword">var</span> pyFiles: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> isR: <span class="type">Boolean</span> = <span class="literal">false</span></span><br><span class="line"><span class="keyword">var</span> action: <span class="type">SparkSubmitAction</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">val</span> sparkProperties: <span class="type">HashMap</span>[<span class="type">String</span>, <span class="type">String</span>] = <span class="keyword">new</span> <span class="type">HashMap</span>[<span class="type">String</span>, <span class="type">String</span>]()</span><br><span class="line"><span class="keyword">var</span> proxyUser: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> principal: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> keytab: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Standalone cluster mode only</span></span><br><span class="line"><span class="keyword">var</span> supervise: <span class="type">Boolean</span> = <span class="literal">false</span></span><br><span class="line"><span class="keyword">var</span> driverCores: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> submissionToKill: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> submissionToRequestStatusFor: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">var</span> useRest: <span class="type">Boolean</span> = <span class="literal">true</span> <span class="comment">// used internally</span></span><br></pre></td></tr></table></figure>

<p>这些参数在运行的时候我们都可以指定比如</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">./bin/spark-submit --class org.apache.spark.examples.SparkPi \</span><br><span class="line">--master yarn \</span><br><span class="line">--deploy-mode cluster \</span><br><span class="line">--driver-memory 1g \</span><br><span class="line">--executor-memory 1g \</span><br><span class="line">--executor-cores 1 \</span><br><span class="line">--queue thequeue \</span><br><span class="line">examples/target/scala-2.11/jars/spark-examples*.jar 10</span><br></pre></td></tr></table></figure>



<table>
<thead>
<tr>
<th>参数名</th>
<th>参数说明</th>
</tr>
</thead>
<tbody><tr>
<td>–master</td>
<td>master 的地址，提交任务到哪里执行，例如 spark://host:port,  yarn,  local</td>
</tr>
<tr>
<td>–deploy-mode</td>
<td>在本地 (client) 启动 driver 或在 cluster 上启动，默认是 client</td>
</tr>
<tr>
<td>–class</td>
<td>应用程序的主类，仅针对 java 或 scala 应用</td>
</tr>
<tr>
<td>–name</td>
<td>应用程序的名称</td>
</tr>
<tr>
<td>–jars</td>
<td>用逗号分隔的本地 jar 包，设置后，这些 jar 将包含在 driver 和 executor 的 classpath 下</td>
</tr>
<tr>
<td>–packages</td>
<td>包含在driver 和executor 的 classpath 中的 jar 的 maven 坐标</td>
</tr>
<tr>
<td>–exclude-packages</td>
<td>为了避免冲突 而指定不包含的 package</td>
</tr>
<tr>
<td>–repositories</td>
<td>远程 repository</td>
</tr>
<tr>
<td>–conf PROP=VALUE</td>
<td>指定 spark 配置属性的值， 例如 -conf spark.executor.extraJavaOptions=”-XX:MaxPermSize=256m”</td>
</tr>
<tr>
<td>–properties-file</td>
<td>加载的配置文件，默认为 conf/spark-defaults.conf</td>
</tr>
<tr>
<td>–driver-memory</td>
<td>Driver内存，默认 1G</td>
</tr>
<tr>
<td>–driver-java-options</td>
<td>传给 driver 的额外的 Java 选项</td>
</tr>
<tr>
<td>–driver-library-path</td>
<td>传给 driver 的额外的库路径</td>
</tr>
<tr>
<td>–driver-class-path</td>
<td>传给 driver 的额外的类路径</td>
</tr>
<tr>
<td>–driver-cores</td>
<td>Driver 的核数，默认是1。在 yarn 或者 standalone 下使用</td>
</tr>
<tr>
<td>–executor-memory</td>
<td>每个 executor 的内存，默认是1G</td>
</tr>
<tr>
<td>–total-executor-cores</td>
<td>所有 executor 总共的核数。仅仅在 mesos 或者 standalone 下使用</td>
</tr>
<tr>
<td>–num-executors</td>
<td>启动的 executor 数量。默认为2。在 yarn 下使用</td>
</tr>
<tr>
<td>–executor-core</td>
<td>每个 executor 的核数。在yarn或者standalone下使用</td>
</tr>
</tbody></table>
<h3 id="submit"><a href="#submit" class="headerlink" title="submit"></a>submit</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@tailrec</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">submit</span></span>(args: <span class="type">SparkSubmitArguments</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="comment">//根据参数准备提交应用时所需的环境</span></span><br><span class="line">  <span class="keyword">val</span> (childArgs, childClasspath, sysProps, childMainClass) = prepareSubmitEnvironment(args)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">doRunMain</span></span>(): <span class="type">Unit</span> = &#123; </span><br><span class="line">    <span class="keyword">if</span> (args.proxyUser != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">val</span> proxyUser = <span class="type">UserGroupInformation</span>.createProxyUser(args.proxyUser,</span><br><span class="line">        <span class="type">UserGroupInformation</span>.getCurrentUser())</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        proxyUser.doAs(<span class="keyword">new</span> <span class="type">PrivilegedExceptionAction</span>[<span class="type">Unit</span>]() &#123;</span><br><span class="line">          <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">            runMain(childArgsm, childClasspath, sysProps, childMainClass, args.verbose)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> e: <span class="type">Exception</span> =&gt;</span><br><span class="line">          <span class="comment">// Hadoop's AuthorizationException suppresses the exception's stack trace, which</span></span><br><span class="line">          <span class="comment">// makes the message printed to the output by the JVM not very helpful. Instead,</span></span><br><span class="line">          <span class="comment">// detect exceptions with empty stack traces here, and treat them differently.</span></span><br><span class="line">          <span class="keyword">if</span> (e.getStackTrace().length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// scalastyle:off println</span></span><br><span class="line">            printStream.println(<span class="string">s"ERROR: <span class="subst">$&#123;e.getClass().getName()&#125;</span>: <span class="subst">$&#123;e.getMessage()&#125;</span>"</span>)</span><br><span class="line">            <span class="comment">// scalastyle:on println</span></span><br><span class="line">            exitFn(<span class="number">1</span>)</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> e</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      runMain(childArgs, childClasspath, sysProps, childMainClass, args.verbose)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// In standalone cluster mode, there are two submission gateways:</span></span><br><span class="line">   <span class="comment">//   (1) The traditional RPC gateway using o.a.s.deploy.Client as a wrapper</span></span><br><span class="line">   <span class="comment">//   (2) The new REST-based gateway introduced in Spark 1.3</span></span><br><span class="line">   <span class="comment">// The latter is the default behavior as of Spark 1.3, but Spark submit will fail over</span></span><br><span class="line">   <span class="comment">// to use the legacy gateway if the master endpoint turns out to be not a REST server.</span></span><br><span class="line">  <span class="keyword">if</span> (args.isStandaloneCluster &amp;&amp; args.useRest) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// scalastyle:off println</span></span><br><span class="line">      printStream.println(<span class="string">"Running Spark using the REST application submission protocol."</span>)</span><br><span class="line">      <span class="comment">// scalastyle:on println</span></span><br><span class="line">      doRunMain()  <span class="comment">//调用doRunMain</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">      <span class="comment">// Fail over to use the legacy submission gateway</span></span><br><span class="line">      <span class="keyword">case</span> e: <span class="type">SubmitRestConnectionException</span> =&gt;</span><br><span class="line">        printWarning(<span class="string">s"Master endpoint <span class="subst">$&#123;args.master&#125;</span> was not a REST server. "</span> +</span><br><span class="line">          <span class="string">"Falling back to legacy submission gateway instead."</span>)</span><br><span class="line">        args.useRest = <span class="literal">false</span></span><br><span class="line">        submit(args)</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// In all other modes, just run the main class as prepared</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    doRunMain() <span class="comment">//doRunMain</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="runMain"><a href="#runMain" class="headerlink" title="runMain"></a>runMain</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">runMain</span></span>(</span><br><span class="line">     childArgs: <span class="type">Seq</span>[<span class="type">String</span>],</span><br><span class="line">     childClasspath: <span class="type">Seq</span>[<span class="type">String</span>],</span><br><span class="line">     sysProps: <span class="type">Map</span>[<span class="type">String</span>, <span class="type">String</span>],</span><br><span class="line">     childMainClass: <span class="type">String</span>,</span><br><span class="line">     verbose: <span class="type">Boolean</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">   <span class="comment">// scalastyle:off println</span></span><br><span class="line">   <span class="keyword">if</span> (verbose) &#123; <span class="comment">//如果打开调试 则会输出</span></span><br><span class="line">     printStream.println(<span class="string">s"Main class:\n<span class="subst">$childMainClass</span>"</span>)</span><br><span class="line">     printStream.println(<span class="string">s"Arguments:\n<span class="subst">$&#123;childArgs.mkString("\n")&#125;</span>"</span>)</span><br><span class="line">     printStream.println(<span class="string">s"System properties:\n<span class="subst">$&#123;sysProps.mkString("\n")&#125;</span>"</span>)</span><br><span class="line">     printStream.println(<span class="string">s"Classpath elements:\n<span class="subst">$&#123;childClasspath.mkString("\n")&#125;</span>"</span>)</span><br><span class="line">     printStream.println(<span class="string">"\n"</span>)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// scalastyle:on println</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">val</span> loader =</span><br><span class="line">     <span class="keyword">if</span> (sysProps.getOrElse(<span class="string">"spark.driver.userClassPathFirst"</span>, <span class="string">"false"</span>).toBoolean) &#123;</span><br><span class="line">       <span class="keyword">new</span> <span class="type">ChildFirstURLClassLoader</span>(<span class="keyword">new</span> <span class="type">Array</span>[<span class="type">URL</span>](<span class="number">0</span>),</span><br><span class="line">         <span class="type">Thread</span>.currentThread.getContextClassLoader)</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="keyword">new</span> <span class="type">MutableURLClassLoader</span>(<span class="keyword">new</span> <span class="type">Array</span>[<span class="type">URL</span>](<span class="number">0</span>),</span><br><span class="line">         <span class="type">Thread</span>.currentThread.getContextClassLoader)</span><br><span class="line">     &#125;</span><br><span class="line">   <span class="type">Thread</span>.currentThread.setContextClassLoader(loader)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> (jar &lt;- childClasspath) &#123;</span><br><span class="line">     addJarToClasspath(jar, loader) <span class="comment">//添加jar包到类路径下</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> ((key, value) &lt;- sysProps) &#123;</span><br><span class="line">     <span class="type">System</span>.setProperty(key, value) <span class="comment">//sysProps 添加到 System</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">var</span> mainClass: <span class="type">Class</span>[_] = <span class="literal">null</span> </span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     mainClass = <span class="type">Utils</span>.classForName(childMainClass)  <span class="comment">//利用了反射childMainClass得到mainClass</span></span><br><span class="line">   &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">     <span class="keyword">case</span> e: <span class="type">ClassNotFoundException</span> =&gt; <span class="comment">//异常ClassNotFoundException</span></span><br><span class="line">       e.printStackTrace(printStream)</span><br><span class="line">       <span class="keyword">if</span> (childMainClass.contains(<span class="string">"thriftserver"</span>)) &#123;</span><br><span class="line">         <span class="comment">// scalastyle:off println</span></span><br><span class="line">         printStream.println(<span class="string">s"Failed to load main class <span class="subst">$childMainClass</span>."</span>)</span><br><span class="line">         printStream.println(<span class="string">"You need to build Spark with -Phive and -Phive-thriftserver."</span>)</span><br><span class="line">         <span class="comment">// scalastyle:on println</span></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="type">System</span>.exit(<span class="type">CLASS_NOT_FOUND_EXIT_STATUS</span>)</span><br><span class="line">     <span class="keyword">case</span> e: <span class="type">NoClassDefFoundError</span> =&gt;</span><br><span class="line">       e.printStackTrace(printStream)</span><br><span class="line">       <span class="keyword">if</span> (e.getMessage.contains(<span class="string">"org/apache/hadoop/hive"</span>)) &#123;</span><br><span class="line">         <span class="comment">// scalastyle:off println</span></span><br><span class="line">         printStream.println(<span class="string">s"Failed to load hive class."</span>)</span><br><span class="line">         printStream.println(<span class="string">"You need to build Spark with -Phive and -Phive-thriftserver."</span>)</span><br><span class="line">         <span class="comment">// scalastyle:on println</span></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="type">System</span>.exit(<span class="type">CLASS_NOT_FOUND_EXIT_STATUS</span>)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// SPARK-4170   BUG 尚未解决的  缺陷跟踪</span></span><br><span class="line">   <span class="keyword">if</span> (classOf[scala.<span class="type">App</span>].isAssignableFrom(mainClass)) &#123;</span><br><span class="line">     printWarning(<span class="string">"Subclasses of scala.App may not work correctly. Use a main() method instead."</span>)</span><br><span class="line">   &#125; </span><br><span class="line"><span class="comment">//get 一个  main 方法</span></span><br><span class="line">   <span class="keyword">val</span> mainMethod = mainClass.getMethod(<span class="string">"main"</span>, <span class="keyword">new</span> <span class="type">Array</span>[<span class="type">String</span>](<span class="number">0</span>).getClass)</span><br><span class="line">   <span class="keyword">if</span> (!<span class="type">Modifier</span>.isStatic(mainMethod.getModifiers)) &#123;</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IllegalStateException</span>(<span class="string">"The main method in the given main class must be static"</span>)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@tailrec</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">findCause</span></span>(t: <span class="type">Throwable</span>): <span class="type">Throwable</span> = t <span class="keyword">match</span> &#123;</span><br><span class="line">     <span class="keyword">case</span> e: <span class="type">UndeclaredThrowableException</span> =&gt;</span><br><span class="line">       <span class="keyword">if</span> (e.getCause() != <span class="literal">null</span>) findCause(e.getCause()) <span class="keyword">else</span> e</span><br><span class="line">     <span class="keyword">case</span> e: <span class="type">InvocationTargetException</span> =&gt;</span><br><span class="line">       <span class="keyword">if</span> (e.getCause() != <span class="literal">null</span>) findCause(e.getCause()) <span class="keyword">else</span> e</span><br><span class="line">     <span class="keyword">case</span> e: <span class="type">Throwable</span> =&gt;</span><br><span class="line">       e</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="comment">//反射执行通过childArgs</span></span><br><span class="line">     mainMethod.invoke(<span class="literal">null</span>, childArgs.toArray)</span><br><span class="line">   &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">     <span class="keyword">case</span> t: <span class="type">Throwable</span> =&gt;</span><br><span class="line">       findCause(t) <span class="keyword">match</span> &#123;</span><br><span class="line">         <span class="keyword">case</span> <span class="type">SparkUserAppException</span>(exitCode) =&gt;</span><br><span class="line">           <span class="type">System</span>.exit(exitCode)</span><br><span class="line"></span><br><span class="line">         <span class="keyword">case</span> t: <span class="type">Throwable</span> =&gt;</span><br><span class="line">           <span class="keyword">throw</span> t</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>由于<code>mainClass</code>利用了反射我们需要寻找一下<code>childMainClass</code> 注意观察 submit方法中<code>val (childArgs, childClasspath, sysProps, childMainClass) = prepareSubmitEnvironment(args)</code>我们查看一下<code>prepareSubmitEnvironment</code></p>
<h3 id="prepareSubmitEnvironment"><a href="#prepareSubmitEnvironment" class="headerlink" title="prepareSubmitEnvironment"></a>prepareSubmitEnvironment</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>[deploy] <span class="function"><span class="keyword">def</span> <span class="title">prepareSubmitEnvironment</span></span>(args: <span class="type">SparkSubmitArguments</span>)</span><br><span class="line">    : (<span class="type">Seq</span>[<span class="type">String</span>], <span class="type">Seq</span>[<span class="type">String</span>], <span class="type">Map</span>[<span class="type">String</span>, <span class="type">String</span>], <span class="type">String</span>) = &#123;</span><br><span class="line">  <span class="comment">// Return values</span></span><br><span class="line">  <span class="keyword">val</span> childArgs = <span class="keyword">new</span> <span class="type">ArrayBuffer</span>[<span class="type">String</span>]()</span><br><span class="line">  <span class="keyword">val</span> childClasspath = <span class="keyword">new</span> <span class="type">ArrayBuffer</span>[<span class="type">String</span>]()</span><br><span class="line">  <span class="keyword">val</span> sysProps = <span class="keyword">new</span> <span class="type">HashMap</span>[<span class="type">String</span>, <span class="type">String</span>]()</span><br><span class="line">  <span class="keyword">var</span> childMainClass = <span class="string">""</span>  <span class="comment">//目标出现</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set the cluster manager  </span></span><br><span class="line">  <span class="keyword">val</span> clusterManager: <span class="type">Int</span> = args.master <span class="keyword">match</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"yarn"</span> =&gt; <span class="type">YARN</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"yarn-client"</span> | <span class="string">"yarn-cluster"</span> =&gt;</span><br><span class="line">      printWarning(<span class="string">s"Master <span class="subst">$&#123;args.master&#125;</span> is deprecated since 2.0."</span> +</span><br><span class="line">        <span class="string">" Please use master \"yarn\" with specified deploy mode instead."</span>)</span><br><span class="line">      <span class="type">YARN</span></span><br><span class="line">    <span class="keyword">case</span> m <span class="keyword">if</span> m.startsWith(<span class="string">"spark"</span>) =&gt; <span class="type">STANDALONE</span></span><br><span class="line">    <span class="keyword">case</span> m <span class="keyword">if</span> m.startsWith(<span class="string">"mesos"</span>) =&gt; <span class="type">MESOS</span></span><br><span class="line">    <span class="keyword">case</span> m <span class="keyword">if</span> m.startsWith(<span class="string">"local"</span>) =&gt; <span class="type">LOCAL</span></span><br><span class="line">    <span class="keyword">case</span> _ =&gt;</span><br><span class="line">      printErrorAndExit(<span class="string">"Master must either be yarn or start with spark, mesos, local"</span>)</span><br><span class="line">      <span class="number">-1</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set the deploy mode; default is client mode  设置 deploy 模式</span></span><br><span class="line">  <span class="keyword">var</span> deployMode: <span class="type">Int</span> = args.deployMode <span class="keyword">match</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"client"</span> | <span class="literal">null</span> =&gt; <span class="type">CLIENT</span> <span class="comment">// 如果是NULL 或者 "client" 默认为CLIENT</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"cluster"</span> =&gt; <span class="type">CLUSTER</span></span><br><span class="line">    <span class="keyword">case</span> _ =&gt; printErrorAndExit(<span class="string">"Deploy mode must be either client or cluster"</span>); <span class="number">-1</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Because the deprecated way of specifying "yarn-cluster" and "yarn-client" encapsulate both</span></span><br><span class="line">  <span class="comment">// the master and deploy mode, we have some logic to infer the master and deploy mode</span></span><br><span class="line">  <span class="comment">// from each other if only one is specified, or exit early if they are at odds.</span></span><br><span class="line">  <span class="keyword">if</span> (clusterManager == <span class="type">YARN</span>) &#123;   <span class="comment">//如果是YARN模式</span></span><br><span class="line">    (args.master, args.deployMode) <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> (<span class="string">"yarn-cluster"</span>, <span class="literal">null</span>) =&gt;</span><br><span class="line">        deployMode = <span class="type">CLUSTER</span></span><br><span class="line">        args.master = <span class="string">"yarn"</span></span><br><span class="line">      <span class="keyword">case</span> (<span class="string">"yarn-cluster"</span>, <span class="string">"client"</span>) =&gt;</span><br><span class="line">        printErrorAndExit(<span class="string">"Client deploy mode is not compatible with master \"yarn-cluster\""</span>)</span><br><span class="line">      <span class="keyword">case</span> (<span class="string">"yarn-client"</span>, <span class="string">"cluster"</span>) =&gt;</span><br><span class="line">        printErrorAndExit(<span class="string">"Cluster deploy mode is not compatible with master \"yarn-client\""</span>)</span><br><span class="line">      <span class="keyword">case</span> (_, mode) =&gt;</span><br><span class="line">        args.master = <span class="string">"yarn"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure YARN is included in our build if we're trying to use it</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="type">Utils</span>.classIsLoadable(<span class="string">"org.apache.spark.deploy.yarn.Client"</span>) &amp;&amp; !<span class="type">Utils</span>.isTesting) &#123;</span><br><span class="line">      printErrorAndExit(</span><br><span class="line">        <span class="string">"Could not load YARN classes. "</span> +</span><br><span class="line">        <span class="string">"This copy of Spark may not have been compiled with YARN support."</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Update args.deployMode if it is null. It will be passed down as a Spark property later.</span></span><br><span class="line">  (args.deployMode, deployMode) <span class="keyword">match</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> (<span class="literal">null</span>, <span class="type">CLIENT</span>) =&gt; args.deployMode = <span class="string">"client"</span></span><br><span class="line">    <span class="keyword">case</span> (<span class="literal">null</span>, <span class="type">CLUSTER</span>) =&gt; args.deployMode = <span class="string">"cluster"</span></span><br><span class="line">    <span class="keyword">case</span> _ =&gt;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">val</span> isYarnCluster = clusterManager == <span class="type">YARN</span> &amp;&amp; deployMode == <span class="type">CLUSTER</span></span><br><span class="line">  <span class="keyword">val</span> isMesosCluster = clusterManager == <span class="type">MESOS</span> &amp;&amp; deployMode == <span class="type">CLUSTER</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">   .....</span><br><span class="line">  <span class="comment">// A list of rules to map each argument to system properties or command-line options in</span></span><br><span class="line">  <span class="comment">// each deploy mode; we iterate through these below </span></span><br><span class="line">  <span class="keyword">val</span> options = <span class="type">List</span>[<span class="type">OptionAssigner</span>]( <span class="comment">// 整理一下 options 把参数聚集到了一块</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// All cluster managers</span></span><br><span class="line">    <span class="type">OptionAssigner</span>(args.master, <span class="type">ALL_CLUSTER_MGRS</span>, <span class="type">ALL_DEPLOY_MODES</span>, sysProp = <span class="string">"spark.master"</span>),</span><br><span class="line">    <span class="type">OptionAssigner</span>(args.deployMode, <span class="type">ALL_CLUSTER_MGRS</span>, <span class="type">ALL_DEPLOY_MODES</span>,</span><br><span class="line">      sysProp = <span class="string">"spark.submit.deployMode"</span>),</span><br><span class="line">    <span class="type">OptionAssigner</span>(args.name, <span class="type">ALL_CLUSTER_MGRS</span>, <span class="type">ALL_DEPLOY_MODES</span>, sysProp = <span class="string">"spark.app.name"</span>),</span><br><span class="line">    <span class="type">OptionAssigner</span>(args.ivyRepoPath, <span class="type">ALL_CLUSTER_MGRS</span>, <span class="type">CLIENT</span>, sysProp = <span class="string">"spark.jars.ivy"</span>),</span><br><span class="line">    <span class="type">OptionAssigner</span>(args.driverMemory, <span class="type">ALL_CLUSTER_MGRS</span>, <span class="type">CLIENT</span>,</span><br><span class="line">      sysProp = <span class="string">"spark.driver.memory"</span>),</span><br><span class="line">    <span class="type">OptionAssigner</span>(args.driverExtraClassPath, <span class="type">ALL_CLUSTER_MGRS</span>, <span class="type">ALL_DEPLOY_MODES</span>,</span><br><span class="line">      sysProp = <span class="string">"spark.driver.extraClassPath"</span>),</span><br><span class="line">    <span class="type">OptionAssigner</span>(args.driverExtraJavaOptions, <span class="type">ALL_CLUSTER_MGRS</span>, <span class="type">ALL_DEPLOY_MODES</span>,</span><br><span class="line">      sysProp = <span class="string">"spark.driver.extraJavaOptions"</span>),</span><br><span class="line">    <span class="type">OptionAssigner</span>(args.driverExtraLibraryPath, <span class="type">ALL_CLUSTER_MGRS</span>, <span class="type">ALL_DEPLOY_MODES</span>,</span><br><span class="line">      sysProp = <span class="string">"spark.driver.extraLibraryPath"</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Yarn only</span></span><br><span class="line">    <span class="type">OptionAssigner</span>(args.queue, <span class="type">YARN</span>, <span class="type">ALL_DEPLOY_MODES</span>, sysProp = <span class="string">"spark.yarn.queue"</span>),</span><br><span class="line">    <span class="type">OptionAssigner</span>(args.numExecutors, <span class="type">YARN</span>, <span class="type">ALL_DEPLOY_MODES</span>,</span><br><span class="line">      sysProp = <span class="string">"spark.executor.instances"</span>),</span><br><span class="line">    <span class="type">OptionAssigner</span>(args.jars, <span class="type">YARN</span>, <span class="type">ALL_DEPLOY_MODES</span>, sysProp = <span class="string">"spark.yarn.dist.jars"</span>),</span><br><span class="line">    <span class="type">OptionAssigner</span>(args.files, <span class="type">YARN</span>, <span class="type">ALL_DEPLOY_MODES</span>, sysProp = <span class="string">"spark.yarn.dist.files"</span>),</span><br><span class="line">    <span class="type">OptionAssigner</span>(args.archives, <span class="type">YARN</span>, <span class="type">ALL_DEPLOY_MODES</span>, sysProp = <span class="string">"spark.yarn.dist.archives"</span>),</span><br><span class="line">    <span class="type">OptionAssigner</span>(args.principal, <span class="type">YARN</span>, <span class="type">ALL_DEPLOY_MODES</span>, sysProp = <span class="string">"spark.yarn.principal"</span>),</span><br><span class="line">    <span class="type">OptionAssigner</span>(args.keytab, <span class="type">YARN</span>, <span class="type">ALL_DEPLOY_MODES</span>, sysProp = <span class="string">"spark.yarn.keytab"</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Other options</span></span><br><span class="line">    <span class="type">OptionAssigner</span>(args.executorCores, <span class="type">STANDALONE</span> | <span class="type">YARN</span>, <span class="type">ALL_DEPLOY_MODES</span>,</span><br><span class="line">      sysProp = <span class="string">"spark.executor.cores"</span>),</span><br><span class="line">    <span class="type">OptionAssigner</span>(args.executorMemory, <span class="type">STANDALONE</span> | <span class="type">MESOS</span> | <span class="type">YARN</span>, <span class="type">ALL_DEPLOY_MODES</span>,</span><br><span class="line">      sysProp = <span class="string">"spark.executor.memory"</span>),</span><br><span class="line">    <span class="type">OptionAssigner</span>(args.totalExecutorCores, <span class="type">STANDALONE</span> | <span class="type">MESOS</span>, <span class="type">ALL_DEPLOY_MODES</span>,</span><br><span class="line">      sysProp = <span class="string">"spark.cores.max"</span>),</span><br><span class="line">    <span class="type">OptionAssigner</span>(args.files, <span class="type">LOCAL</span> | <span class="type">STANDALONE</span> | <span class="type">MESOS</span>, <span class="type">ALL_DEPLOY_MODES</span>,</span><br><span class="line">      sysProp = <span class="string">"spark.files"</span>),</span><br><span class="line">    <span class="type">OptionAssigner</span>(args.jars, <span class="type">LOCAL</span>, <span class="type">CLIENT</span>, sysProp = <span class="string">"spark.jars"</span>),</span><br><span class="line">    <span class="type">OptionAssigner</span>(args.jars, <span class="type">STANDALONE</span> | <span class="type">MESOS</span>, <span class="type">ALL_DEPLOY_MODES</span>, sysProp = <span class="string">"spark.jars"</span>),</span><br><span class="line">    <span class="type">OptionAssigner</span>(args.driverMemory, <span class="type">STANDALONE</span> | <span class="type">MESOS</span> | <span class="type">YARN</span>, <span class="type">CLUSTER</span>,</span><br><span class="line">      sysProp = <span class="string">"spark.driver.memory"</span>),</span><br><span class="line">    <span class="type">OptionAssigner</span>(args.driverCores, <span class="type">STANDALONE</span> | <span class="type">MESOS</span> | <span class="type">YARN</span>, <span class="type">CLUSTER</span>,</span><br><span class="line">      sysProp = <span class="string">"spark.driver.cores"</span>),</span><br><span class="line">    <span class="type">OptionAssigner</span>(args.supervise.toString, <span class="type">STANDALONE</span> | <span class="type">MESOS</span>, <span class="type">CLUSTER</span>,</span><br><span class="line">      sysProp = <span class="string">"spark.driver.supervise"</span>),</span><br><span class="line">    <span class="type">OptionAssigner</span>(args.ivyRepoPath, <span class="type">STANDALONE</span>, <span class="type">CLUSTER</span>, sysProp = <span class="string">"spark.jars.ivy"</span>)</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment">// In client mode, launch the application main class directly</span></span><br><span class="line">  <span class="comment">// In addition, add the main application jar and any added jars (if any) to the classpath</span></span><br><span class="line">  <span class="comment">// Also add the main application jar and any added jars to classpath in case YARN client</span></span><br><span class="line">  <span class="comment">// requires these jars.</span></span><br><span class="line">  <span class="keyword">if</span> (deployMode == <span class="type">CLIENT</span> || isYarnCluster) &#123;</span><br><span class="line">    childMainClass = args.mainClass</span><br><span class="line">    <span class="keyword">if</span> (isUserJar(args.primaryResource)) &#123;</span><br><span class="line">      childClasspath += args.primaryResource</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (args.jars != <span class="literal">null</span>) &#123; childClasspath ++= args.jars.split(<span class="string">","</span>) &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (deployMode == <span class="type">CLIENT</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (args.childArgs != <span class="literal">null</span>) &#123; childArgs ++= args.childArgs &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Map all arguments to command-line options or system properties for our chosen mode</span></span><br><span class="line">  <span class="keyword">for</span> (opt &lt;- options) &#123;</span><br><span class="line">    <span class="keyword">if</span> (opt.value != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        (deployMode &amp; opt.deployMode) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (clusterManager &amp; opt.clusterManager) != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (opt.clOption != <span class="literal">null</span>) &#123; childArgs += (opt.clOption, opt.value) &#125;</span><br><span class="line">      <span class="keyword">if</span> (opt.sysProp != <span class="literal">null</span>) &#123; sysProps.put(opt.sysProp, opt.value) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add the application jar automatically so the user doesn't have to call sc.addJar</span></span><br><span class="line">  <span class="comment">// For YARN cluster mode, the jar is already distributed on each node as "app.jar"</span></span><br><span class="line">  <span class="comment">// For python and R files, the primary resource is already distributed as a regular file</span></span><br><span class="line">  <span class="keyword">if</span> (!isYarnCluster &amp;&amp; !args.isPython &amp;&amp; !args.isR) &#123;</span><br><span class="line">    <span class="keyword">var</span> jars = sysProps.get(<span class="string">"spark.jars"</span>).map(x =&gt; x.split(<span class="string">","</span>).toSeq).getOrElse(<span class="type">Seq</span>.empty)</span><br><span class="line">    <span class="keyword">if</span> (isUserJar(args.primaryResource)) &#123;</span><br><span class="line">      jars = jars ++ <span class="type">Seq</span>(args.primaryResource)</span><br><span class="line">    &#125;</span><br><span class="line">    sysProps.put(<span class="string">"spark.jars"</span>, jars.mkString(<span class="string">","</span>))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// In standalone cluster mode, use the REST client to submit the application (Spark 1.3+).</span></span><br><span class="line">  <span class="comment">// All Spark parameters are expected to be passed to the client through system properties.</span></span><br><span class="line">  <span class="keyword">if</span> (args.isStandaloneCluster) &#123; <span class="comment">//如果使用的是Standalone集群模式</span></span><br><span class="line">    <span class="keyword">if</span> (args.useRest) &#123;  <span class="comment">//如果用了useRest</span></span><br><span class="line">      childMainClass = <span class="string">"org.apache.spark.deploy.rest.RestSubmissionClient"</span> </span><br><span class="line">      childArgs += (args.primaryResource, args.mainClass)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">//如果没有用如useRest</span></span><br><span class="line">      <span class="comment">// In legacy standalone cluster mode, use Client as a wrapper around the user class</span></span><br><span class="line">      childMainClass = <span class="string">"org.apache.spark.deploy.Client"</span>  <span class="comment">//这个类使用到了Client 类</span></span><br><span class="line">      <span class="keyword">if</span> (args.supervise) &#123; childArgs += <span class="string">"--supervise"</span> &#125;</span><br><span class="line">      <span class="type">Option</span>(args.driverMemory).foreach &#123; m =&gt; childArgs += (<span class="string">"--memory"</span>, m) &#125;</span><br><span class="line">      <span class="type">Option</span>(args.driverCores).foreach &#123; c =&gt; childArgs += (<span class="string">"--cores"</span>, c) &#125;</span><br><span class="line">      childArgs += <span class="string">"launch"</span></span><br><span class="line">      childArgs += (args.master, args.primaryResource, args.mainClass)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (args.childArgs != <span class="literal">null</span>) &#123;</span><br><span class="line">      childArgs ++= args.childArgs</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Let YARN know it's a pyspark app, so it distributes needed libraries.</span></span><br><span class="line">  <span class="keyword">if</span> (clusterManager == <span class="type">YARN</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (args.isPython) &#123;</span><br><span class="line">      sysProps.put(<span class="string">"spark.yarn.isPython"</span>, <span class="string">"true"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (args.pyFiles != <span class="literal">null</span>) &#123;</span><br><span class="line">      sysProps(<span class="string">"spark.submit.pyFiles"</span>) = args.pyFiles</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// assure a keytab is available from any place in a JVM</span></span><br><span class="line">  <span class="keyword">if</span> (clusterManager == <span class="type">YARN</span> || clusterManager == <span class="type">LOCAL</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (args.principal != <span class="literal">null</span>) &#123;</span><br><span class="line">      require(args.keytab != <span class="literal">null</span>, <span class="string">"Keytab must be specified when principal is specified"</span>)</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">new</span> <span class="type">File</span>(args.keytab).exists()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">SparkException</span>(<span class="string">s"Keytab file: <span class="subst">$&#123;args.keytab&#125;</span> does not exist"</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Add keytab and principal configurations in sysProps to make them available</span></span><br><span class="line">        <span class="comment">// for later use; e.g. in spark sql, the isolated class loader used to talk</span></span><br><span class="line">        <span class="comment">// to HiveMetastore will use these settings. They will be set as Java system</span></span><br><span class="line">        <span class="comment">// properties and then loaded by SparkConf</span></span><br><span class="line">        sysProps.put(<span class="string">"spark.yarn.keytab"</span>, args.keytab)</span><br><span class="line">        sysProps.put(<span class="string">"spark.yarn.principal"</span>, args.principal)</span><br><span class="line"></span><br><span class="line">        <span class="type">UserGroupInformation</span>.loginUserFromKeytab(args.principal, args.keytab)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// In yarn-cluster mode, use yarn.Client as a wrapper around the user class</span></span><br><span class="line">  <span class="keyword">if</span> (isYarnCluster) &#123;</span><br><span class="line">    childMainClass = <span class="string">"org.apache.spark.deploy.yarn.Client"</span>  <span class="comment">//我们重点关注一下</span></span><br><span class="line">    <span class="keyword">if</span> (args.isPython) &#123;</span><br><span class="line">      childArgs += (<span class="string">"--primary-py-file"</span>, args.primaryResource)</span><br><span class="line">      childArgs += (<span class="string">"--class"</span>, <span class="string">"org.apache.spark.deploy.PythonRunner"</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (args.isR) &#123;</span><br><span class="line">      <span class="keyword">val</span> mainFile = <span class="keyword">new</span> <span class="type">Path</span>(args.primaryResource).getName</span><br><span class="line">      childArgs += (<span class="string">"--primary-r-file"</span>, mainFile)</span><br><span class="line">      childArgs += (<span class="string">"--class"</span>, <span class="string">"org.apache.spark.deploy.RRunner"</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (args.primaryResource != <span class="type">SparkLauncher</span>.<span class="type">NO_RESOURCE</span>) &#123;</span><br><span class="line">        childArgs += (<span class="string">"--jar"</span>, args.primaryResource)</span><br><span class="line">      &#125;</span><br><span class="line">      childArgs += (<span class="string">"--class"</span>, args.mainClass)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (args.childArgs != <span class="literal">null</span>) &#123;</span><br><span class="line">      args.childArgs.foreach &#123; arg =&gt; childArgs += (<span class="string">"--arg"</span>, arg) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isMesosCluster) &#123;</span><br><span class="line">   .....</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Load any properties specified through --conf and the default properties file</span></span><br><span class="line">  <span class="keyword">for</span> ((k, v) &lt;- args.sparkProperties) &#123;</span><br><span class="line">    sysProps.getOrElseUpdate(k, v)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Ignore invalid spark.driver.host in cluster modes.</span></span><br><span class="line">  <span class="keyword">if</span> (deployMode == <span class="type">CLUSTER</span>) &#123;</span><br><span class="line">    sysProps -= <span class="string">"spark.driver.host"</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Resolve paths in certain spark properties</span></span><br><span class="line">  <span class="keyword">val</span> pathConfigs = <span class="type">Seq</span>(</span><br><span class="line">    <span class="string">"spark.jars"</span>,</span><br><span class="line">    <span class="string">"spark.files"</span>,</span><br><span class="line">    <span class="string">"spark.yarn.dist.files"</span>,</span><br><span class="line">    <span class="string">"spark.yarn.dist.archives"</span>,</span><br><span class="line">    <span class="string">"spark.yarn.dist.jars"</span>)</span><br><span class="line">  pathConfigs.foreach &#123; config =&gt;</span><br><span class="line">    <span class="comment">// Replace old URIs with resolved URIs, if they exist</span></span><br><span class="line">    sysProps.get(config).foreach &#123; oldValue =&gt;</span><br><span class="line">      sysProps(config) = <span class="type">Utils</span>.resolveURIs(oldValue)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Resolve and format python file paths properly before adding them to the PYTHONPATH.</span></span><br><span class="line">  <span class="comment">// The resolving part is redundant in the case of --py-files, but necessary if the user</span></span><br><span class="line">  <span class="comment">// explicitly sets `spark.submit.pyFiles` in his/her default properties file.</span></span><br><span class="line">  sysProps.get(<span class="string">"spark.submit.pyFiles"</span>).foreach &#123; pyFiles =&gt;</span><br><span class="line">    <span class="keyword">val</span> resolvedPyFiles = <span class="type">Utils</span>.resolveURIs(pyFiles)</span><br><span class="line">    <span class="keyword">val</span> formattedPyFiles = <span class="keyword">if</span> (!isYarnCluster &amp;&amp; !isMesosCluster) &#123;</span><br><span class="line">      <span class="type">PythonRunner</span>.formatPaths(resolvedPyFiles).mkString(<span class="string">","</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Ignoring formatting python path in yarn and mesos cluster mode, these two modes</span></span><br><span class="line">      <span class="comment">// support dealing with remote python files, they could distribute and add python files</span></span><br><span class="line">      <span class="comment">// locally.</span></span><br><span class="line">      resolvedPyFiles</span><br><span class="line">    &#125;</span><br><span class="line">    sysProps(<span class="string">"spark.submit.pyFiles"</span>) = formattedPyFiles</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  (childArgs, childClasspath, sysProps, childMainClass)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h3><p>反射执行的main方法应该是Client的main方法</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">    <span class="comment">// scalastyle:off println</span></span><br><span class="line">    <span class="keyword">if</span> (!sys.props.contains(<span class="string">"SPARK_SUBMIT"</span>)) &#123;</span><br><span class="line">      println(<span class="string">"WARNING: This client is deprecated and will be removed in a future version of Spark"</span>) <span class="comment">//未来client 可能会被弃用</span></span><br><span class="line">      println(<span class="string">"Use ./bin/spark-submit with \"--master spark://host:port\""</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// scalastyle:on println</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>()</span><br><span class="line">    <span class="keyword">val</span> driverArgs = <span class="keyword">new</span> <span class="type">ClientArguments</span>(args)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!conf.contains(<span class="string">"spark.rpc.askTimeout"</span>)) &#123;</span><br><span class="line">      conf.set(<span class="string">"spark.rpc.askTimeout"</span>, <span class="string">"10s"</span>) <span class="comment">//设置rpc的超时时间</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Logger</span>.getRootLogger.setLevel(driverArgs.logLevel)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> rpcEnv =  <span class="comment">//创建 rpcEnv   需要主动和Master 发消息</span></span><br><span class="line">      <span class="type">RpcEnv</span>.create(<span class="string">"driverClient"</span>, <span class="type">Utils</span>.localHostName(), <span class="number">0</span>, conf, <span class="keyword">new</span> <span class="type">SecurityManager</span>(conf)) </span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> masterEndpoints = driverArgs.masters.map(<span class="type">RpcAddress</span>.fromSparkURL). <span class="comment">//创建masterEndpoints </span></span><br><span class="line">      map(rpcEnv.setupEndpointRef(_, <span class="type">Master</span>.<span class="type">ENDPOINT_NAME</span>)) <span class="comment">//获取master的Ref</span></span><br><span class="line">      <span class="comment">//给自己启动一个ClientEndpoint</span></span><br><span class="line">    rpcEnv.setupEndpoint(<span class="string">"client"</span>, <span class="keyword">new</span> <span class="type">ClientEndpoint</span>(rpcEnv, driverArgs, masterEndpoints, conf))</span><br><span class="line"></span><br><span class="line">    rpcEnv.awaitTermination()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ClientEndpoint"><a href="#ClientEndpoint" class="headerlink" title="ClientEndpoint"></a>ClientEndpoint</h3><p>我们需要查看一下ClientEndpoint</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientEndpoint</span>(<span class="params"></span></span></span><br><span class="line"><span class="class"><span class="params">    override val rpcEnv: <span class="type">RpcEnv</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    driverArgs: <span class="type">ClientArguments</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    masterEndpoints: <span class="type">Seq</span>[<span class="type">RpcEndpointRef</span>],</span></span></span><br><span class="line"><span class="class"><span class="params">    conf: <span class="type">SparkConf</span></span>)</span></span><br><span class="line"><span class="class">  <span class="keyword">extends</span> <span class="title">ThreadSafeRpcEndpoint</span> <span class="keyword">with</span> <span class="title">Logging</span> </span>&#123;  <span class="comment">//继承了ThreadSafeRpcEndpoint 我们关注一下具体方法</span></span><br><span class="line">      ....</span><br><span class="line">      </span><br><span class="line"> <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">onStart</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">    driverArgs.cmd <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"launch"</span> =&gt; <span class="comment">//是launch</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> We could add an env variable here and intercept it in `sc.addJar` that would</span></span><br><span class="line">        <span class="comment">//       truncate filesystem paths similar to what YARN does. For now, we just require</span></span><br><span class="line">        <span class="comment">//       people call `addJar` assuming the jar is in the same directory.</span></span><br><span class="line">        <span class="keyword">val</span> mainClass = <span class="string">"org.apache.spark.deploy.worker.DriverWrapper"</span>  <span class="comment">//图中紫色的DriverWorker</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> classPathConf = <span class="string">"spark.driver.extraClassPath"</span></span><br><span class="line">        <span class="keyword">val</span> classPathEntries = sys.props.get(classPathConf).toSeq.flatMap &#123; cp =&gt;</span><br><span class="line">          cp.split(java.io.<span class="type">File</span>.pathSeparator)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> libraryPathConf = <span class="string">"spark.driver.extraLibraryPath"</span></span><br><span class="line">        <span class="keyword">val</span> libraryPathEntries = sys.props.get(libraryPathConf).toSeq.flatMap &#123; cp =&gt;</span><br><span class="line">          cp.split(java.io.<span class="type">File</span>.pathSeparator)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> extraJavaOptsConf = <span class="string">"spark.driver.extraJavaOptions"</span></span><br><span class="line">        <span class="keyword">val</span> extraJavaOpts = sys.props.get(extraJavaOptsConf)</span><br><span class="line">          .map(<span class="type">Utils</span>.splitCommandString).getOrElse(<span class="type">Seq</span>.empty)</span><br><span class="line">        <span class="keyword">val</span> sparkJavaOpts = <span class="type">Utils</span>.sparkJavaOpts(conf)</span><br><span class="line">        <span class="keyword">val</span> javaOpts = sparkJavaOpts ++ extraJavaOpts</span><br><span class="line">        <span class="keyword">val</span> command = <span class="keyword">new</span> <span class="type">Command</span>(mainClass,  <span class="comment">//command是一个case Class 这段代码相当于组装进去了配置</span></span><br><span class="line">          <span class="type">Seq</span>(<span class="string">"&#123;&#123;WORKER_URL&#125;&#125;"</span>, <span class="string">"&#123;&#123;USER_JAR&#125;&#125;"</span>, driverArgs.mainClass) ++ driverArgs.driverOptions,</span><br><span class="line">          sys.env, classPathEntries, libraryPathEntries, javaOpts)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> driverDescription = <span class="keyword">new</span> <span class="type">DriverDescription</span>( <span class="comment">//创建了DriverDescription的描述</span></span><br><span class="line">          driverArgs.jarUrl,</span><br><span class="line">          driverArgs.memory, <span class="comment">//Driver内存小慎用Collect会把Executor所有的数据load进Driver的JVM中</span></span><br><span class="line">          driverArgs.cores,</span><br><span class="line">          driverArgs.supervise,</span><br><span class="line">          command)</span><br><span class="line">        ayncSendToMasterAndForwardReply[<span class="type">SubmitDriverResponse</span>]( <span class="comment">//异步地发送给Master Reply</span></span><br><span class="line">          <span class="type">RequestSubmitDriver</span>(driverDescription)) <span class="comment">//发送driverDescription信息</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">"kill"</span> =&gt;</span><br><span class="line">        <span class="keyword">val</span> driverId = driverArgs.driverId</span><br><span class="line">        ayncSendToMasterAndForwardReply[<span class="type">KillDriverResponse</span>](<span class="type">RequestKillDriver</span>(driverId))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> ....</span><br><span class="line">   <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">receive</span></span>: <span class="type">PartialFunction</span>[<span class="type">Any</span>, <span class="type">Unit</span>] = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="type">SubmitDriverResponse</span>(master, success, driverId, message) =&gt;</span><br><span class="line">      logInfo(message)</span><br><span class="line">      <span class="keyword">if</span> (success) &#123;</span><br><span class="line">        activeMasterEndpoint = master</span><br><span class="line">        pollAndReportStatus(driverId.get)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="type">Utils</span>.responseFromBackup(message)) &#123;</span><br><span class="line">        <span class="type">System</span>.exit(<span class="number">-1</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="type">KillDriverResponse</span>(master, driverId, success, message) =&gt;</span><br><span class="line">      logInfo(message)</span><br><span class="line">      <span class="keyword">if</span> (success) &#123;</span><br><span class="line">        activeMasterEndpoint = master</span><br><span class="line">        pollAndReportStatus(driverId)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="type">Utils</span>.responseFromBackup(message)) &#123;</span><br><span class="line">        <span class="type">System</span>.exit(<span class="number">-1</span>)</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="回到Master"><a href="#回到Master" class="headerlink" title="回到Master"></a>回到Master</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">receiveAndReply</span></span>(context: <span class="type">RpcCallContext</span>): <span class="type">PartialFunction</span>[<span class="type">Any</span>, <span class="type">Unit</span>] = &#123;     </span><br><span class="line">...</span><br><span class="line">   <span class="keyword">case</span> <span class="type">RequestSubmitDriver</span>(description) =&gt;  </span><br><span class="line">     <span class="keyword">if</span> (state != <span class="type">RecoveryState</span>.<span class="type">ALIVE</span>) &#123; <span class="comment">//如果没有存活</span></span><br><span class="line">       <span class="keyword">val</span> msg = <span class="string">s"<span class="subst">$&#123;Utils.BACKUP_STANDALONE_MASTER_PREFIX&#125;</span>: <span class="subst">$state</span>. "</span> +</span><br><span class="line">         <span class="string">"Can only accept driver submissions in ALIVE state."</span></span><br><span class="line">       context.reply(<span class="type">SubmitDriverResponse</span>(self, <span class="literal">false</span>, <span class="type">None</span>, msg)) <span class="comment">//设置为fasle</span></span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       logInfo(<span class="string">"Driver submitted "</span> + description.command.mainClass)</span><br><span class="line">       <span class="keyword">val</span> driver = createDriver(description) <span class="comment">//创建一个driver</span></span><br><span class="line">       persistenceEngine.addDriver(driver)</span><br><span class="line">       waitingDrivers += driver  <span class="comment">//将driver添加到waitingDrivers:集群不止一个jar在提交还有其它地,</span></span><br><span class="line">       drivers.add(driver)</span><br><span class="line">       schedule()</span><br><span class="line"></span><br><span class="line">       <span class="comment">// <span class="doctag">TODO:</span> It might be good to instead have the submission client poll the master to determine</span></span><br><span class="line">       <span class="comment">//       the current status of the driver. For now it's simply "fire and forget".</span></span><br><span class="line"></span><br><span class="line">       context.reply(<span class="type">SubmitDriverResponse</span>(self, <span class="literal">true</span>, <span class="type">Some</span>(driver.id), <span class="comment">//返回给Client</span></span><br><span class="line">         <span class="string">s"Driver successfully submitted as <span class="subst">$&#123;driver.id&#125;</span>"</span>))</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">createDriver</span></span>(desc: <span class="type">DriverDescription</span>): <span class="type">DriverInfo</span> = &#123;</span><br><span class="line">   <span class="keyword">val</span> now = <span class="type">System</span>.currentTimeMillis()</span><br><span class="line">   <span class="keyword">val</span> date = <span class="keyword">new</span> <span class="type">Date</span>(now)</span><br><span class="line">   <span class="keyword">new</span> <span class="type">DriverInfo</span>(now, newDriverId(date), desc, date)  <span class="comment">//创建了一个DriverInfo</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="回到Clinet"><a href="#回到Clinet" class="headerlink" title="回到Clinet"></a>回到Clinet</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">receive</span></span>: <span class="type">PartialFunction</span>[<span class="type">Any</span>, <span class="type">Unit</span>] = &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> <span class="type">SubmitDriverResponse</span>(master, success, driverId, message) =&gt;</span><br><span class="line">    logInfo(message) </span><br><span class="line">    <span class="keyword">if</span> (success) &#123; <span class="comment">//如果成功了</span></span><br><span class="line">      activeMasterEndpoint = master</span><br><span class="line">      pollAndReportStatus(driverId.get) <span class="comment">//调用此方法</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="type">Utils</span>.responseFromBackup(message)) &#123;</span><br><span class="line">      <span class="type">System</span>.exit(<span class="number">-1</span>)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="pollAndReportStatus"><a href="#pollAndReportStatus" class="headerlink" title="pollAndReportStatus"></a>pollAndReportStatus</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pollAndReportStatus</span></span>(driverId: <span class="type">String</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">  <span class="comment">// Since ClientEndpoint is the only RpcEndpoint in the process, blocking the event loop thread</span></span><br><span class="line">  <span class="comment">// is fine.</span></span><br><span class="line">  logInfo(<span class="string">"... waiting before polling master for driver state"</span>)</span><br><span class="line">  <span class="type">Thread</span>.sleep(<span class="number">5000</span>)</span><br><span class="line">  logInfo(<span class="string">"... polling master for driver state"</span>)</span><br><span class="line">  <span class="keyword">val</span> statusResponse = <span class="comment">//如果没有发送成功   重试</span></span><br><span class="line">    activeMasterEndpoint.askWithRetry[<span class="type">DriverStatusResponse</span>](<span class="type">RequestDriverStatus</span>(driverId))</span><br><span class="line">  <span class="keyword">if</span> (statusResponse.found) &#123; <span class="comment">//如果 没有问题</span></span><br><span class="line">    logInfo(<span class="string">s"State of <span class="subst">$driverId</span> is <span class="subst">$&#123;statusResponse.state.get&#125;</span>"</span>)</span><br><span class="line">    <span class="comment">// Worker node, if present</span></span><br><span class="line">    (statusResponse.workerId, statusResponse.workerHostPort, statusResponse.state) <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> (<span class="type">Some</span>(id), <span class="type">Some</span>(hostPort), <span class="type">Some</span>(<span class="type">DriverState</span>.<span class="type">RUNNING</span>)) =&gt;</span><br><span class="line">        logInfo(<span class="string">s"Driver running on <span class="subst">$hostPort</span> (<span class="subst">$id</span>)"</span>)</span><br><span class="line">      <span class="keyword">case</span> _ =&gt;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Exception, if present</span></span><br><span class="line">    statusResponse.exception <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="type">Some</span>(e) =&gt;</span><br><span class="line">        logError(<span class="string">s"Exception from cluster was: <span class="subst">$e</span>"</span>)</span><br><span class="line">        e.printStackTrace()</span><br><span class="line">        <span class="type">System</span>.exit(<span class="number">-1</span>)</span><br><span class="line">      <span class="keyword">case</span> _ =&gt;</span><br><span class="line">        <span class="type">System</span>.exit(<span class="number">0</span>)  <span class="comment">//退出</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123; <span class="comment">//如果错误</span></span><br><span class="line">    logError(<span class="string">s"ERROR: Cluster master did not recognize <span class="subst">$driverId</span>"</span>)</span><br><span class="line">    <span class="type">System</span>.exit(<span class="number">-1</span>)  <span class="comment">//错误退出</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="回到Master-1"><a href="#回到Master-1" class="headerlink" title="回到Master"></a>回到Master</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">receiveAndReply</span></span>(context: <span class="type">RpcCallContext</span>): <span class="type">PartialFunction</span>[<span class="type">Any</span>, <span class="type">Unit</span>] = &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">RegisterWorker</span>(</span><br><span class="line">        id, workerHost, workerPort, workerRef, cores, memory, workerWebUiUrl) =&gt;</span><br><span class="line">      logInfo(<span class="string">"Registering worker %s:%d with %d cores, %s RAM"</span>.format(</span><br><span class="line">        workerHost, workerPort, cores, <span class="type">Utils</span>.megabytesToString(memory)))</span><br><span class="line">      <span class="keyword">if</span> (state == <span class="type">RecoveryState</span>.<span class="type">STANDBY</span>) &#123;</span><br><span class="line">        context.reply(<span class="type">MasterInStandby</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (idToWorker.contains(id)) &#123;</span><br><span class="line">        context.reply(<span class="type">RegisterWorkerFailed</span>(<span class="string">"Duplicate worker ID"</span>))</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> worker = <span class="keyword">new</span> <span class="type">WorkerInfo</span>(id, workerHost, workerPort, cores, memory,</span><br><span class="line">          workerRef, workerWebUiUrl)</span><br><span class="line">        <span class="keyword">if</span> (registerWorker(worker)) &#123;</span><br><span class="line">          persistenceEngine.addWorker(worker)</span><br><span class="line">          context.reply(<span class="type">RegisteredWorker</span>(self, masterWebUiUrl))</span><br><span class="line">          schedule()  <span class="comment">// 调用了schedule()方法</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">val</span> workerAddress = worker.endpoint.address</span><br><span class="line">          logWarning(<span class="string">"Worker registration failed. Attempted to re-register worker at same "</span> +</span><br><span class="line">            <span class="string">"address: "</span> + workerAddress)</span><br><span class="line">          context.reply(<span class="type">RegisterWorkerFailed</span>(<span class="string">"Attempted to re-register worker at same address: "</span></span><br><span class="line">            + workerAddress))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<h3 id="schedule"><a href="#schedule" class="headerlink" title="schedule"></a>schedule</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Schedule the currently available resources among waiting apps. This method will be called</span></span><br><span class="line"><span class="comment">   * every time a new app joins or resource availability changes.</span></span><br><span class="line"><span class="comment">   */</span>  </span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">schedule</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">if</span> (state != <span class="type">RecoveryState</span>.<span class="type">ALIVE</span>) &#123;  <span class="comment">//如果当前地状态不是ALIVE</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Drivers take strict precedence over executors</span></span><br><span class="line">    <span class="keyword">val</span> shuffledAliveWorkers = <span class="type">Random</span>.shuffle(workers.toSeq.filter(_.state == <span class="type">WorkerState</span>.<span class="type">ALIVE</span>))</span><br><span class="line">    <span class="keyword">val</span> numWorkersAlive = shuffledAliveWorkers.size</span><br><span class="line">    <span class="keyword">var</span> curPos = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> (driver &lt;- waitingDrivers.toList) &#123; <span class="comment">// iterate over a copy of waitingDrivers</span></span><br><span class="line">      <span class="comment">// We assign workers to each waiting driver in a round-robin fashion. For each driver, we</span></span><br><span class="line">      <span class="comment">// start from the last worker that was assigned a driver, and continue onwards until we have</span></span><br><span class="line">      <span class="comment">// explored all alive workers.</span></span><br><span class="line">      <span class="keyword">var</span> launched = <span class="literal">false</span>   <span class="comment">//launched为false</span></span><br><span class="line">      <span class="keyword">var</span> numWorkersVisited = <span class="number">0</span></span><br><span class="line">      <span class="keyword">while</span> (numWorkersVisited &lt; numWorkersAlive &amp;&amp; !launched) &#123;</span><br><span class="line">        <span class="keyword">val</span> worker = shuffledAliveWorkers(curPos)</span><br><span class="line">        numWorkersVisited += <span class="number">1</span>   <span class="comment">//如果worker中的内存.CPU,</span></span><br><span class="line">        <span class="keyword">if</span> (worker.memoryFree &gt;= driver.desc.mem &amp;&amp; worker.coresFree &gt;= driver.desc.cores) &#123;</span><br><span class="line">          launchDriver(worker, driver)  <span class="comment">//调用launchDriver</span></span><br><span class="line">          waitingDrivers -= driver    <span class="comment">//将这个driver从 waitingDrivers 中去掉</span></span><br><span class="line">          launched = <span class="literal">true</span>    <span class="comment">//设置 launched 为true  </span></span><br><span class="line">        &#125;                       <span class="comment">//现在控制权应该走到了launchDriver</span></span><br><span class="line">        curPos = (curPos + <span class="number">1</span>) % numWorkersAlive</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    startExecutorsOnWorkers()</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="launchDriver"><a href="#launchDriver" class="headerlink" title="launchDriver"></a>launchDriver</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">launchDriver</span></span>(worker: <span class="type">WorkerInfo</span>, driver: <span class="type">DriverInfo</span>) &#123;</span><br><span class="line">  logInfo(<span class="string">"Launching driver "</span> + driver.id + <span class="string">" on worker "</span> + worker.id) </span><br><span class="line">  worker.addDriver(driver) <span class="comment">//这个worker在WorkerInfo中把当前的driver加上 Master可以知道那个Application运行在你的节点上</span></span><br><span class="line">  driver.worker = <span class="type">Some</span>(worker)</span><br><span class="line"> 	worker.endpoint.send(<span class="type">LaunchDriver</span>(driver.id, driver.desc))  <span class="comment">// 这个时候控制权应该在在Worker</span></span><br><span class="line">  driver.state = <span class="type">DriverState</span>.<span class="type">RUNNING</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="回到Worker"><a href="#回到Worker" class="headerlink" title="回到Worker"></a>回到Worker</h3><h3 id="LaunchDriver"><a href="#LaunchDriver" class="headerlink" title="LaunchDriver"></a>LaunchDriver</h3><p>DriverRunner包装了一下信息</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="type">LaunchDriver</span>(driverId, driverDesc) =&gt; <span class="comment">// Client中的</span></span><br><span class="line">    logInfo(<span class="string">s"Asked to launch driver <span class="subst">$driverId</span>"</span>) <span class="type">DriverRunner</span></span><br><span class="line">    <span class="keyword">val</span> driver = <span class="keyword">new</span> <span class="type">DriverRunner</span>( <span class="comment">// new 了一个 </span></span><br><span class="line">      conf,</span><br><span class="line">      driverId,</span><br><span class="line">      workDir,</span><br><span class="line">      sparkHome, </span><br><span class="line">      driverDesc.copy(command = <span class="type">Worker</span>.maybeUpdateSSLSettings(driverDesc.command, conf)), <span class="comment">//copy一下</span></span><br><span class="line">      self,</span><br><span class="line">      workerUri,</span><br><span class="line">      securityMgr)</span><br><span class="line">    drivers(driverId) = driver <span class="comment">//这里的drivers是一个HashMap:drivers保存每一个application的ID和DricerRunneer</span></span><br><span class="line">    driver.start()  <span class="comment">//调用一下方法</span></span><br><span class="line"></span><br><span class="line">    coresUsed += driverDesc.cores  <span class="comment">//粗粒度 统计 core 的使用情况</span></span><br><span class="line">    memoryUsed += driverDesc.me</span><br></pre></td></tr></table></figure>

<h3 id="调转DriverRunner"><a href="#调转DriverRunner" class="headerlink" title="调转DriverRunner"></a>调转DriverRunner</h3><h3 id="driver-star"><a href="#driver-star" class="headerlink" title="driver.star"></a>driver.star</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Starts a thread to run and manage the driver. */</span></span><br><span class="line"><span class="keyword">private</span>[worker] <span class="function"><span class="keyword">def</span> <span class="title">start</span></span>() = &#123;</span><br><span class="line">  <span class="keyword">new</span> <span class="type">Thread</span>(<span class="string">"DriverRunner for "</span> + driverId) &#123;    <span class="comment">//创建一个线程</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>() &#123; </span><br><span class="line">      <span class="keyword">var</span> shutdownHook: <span class="type">AnyRef</span> = <span class="literal">null</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        shutdownHook = <span class="type">ShutdownHookManager</span>.addShutdownHook &#123; () =&gt;</span><br><span class="line">          logInfo(<span class="string">s"Worker shutting down, killing driver <span class="subst">$driverId</span>"</span>)</span><br><span class="line">          kill()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// prepare driver jars and run driver</span></span><br><span class="line">        <span class="keyword">val</span> exitCode = prepareAndRunDriver() </span><br><span class="line"></span><br><span class="line">        <span class="comment">// set final state depending on if forcibly killed and process exit code</span></span><br><span class="line">        finalState = <span class="keyword">if</span> (exitCode == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="type">Some</span>(<span class="type">DriverState</span>.<span class="type">FINISHED</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (killed) &#123;</span><br><span class="line">          <span class="type">Some</span>(<span class="type">DriverState</span>.<span class="type">KILLED</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="type">Some</span>(<span class="type">DriverState</span>.<span class="type">FAILED</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> e: <span class="type">Exception</span> =&gt;</span><br><span class="line">          kill()</span><br><span class="line">          finalState = <span class="type">Some</span>(<span class="type">DriverState</span>.<span class="type">ERROR</span>)</span><br><span class="line">          finalException = <span class="type">Some</span>(e)</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (shutdownHook != <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="type">ShutdownHookManager</span>.removeShutdownHook(shutdownHook)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//没有出异常就Worker发送信息</span></span><br><span class="line">      <span class="comment">// notify worker of final driver state, possible exception  </span></span><br><span class="line">      worker.send(<span class="type">DriverStateChanged</span>(driverId, finalState.get, finalException))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;.start()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="prepareAndRunDriver"><a href="#prepareAndRunDriver" class="headerlink" title="prepareAndRunDriver"></a>prepareAndRunDriver</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> <span class="keyword">private</span>[worker] <span class="function"><span class="keyword">def</span> <span class="title">prepareAndRunDriver</span></span>(): <span class="type">Int</span> = &#123;   </span><br><span class="line">   <span class="keyword">val</span> driverDir = createWorkingDirectory()  <span class="comment">//创建一个工作目录</span></span><br><span class="line">   <span class="keyword">val</span> localJarFilename = downloadUserJar(driverDir) <span class="comment">//在DriverClinet有个小的http服务器,就是为了提供jar包的下载 这时候把jar包下载到我们的Worker里面了</span></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">substituteVariables</span></span>(argument: <span class="type">String</span>): <span class="type">String</span> = argument <span class="keyword">match</span> &#123;</span><br><span class="line">     <span class="keyword">case</span> <span class="string">"&#123;&#123;WORKER_URL&#125;&#125;"</span> =&gt; workerUrl</span><br><span class="line">     <span class="keyword">case</span> <span class="string">"&#123;&#123;USER_JAR&#125;&#125;"</span> =&gt; localJarFilename</span><br><span class="line">     <span class="keyword">case</span> other =&gt; other</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// <span class="doctag">TODO:</span> If we add ability to submit multiple jars they should also be added here</span></span><br><span class="line">     <span class="comment">//启动一个进程</span></span><br><span class="line">   <span class="keyword">val</span> builder = <span class="type">CommandUtils</span>.buildProcessBuilder(driverDesc.command, securityManager,</span><br><span class="line">     driverDesc.mem, sparkHome.getAbsolutePath, substituteVariables)</span><br><span class="line"><span class="comment">//这是</span></span><br><span class="line">   runDriver(builder, driverDir, driverDesc.supervise)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>我们查看一下<code>buildProcessBuilder</code></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buildProcessBuilder</span></span>(</span><br><span class="line">    command: <span class="type">Command</span>,</span><br><span class="line">    securityMgr: <span class="type">SecurityManager</span>,</span><br><span class="line">    memory: <span class="type">Int</span>,</span><br><span class="line">    sparkHome: <span class="type">String</span>,</span><br><span class="line">    substituteArguments: <span class="type">String</span> =&gt; <span class="type">String</span>,</span><br><span class="line">    classPaths: <span class="type">Seq</span>[<span class="type">String</span>] = <span class="type">Seq</span>[<span class="type">String</span>](),</span><br><span class="line">    env: <span class="type">Map</span>[<span class="type">String</span>, <span class="type">String</span>] = sys.env): <span class="type">ProcessBuilder</span> = &#123;</span><br><span class="line">  <span class="keyword">val</span> localCommand = buildLocalCommand(</span><br><span class="line">    command, securityMgr, substituteArguments, classPaths, env)</span><br><span class="line">  <span class="keyword">val</span> commandSeq = buildCommandSeq(localCommand, memory, sparkHome)</span><br><span class="line">  <span class="keyword">val</span> builder = <span class="keyword">new</span> <span class="type">ProcessBuilder</span>(commandSeq: _*)    <span class="comment">//Java中与运行本地命令的</span></span><br><span class="line">  <span class="keyword">val</span> environment = builder.environment()</span><br><span class="line">  <span class="keyword">for</span> ((key, value) &lt;- localCommand.environment) &#123;</span><br><span class="line">    environment.put(key, value)  </span><br><span class="line">  &#125;</span><br><span class="line">  builder</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="runDriver"><a href="#runDriver" class="headerlink" title="runDriver"></a>runDriver</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">runDriver</span></span>(builder: <span class="type">ProcessBuilder</span>, baseDir: <span class="type">File</span>, supervise: <span class="type">Boolean</span>): <span class="type">Int</span> = &#123;</span><br><span class="line">  builder.directory(baseDir)</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span>(process: <span class="type">Process</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="comment">// Redirect stdout and stderr to files</span></span><br><span class="line">    <span class="keyword">val</span> stdout = <span class="keyword">new</span> <span class="type">File</span>(baseDir, <span class="string">"stdout"</span>)  <span class="comment">//获取正确输出</span></span><br><span class="line">    <span class="type">CommandUtils</span>.redirectStream(process.getInputStream, stdout)</span><br><span class="line">	</span><br><span class="line">  <span class="comment">//获取异常</span></span><br><span class="line">    <span class="keyword">val</span> stderr = <span class="keyword">new</span> <span class="type">File</span>(baseDir, <span class="string">"stderr"</span>)</span><br><span class="line">    <span class="keyword">val</span> formattedCommand = builder.command.asScala.mkString(<span class="string">"\""</span>, <span class="string">"\" \""</span>, <span class="string">"\""</span>)</span><br><span class="line">    <span class="keyword">val</span> header = <span class="string">"Launch Command: %s\n%s\n\n"</span>.format(formattedCommand, <span class="string">"="</span> * <span class="number">40</span>)</span><br><span class="line">    <span class="type">Files</span>.append(header, stderr, <span class="type">StandardCharsets</span>.<span class="type">UTF_8</span>)   <span class="comment">//把日志输出到文件</span></span><br><span class="line">    <span class="type">CommandUtils</span>.redirectStream(process.getErrorStream, stderr)</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="comment">//重试</span></span><br><span class="line">  runCommandWithRetry(<span class="type">ProcessBuilderLike</span>(builder), initialize, supervise)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="runCommandWithRetry"><a href="#runCommandWithRetry" class="headerlink" title="runCommandWithRetry"></a>runCommandWithRetry</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span>[worker] <span class="function"><span class="keyword">def</span> <span class="title">runCommandWithRetry</span></span>(</span><br><span class="line">     command: <span class="type">ProcessBuilderLike</span>, initialize: <span class="type">Process</span> =&gt; <span class="type">Unit</span>, supervise: <span class="type">Boolean</span>): <span class="type">Int</span> = &#123;</span><br><span class="line">   <span class="keyword">var</span> exitCode = <span class="number">-1</span>  <span class="comment">//退出代码</span></span><br><span class="line">   <span class="comment">// Time to wait between submission retries.</span></span><br><span class="line">   <span class="keyword">var</span> waitSeconds = <span class="number">1</span></span><br><span class="line">   <span class="comment">// A run of this many seconds resets the exponential back-off.</span></span><br><span class="line">   <span class="keyword">val</span> successfulRunDuration = <span class="number">5</span></span><br><span class="line">   <span class="keyword">var</span> keepTrying = !killed</span><br><span class="line"><span class="comment">//重试</span></span><br><span class="line">   <span class="keyword">while</span> (keepTrying) &#123;</span><br><span class="line">     logInfo(<span class="string">"Launch Command: "</span> + command.command.mkString(<span class="string">"\""</span>, <span class="string">"\" \""</span>, <span class="string">"\""</span>))</span><br><span class="line"></span><br><span class="line">     synchronized &#123;</span><br><span class="line">       <span class="keyword">if</span> (killed) &#123; <span class="keyword">return</span> exitCode &#125;  </span><br><span class="line">       process = <span class="type">Some</span>(command.start()) <span class="comment">//这个process可能就是你的DriverWrapper</span></span><br><span class="line">       initialize(process.get)</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">val</span> processStart = clock.getTimeMillis()</span><br><span class="line">     exitCode = process.get.waitFor()</span><br><span class="line"></span><br><span class="line">     <span class="comment">// check if attempting another run</span></span><br><span class="line">     keepTrying = supervise &amp;&amp; exitCode != <span class="number">0</span> &amp;&amp; !killed</span><br><span class="line">     <span class="keyword">if</span> (keepTrying) &#123;</span><br><span class="line">       <span class="keyword">if</span> (clock.getTimeMillis() - processStart &gt; successfulRunDuration * <span class="number">1000</span>) &#123;</span><br><span class="line">         waitSeconds = <span class="number">1</span></span><br><span class="line">       &#125;</span><br><span class="line">       logInfo(<span class="string">s"Command exited with status <span class="subst">$exitCode</span>, re-launching after <span class="subst">$waitSeconds</span> s."</span>)</span><br><span class="line">       sleeper.sleep(waitSeconds)</span><br><span class="line">       waitSeconds = waitSeconds * <span class="number">2</span> <span class="comment">// exponential back-off</span></span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   exitCode</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="进入DriverWrapper"><a href="#进入DriverWrapper" class="headerlink" title="进入DriverWrapper"></a>进入DriverWrapper</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">DriverWrapper</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">    args.toList <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">       * IMPORTANT: Spark 1.3 provides a stable application submission gateway that is both</span></span><br><span class="line"><span class="comment">       * backward and forward compatible across future Spark versions. Because this gateway</span></span><br><span class="line"><span class="comment">       * uses this class to launch the driver, the ordering and semantics of the arguments</span></span><br><span class="line"><span class="comment">       * here must also remain consistent across versions.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">case</span> workerUrl :: userJar :: mainClass :: extraArgs =&gt;</span><br><span class="line">        <span class="keyword">val</span> rpcEnv = <span class="type">RpcEnv</span>.create(<span class="string">"Driver"</span>,    <span class="comment">//创建rpcEnv</span></span><br><span class="line">          <span class="type">Utils</span>.localHostName(), <span class="number">0</span>, conf, <span class="keyword">new</span> <span class="type">SecurityManager</span>(conf))</span><br><span class="line">        rpcEnv.setupEndpoint(<span class="string">"workerWatcher"</span>, <span class="keyword">new</span> <span class="type">WorkerWatcher</span>(rpcEnv, workerUrl))  </span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> currentLoader = <span class="type">Thread</span>.currentThread.getContextClassLoader</span><br><span class="line">        <span class="keyword">val</span> userJarUrl = <span class="keyword">new</span> <span class="type">File</span>(userJar).toURI().toURL() <span class="comment">//userJarUrl 是我们的Jar包</span></span><br><span class="line">        <span class="keyword">val</span> loader = <span class="comment">//获得线程</span></span><br><span class="line">          <span class="keyword">if</span> (sys.props.getOrElse(<span class="string">"spark.driver.userClassPathFirst"</span>, <span class="string">"false"</span>).toBoolean) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="type">ChildFirstURLClassLoader</span>(<span class="type">Array</span>(userJarUrl), currentLoader)</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="type">MutableURLClassLoader</span>(<span class="type">Array</span>(userJarUrl), currentLoader)</span><br><span class="line">          &#125;</span><br><span class="line">        <span class="type">Thread</span>.currentThread.setContextClassLoader(loader)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Delegate to supplied main class</span></span><br><span class="line">        <span class="comment">//把main线程加载进来</span></span><br><span class="line">        <span class="keyword">val</span> clazz = <span class="type">Utils</span>.classForName(mainClass)</span><br><span class="line">        <span class="comment">//反射jar包中的main方法</span></span><br><span class="line">        <span class="keyword">val</span> mainMethod = clazz.getMethod(<span class="string">"main"</span>, classOf[<span class="type">Array</span>[<span class="type">String</span>]])</span><br><span class="line">        <span class="comment">//执行jar包中的main方法</span></span><br><span class="line">        mainMethod.invoke(<span class="literal">null</span>, extraArgs.toArray[<span class="type">String</span>])</span><br><span class="line"></span><br><span class="line">        rpcEnv.shutdown()  <span class="comment">//最后Drive shutdown  因此我们可以有理由断定 Driver程序就是Jar包</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> _ =&gt;</span><br><span class="line">        <span class="comment">// scalastyle:off println</span></span><br><span class="line">        <span class="type">System</span>.err.println(<span class="string">"Usage: DriverWrapper &lt;workerUrl&gt; &lt;userJar&gt; &lt;driverMainClass&gt; [options]"</span>)</span><br><span class="line">        <span class="comment">// scalastyle:on println</span></span><br><span class="line">        <span class="type">System</span>.exit(<span class="number">-1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们回到driver.start看<code>worker.send(DriverStateChanged(driverId, finalState.get, finalException))</code> 给worker发送</p>
<p>DriverStateChanged</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Starts a thread to run and manage the driver. */</span></span><br><span class="line"><span class="keyword">private</span>[worker] <span class="function"><span class="keyword">def</span> <span class="title">start</span></span>() = &#123;</span><br><span class="line">  <span class="keyword">new</span> <span class="type">Thread</span>(<span class="string">"DriverRunner for "</span> + driverId) &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>() &#123;</span><br><span class="line">      <span class="keyword">var</span> shutdownHook: <span class="type">AnyRef</span> = <span class="literal">null</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        shutdownHook = <span class="type">ShutdownHookManager</span>.addShutdownHook &#123; () =&gt;</span><br><span class="line">          logInfo(<span class="string">s"Worker shutting down, killing driver <span class="subst">$driverId</span>"</span>)</span><br><span class="line">          kill()</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h3 id="回到Driver"><a href="#回到Driver" class="headerlink" title="回到Driver"></a>回到Driver</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> driverStateChanged @ <span class="type">DriverStateChanged</span>(driverId, state, exception) =&gt;</span><br><span class="line">  handleDriverStateChanged(driverStateChanged)</span><br></pre></td></tr></table></figure>

<p>我们进入handleDriverStateChanged</p>
<h3 id="handleDriverStateChanged"><a href="#handleDriverStateChanged" class="headerlink" title="handleDriverStateChanged"></a>handleDriverStateChanged</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>[worker] <span class="function"><span class="keyword">def</span> <span class="title">handleDriverStateChanged</span></span>(driverStateChanged: <span class="type">DriverStateChanged</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">  <span class="keyword">val</span> driverId = driverStateChanged.driverId</span><br><span class="line">  <span class="keyword">val</span> exception = driverStateChanged.exception</span><br><span class="line">  <span class="keyword">val</span> state = driverStateChanged.state</span><br><span class="line">  state <span class="keyword">match</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">DriverState</span>.<span class="type">ERROR</span> =&gt; <span class="comment">//打印一些消息</span></span><br><span class="line">      logWarning(<span class="string">s"Driver <span class="subst">$driverId</span> failed with unrecoverable exception: <span class="subst">$&#123;exception.get&#125;</span>"</span>)</span><br><span class="line">    <span class="keyword">case</span> <span class="type">DriverState</span>.<span class="type">FAILED</span> =&gt;</span><br><span class="line">      logWarning(<span class="string">s"Driver <span class="subst">$driverId</span> exited with failure"</span>)</span><br><span class="line">    <span class="keyword">case</span> <span class="type">DriverState</span>.<span class="type">FINISHED</span> =&gt;</span><br><span class="line">      logInfo(<span class="string">s"Driver <span class="subst">$driverId</span> exited successfully"</span>)</span><br><span class="line">    <span class="keyword">case</span> <span class="type">DriverState</span>.<span class="type">KILLED</span> =&gt;</span><br><span class="line">      logInfo(<span class="string">s"Driver <span class="subst">$driverId</span> was killed by user"</span>)</span><br><span class="line">    <span class="keyword">case</span> _ =&gt;</span><br><span class="line">      logDebug(<span class="string">s"Driver <span class="subst">$driverId</span> changed state to <span class="subst">$state</span>"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  sendToMaster(driverStateChanged) <span class="comment">//发送给Master driverStateChanged</span></span><br><span class="line">  <span class="keyword">val</span> driver = drivers.remove(driverId).get</span><br><span class="line">  finishedDrivers(driverId) = driver</span><br><span class="line">  trimFinishedDriversIfNecessary()</span><br><span class="line">  memoryUsed -= driver.driverDesc.mem</span><br><span class="line">  coresUsed -= driver.driverDesc.cores</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="sendToMaster"><a href="#sendToMaster" class="headerlink" title="sendToMaster"></a>sendToMaster</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">sendToMaster</span></span>(message: <span class="type">Any</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">  master <span class="keyword">match</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Some</span>(masterRef) =&gt; masterRef.send(message)</span><br><span class="line">    <span class="keyword">case</span> <span class="type">None</span> =&gt;</span><br><span class="line">      logWarning(</span><br><span class="line">        <span class="string">s"Dropping <span class="subst">$message</span> because the connection to master has not yet been established"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="回到Master-Driver启动完毕"><a href="#回到Master-Driver启动完毕" class="headerlink" title="回到Master(Driver启动完毕)"></a>回到Master(Driver启动完毕)</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="type">DriverStateChanged</span>(driverId, state, exception) =&gt;</span><br><span class="line">   state <span class="keyword">match</span> &#123;</span><br><span class="line">     <span class="keyword">case</span> <span class="type">DriverState</span>.<span class="type">ERROR</span> | <span class="type">DriverState</span>.<span class="type">FINISHED</span> | <span class="type">DriverState</span>.<span class="type">KILLED</span> | <span class="type">DriverState</span>.<span class="type">FAILED</span> =&gt;</span><br><span class="line">       removeDriver(driverId, state, exception)</span><br><span class="line">     <span class="keyword">case</span> _ =&gt;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">Exception</span>(<span class="string">s"Received unexpected state update for driver <span class="subst">$driverId</span>: <span class="subst">$state</span>"</span>)</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>到这一步Driver已经基本启动</p>
<h2 id="注册Application"><a href="#注册Application" class="headerlink" title="注册Application"></a>注册Application</h2><p>我们需要看SparkContext的代码代码有3000多行我们跳着看吧</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SparkContext</span>(<span class="params">config: <span class="type">SparkConf</span></span>) <span class="keyword">extends</span> <span class="title">Logging</span> </span>&#123;  <span class="comment">//SparkConf 一个配置类</span></span><br><span class="line">   ....</span><br><span class="line">    <span class="comment">//这里是Spark内部的一些变量</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> _conf: <span class="type">SparkConf</span> = _</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> _eventLogDir: <span class="type">Option</span>[<span class="type">URI</span>] = <span class="type">None</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> _eventLogCodec: <span class="type">Option</span>[<span class="type">String</span>] = <span class="type">None</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> _env: <span class="type">SparkEnv</span> = _ </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> _jobProgressListener: <span class="type">JobProgressListener</span> = _</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> _statusTracker: <span class="type">SparkStatusTracker</span> = _</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> _progressBar: <span class="type">Option</span>[<span class="type">ConsoleProgressBar</span>] = <span class="type">None</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> _ui: <span class="type">Option</span>[<span class="type">SparkUI</span>] = <span class="type">None</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> _hadoopConfiguration: <span class="type">Configuration</span> = _</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> _executorMemory: <span class="type">Int</span> = _</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> _schedulerBackend: <span class="type">SchedulerBackend</span> = _</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> _taskScheduler: <span class="type">TaskScheduler</span> = _</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> _heartbeatReceiver: <span class="type">RpcEndpointRef</span> = _</span><br><span class="line">  <span class="meta">@volatile</span> <span class="keyword">private</span> <span class="keyword">var</span> _dagScheduler: <span class="type">DAGScheduler</span> = _ <span class="comment">//DAG任务分解其</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> _applicationId: <span class="type">String</span> = _</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> _applicationAttemptId: <span class="type">Option</span>[<span class="type">String</span>] = <span class="type">None</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> _eventLogger: <span class="type">Option</span>[<span class="type">EventLoggingListener</span>] = <span class="type">None</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> _executorAllocationManager: <span class="type">Option</span>[<span class="type">ExecutorAllocationManager</span>] = <span class="type">None</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> _cleaner: <span class="type">Option</span>[<span class="type">ContextCleaner</span>] = <span class="type">None</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> _listenerBusStarted: <span class="type">Boolean</span> = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> _jars: <span class="type">Seq</span>[<span class="type">String</span>] = _</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> _files: <span class="type">Seq</span>[<span class="type">String</span>] = _</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> _shutdownHookRef: <span class="type">AnyRef</span> = _</span><br></pre></td></tr></table></figure>

<p>我们首先看一下SparkEnv吧</p>
<h3 id="SparkEnv"><a href="#SparkEnv" class="headerlink" title="SparkEnv"></a>SparkEnv</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DeveloperApi</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SparkEnv</span> (<span class="params"></span></span></span><br><span class="line"><span class="class"><span class="params">    val executorId: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    private[spark] val rpcEnv: <span class="type">RpcEnv</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    val serializer: <span class="type">Serializer</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    val closureSerializer: <span class="type">Serializer</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    val serializerManager: <span class="type">SerializerManager</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    val mapOutputTracker: <span class="type">MapOutputTracker</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    val shuffleManager: <span class="type">ShuffleManager</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    val broadcastManager: <span class="type">BroadcastManager</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    val blockManager: <span class="type">BlockManager</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    val securityManager: <span class="type">SecurityManager</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    val metricsSystem: <span class="type">MetricsSystem</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    val memoryManager: <span class="type">MemoryManager</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    val outputCommitCoordinator: <span class="type">OutputCommitCoordinator</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    val conf: <span class="type">SparkConf</span></span>) <span class="keyword">extends</span> <span class="title">Logging</span> </span>&#123;</span><br></pre></td></tr></table></figure>

<p><img src="https://hphimages-1253879422.cos.ap-beijing.myqcloud.com/%E5%A4%A7%E6%95%B0%E6%8D%AE/Spark/%E5%86%85%E6%A0%B8/20190610213205.png" alt=""></p>
<h3 id="主要初始化方法"><a href="#主要初始化方法" class="headerlink" title="主要初始化方法"></a>主要初始化方法</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//主要初始化方法</span></span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line">   _conf = config.clone()</span><br><span class="line">   _conf.validateSettings()</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!_conf.contains(<span class="string">"spark.master"</span>)) &#123;</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">SparkException</span>(<span class="string">"A master URL must be set in your configuration"</span>)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (!_conf.contains(<span class="string">"spark.app.name"</span>)) &#123;</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">SparkException</span>(<span class="string">"An application name must be set in your configuration"</span>)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// System property spark.yarn.app.id must be set if user code ran by AM on a YARN cluster</span></span><br><span class="line">   <span class="keyword">if</span> (master == <span class="string">"yarn"</span> &amp;&amp; deployMode == <span class="string">"cluster"</span> &amp;&amp; !_conf.contains(<span class="string">"spark.yarn.app.id"</span>)) &#123;</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">SparkException</span>(<span class="string">"Detected yarn cluster mode, but isn't running on a cluster. "</span> +</span><br><span class="line">       <span class="string">"Deployment to YARN is not supported directly by SparkContext. Please use spark-submit."</span>)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (_conf.getBoolean(<span class="string">"spark.logConf"</span>, <span class="literal">false</span>)) &#123;</span><br><span class="line">     logInfo(<span class="string">"Spark configuration:\n"</span> + _conf.toDebugString)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Set Spark driver host and port system properties. This explicitly sets the configuration</span></span><br><span class="line">   <span class="comment">// instead of relying on the default value of the config constant.</span></span><br><span class="line">   _conf.set(<span class="type">DRIVER_HOST_ADDRESS</span>, _conf.get(<span class="type">DRIVER_HOST_ADDRESS</span>))</span><br><span class="line">   _conf.setIfMissing(<span class="string">"spark.driver.port"</span>, <span class="string">"0"</span>)</span><br><span class="line"></span><br><span class="line">   _conf.set(<span class="string">"spark.executor.id"</span>, <span class="type">SparkContext</span>.<span class="type">DRIVER_IDENTIFIER</span>)</span><br><span class="line"></span><br><span class="line">   _jars = <span class="type">Utils</span>.getUserJars(_conf)</span><br><span class="line">   _files = _conf.getOption(<span class="string">"spark.files"</span>).map(_.split(<span class="string">","</span>)).map(_.filter(_.nonEmpty))</span><br><span class="line">     .toSeq.flatten</span><br><span class="line"></span><br><span class="line">   _eventLogDir =</span><br><span class="line">     <span class="keyword">if</span> (isEventLogEnabled) &#123;</span><br><span class="line">       <span class="keyword">val</span> unresolvedDir = conf.get(<span class="string">"spark.eventLog.dir"</span>, <span class="type">EventLoggingListener</span>.<span class="type">DEFAULT_LOG_DIR</span>)</span><br><span class="line">         .stripSuffix(<span class="string">"/"</span>)</span><br><span class="line">       <span class="type">Some</span>(<span class="type">Utils</span>.resolveURI(unresolvedDir))</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="type">None</span></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">   _eventLogCodec = &#123;</span><br><span class="line">     <span class="keyword">val</span> compress = _conf.getBoolean(<span class="string">"spark.eventLog.compress"</span>, <span class="literal">false</span>)</span><br><span class="line">     <span class="keyword">if</span> (compress &amp;&amp; isEventLogEnabled) &#123;</span><br><span class="line">       <span class="type">Some</span>(<span class="type">CompressionCodec</span>.getCodecName(_conf)).map(<span class="type">CompressionCodec</span>.getShortName)</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="type">None</span></span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (master == <span class="string">"yarn"</span> &amp;&amp; deployMode == <span class="string">"client"</span>) <span class="type">System</span>.setProperty(<span class="string">"SPARK_YARN_MODE"</span>, <span class="string">"true"</span>)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// "_jobProgressListener" should be set up before creating SparkEnv because when creating</span></span><br><span class="line">   <span class="comment">// "SparkEnv", some messages will be posted to "listenerBus" and we should not miss them.</span></span><br><span class="line">   _jobProgressListener = <span class="keyword">new</span> <span class="type">JobProgressListener</span>(_conf)</span><br><span class="line">   listenerBus.addListener(jobProgressListener)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Create the Spark execution environment (cache, map output tracker, etc)</span></span><br><span class="line">   _env = createSparkEnv(_conf, isLocal, listenerBus)</span><br><span class="line">   <span class="type">SparkEnv</span>.set(_env)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// If running the REPL, register the repl's output dir with the file server.</span></span><br><span class="line">   _conf.getOption(<span class="string">"spark.repl.class.outputDir"</span>).foreach &#123; path =&gt;</span><br><span class="line">     <span class="keyword">val</span> replUri = _env.rpcEnv.fileServer.addDirectory(<span class="string">"/classes"</span>, <span class="keyword">new</span> <span class="type">File</span>(path))</span><br><span class="line">     _conf.set(<span class="string">"spark.repl.class.uri"</span>, replUri)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   _statusTracker = <span class="keyword">new</span> <span class="type">SparkStatusTracker</span>(<span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line">   _progressBar =</span><br><span class="line">     <span class="keyword">if</span> (_conf.getBoolean(<span class="string">"spark.ui.showConsoleProgress"</span>, <span class="literal">true</span>) &amp;&amp; !log.isInfoEnabled) &#123;</span><br><span class="line">       <span class="type">Some</span>(<span class="keyword">new</span> <span class="type">ConsoleProgressBar</span>(<span class="keyword">this</span>))</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="type">None</span></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">   _ui =</span><br><span class="line">     <span class="keyword">if</span> (conf.getBoolean(<span class="string">"spark.ui.enabled"</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">       <span class="type">Some</span>(<span class="type">SparkUI</span>.createLiveUI(<span class="keyword">this</span>, _conf, listenerBus, _jobProgressListener,</span><br><span class="line">         _env.securityManager, appName, startTime = startTime))</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="comment">// For tests, do not enable the UI</span></span><br><span class="line">       <span class="type">None</span></span><br><span class="line">     &#125;</span><br><span class="line">   <span class="comment">// Bind the UI before starting the task scheduler to communicate</span></span><br><span class="line">   <span class="comment">// the bound port to the cluster manager properly</span></span><br><span class="line">   _ui.foreach(_.bind())</span><br><span class="line"></span><br><span class="line">   _hadoopConfiguration = <span class="type">SparkHadoopUtil</span>.get.newConfiguration(_conf)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Add each JAR given through the constructor</span></span><br><span class="line">   <span class="keyword">if</span> (jars != <span class="literal">null</span>) &#123;</span><br><span class="line">     jars.foreach(addJar)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (files != <span class="literal">null</span>) &#123;</span><br><span class="line">     files.foreach(addFile)</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//获取配置</span></span><br><span class="line">   _executorMemory = _conf.getOption(<span class="string">"spark.executor.memory"</span>)</span><br><span class="line">     .orElse(<span class="type">Option</span>(<span class="type">System</span>.getenv(<span class="string">"SPARK_EXECUTOR_MEMORY"</span>)))</span><br><span class="line">     .orElse(<span class="type">Option</span>(<span class="type">System</span>.getenv(<span class="string">"SPARK_MEM"</span>))</span><br><span class="line">     .map(warnSparkMem))</span><br><span class="line">     .map(<span class="type">Utils</span>.memoryStringToMb)</span><br><span class="line">     .getOrElse(<span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Convert java options to env vars as a work around</span></span><br><span class="line">   <span class="comment">// since we can't set env vars directly in sbt.</span></span><br><span class="line">   <span class="keyword">for</span> &#123; (envKey, propKey) &lt;- <span class="type">Seq</span>((<span class="string">"SPARK_TESTING"</span>, <span class="string">"spark.testing"</span>))</span><br><span class="line">     value &lt;- <span class="type">Option</span>(<span class="type">System</span>.getenv(envKey)).orElse(<span class="type">Option</span>(<span class="type">System</span>.getProperty(propKey)))&#125; &#123;</span><br><span class="line">     executorEnvs(envKey) = value</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="type">Option</span>(<span class="type">System</span>.getenv(<span class="string">"SPARK_PREPEND_CLASSES"</span>)).foreach &#123; v =&gt;</span><br><span class="line">     executorEnvs(<span class="string">"SPARK_PREPEND_CLASSES"</span>) = v</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// The Mesos scheduler backend relies on this environment variable to set executor memory.</span></span><br><span class="line">   <span class="comment">// <span class="doctag">TODO:</span> Set this only in the Mesos scheduler.</span></span><br><span class="line">   executorEnvs(<span class="string">"SPARK_EXECUTOR_MEMORY"</span>) = executorMemory + <span class="string">"m"</span></span><br><span class="line">   executorEnvs ++= _conf.getExecutorEnv</span><br><span class="line">   executorEnvs(<span class="string">"SPARK_USER"</span>) = sparkUser</span><br><span class="line"></span><br><span class="line">   <span class="comment">// We need to register "HeartbeatReceiver" before "createTaskScheduler" because Executor will</span></span><br><span class="line">   <span class="comment">// retrieve "HeartbeatReceiver" in the constructor. (SPARK-6640)</span></span><br><span class="line">   _heartbeatReceiver = env.rpcEnv.setupEndpoint( <span class="comment">//心跳</span></span><br><span class="line">     <span class="type">HeartbeatReceiver</span>.<span class="type">ENDPOINT_NAME</span>, <span class="keyword">new</span> <span class="type">HeartbeatReceiver</span>(<span class="keyword">this</span>))</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Create and start the scheduler  </span></span><br><span class="line">   <span class="keyword">val</span> (sched, ts) = <span class="type">SparkContext</span>.createTaskScheduler(<span class="keyword">this</span>, master, deployMode)</span><br><span class="line">   _schedulerBackend = sched   <span class="comment">//创建 _schedulerBackend</span></span><br><span class="line">   _taskScheduler = ts  <span class="comment">//创建 _taskScheduler</span></span><br><span class="line">   _dagScheduler = <span class="keyword">new</span> <span class="type">DAGScheduler</span>(<span class="keyword">this</span>) <span class="comment">//创建 DAGScheduler</span></span><br><span class="line">   _heartbeatReceiver.ask[<span class="type">Boolean</span>](<span class="type">TaskSchedulerIsSet</span>)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// start TaskScheduler after taskScheduler sets DAGScheduler reference in DAGScheduler's</span></span><br><span class="line">   <span class="comment">// constructor</span></span><br><span class="line">   _taskScheduler.start()</span><br><span class="line"></span><br><span class="line">   _applicationId = _taskScheduler.applicationId()</span><br><span class="line">   _applicationAttemptId = taskScheduler.applicationAttemptId()</span><br><span class="line">   _conf.set(<span class="string">"spark.app.id"</span>, _applicationId)</span><br><span class="line">   <span class="keyword">if</span> (_conf.getBoolean(<span class="string">"spark.ui.reverseProxy"</span>, <span class="literal">false</span>)) &#123;</span><br><span class="line">     <span class="type">System</span>.setProperty(<span class="string">"spark.ui.proxyBase"</span>, <span class="string">"/proxy/"</span> + _applicationId)</span><br><span class="line">   &#125;</span><br><span class="line">   _ui.foreach(_.setAppId(_applicationId))</span><br><span class="line">   _env.blockManager.initialize(_applicationId)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// The metrics system for Driver need to be set spark.app.id to app ID.</span></span><br><span class="line">   <span class="comment">// So it should start after we get app ID from the task scheduler and set spark.app.id.</span></span><br><span class="line">   _env.metricsSystem.start()</span><br><span class="line">   <span class="comment">// Attach the driver metrics servlet handler to the web ui after the metrics system is started.</span></span><br><span class="line">   _env.metricsSystem.getServletHandlers.foreach(handler =&gt; ui.foreach(_.attachHandler(handler)))</span><br><span class="line"></span><br><span class="line">   _eventLogger =</span><br><span class="line">     <span class="keyword">if</span> (isEventLogEnabled) &#123;</span><br><span class="line">       <span class="keyword">val</span> logger =</span><br><span class="line">         <span class="keyword">new</span> <span class="type">EventLoggingListener</span>(_applicationId, _applicationAttemptId, _eventLogDir.get,</span><br><span class="line">           _conf, _hadoopConfiguration)</span><br><span class="line">       logger.start()</span><br><span class="line">       listenerBus.addListener(logger)</span><br><span class="line">       <span class="type">Some</span>(logger)</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="type">None</span></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Optionally scale number of executors dynamically based on workload. Exposed for testing.</span></span><br><span class="line">   <span class="keyword">val</span> dynamicAllocationEnabled = <span class="type">Utils</span>.isDynamicAllocationEnabled(_conf)</span><br><span class="line">   _executorAllocationManager =</span><br><span class="line">     <span class="keyword">if</span> (dynamicAllocationEnabled) &#123;</span><br><span class="line">       schedulerBackend <span class="keyword">match</span> &#123;</span><br><span class="line">         <span class="keyword">case</span> b: <span class="type">ExecutorAllocationClient</span> =&gt;</span><br><span class="line">           <span class="type">Some</span>(<span class="keyword">new</span> <span class="type">ExecutorAllocationManager</span>(</span><br><span class="line">             schedulerBackend.asInstanceOf[<span class="type">ExecutorAllocationClient</span>], listenerBus, _conf))</span><br><span class="line">         <span class="keyword">case</span> _ =&gt;</span><br><span class="line">           <span class="type">None</span></span><br><span class="line">       &#125;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="type">None</span></span><br><span class="line">     &#125;</span><br><span class="line">   _executorAllocationManager.foreach(_.start())</span><br><span class="line"></span><br><span class="line">   _cleaner =</span><br><span class="line">     <span class="keyword">if</span> (_conf.getBoolean(<span class="string">"spark.cleaner.referenceTracking"</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">       <span class="type">Some</span>(<span class="keyword">new</span> <span class="type">ContextCleaner</span>(<span class="keyword">this</span>))</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="type">None</span></span><br><span class="line">     &#125;</span><br><span class="line">   _cleaner.foreach(_.start())</span><br><span class="line"></span><br><span class="line">   setupAndStartListenerBus()</span><br><span class="line">   postEnvironmentUpdate()</span><br><span class="line">   postApplicationStart()</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Post init</span></span><br><span class="line">   _taskScheduler.postStartHook()</span><br><span class="line">   _env.metricsSystem.registerSource(_dagScheduler.metricsSource)</span><br><span class="line">   _env.metricsSystem.registerSource(<span class="keyword">new</span> <span class="type">BlockManagerSource</span>(_env.blockManager))</span><br><span class="line">   _executorAllocationManager.foreach &#123; e =&gt;</span><br><span class="line">     _env.metricsSystem.registerSource(e.executorAllocationManagerSource)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Make sure the context is stopped if the user forgets about it. This avoids leaving</span></span><br><span class="line">   <span class="comment">// unfinished event logs around after the JVM exits cleanly. It doesn't help if the JVM</span></span><br><span class="line">   <span class="comment">// is killed, though.</span></span><br><span class="line">   logDebug(<span class="string">"Adding shutdown hook"</span>) <span class="comment">// force eager creation of logger</span></span><br><span class="line">   _shutdownHookRef = <span class="type">ShutdownHookManager</span>.addShutdownHook(</span><br><span class="line">     <span class="type">ShutdownHookManager</span>.<span class="type">SPARK_CONTEXT_SHUTDOWN_PRIORITY</span>) &#123; () =&gt;</span><br><span class="line">     logInfo(<span class="string">"Invoking stop() from shutdown hook"</span>)</span><br><span class="line">     stop()</span><br><span class="line">   &#125;</span><br><span class="line"> &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">   <span class="keyword">case</span> <span class="type">NonFatal</span>(e) =&gt;</span><br><span class="line">     logError(<span class="string">"Error initializing SparkContext."</span>, e)</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">       stop()</span><br><span class="line">     &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">       <span class="keyword">case</span> <span class="type">NonFatal</span>(inner) =&gt;</span><br><span class="line">         logError(<span class="string">"Error stopping SparkContext after init error."</span>, inner)</span><br><span class="line">     &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">       <span class="keyword">throw</span> e</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="createTaskScheduler"><a href="#createTaskScheduler" class="headerlink" title="createTaskScheduler"></a>createTaskScheduler</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">createTaskScheduler</span></span>(</span><br><span class="line">    sc: <span class="type">SparkContext</span>,</span><br><span class="line">    master: <span class="type">String</span>,</span><br><span class="line">    deployMode: <span class="type">String</span>): (<span class="type">SchedulerBackend</span>, <span class="type">TaskScheduler</span>) = &#123;</span><br><span class="line">  <span class="keyword">import</span> <span class="type">SparkMasterRegex</span>._</span><br><span class="line"></span><br><span class="line">  <span class="comment">// When running locally, don't try to re-execute tasks on failure.</span></span><br><span class="line">  <span class="keyword">val</span> <span class="type">MAX_LOCAL_TASK_FAILURES</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  master <span class="keyword">match</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"local"</span> =&gt;  <span class="comment">//如果是local模式</span></span><br><span class="line">      <span class="keyword">val</span> scheduler = <span class="keyword">new</span> <span class="type">TaskSchedulerImpl</span>(sc, <span class="type">MAX_LOCAL_TASK_FAILURES</span>, isLocal = <span class="literal">true</span>)</span><br><span class="line">      <span class="keyword">val</span> backend = <span class="keyword">new</span> <span class="type">LocalSchedulerBackend</span>(sc.getConf, scheduler, <span class="number">1</span>)</span><br><span class="line">      scheduler.initialize(backend)</span><br><span class="line">      (backend, scheduler)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="type">LOCAL_N_REGEX</span>(threads) =&gt; <span class="comment">//或者是多线程的local模式</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">localCpuCount</span></span>: <span class="type">Int</span> = <span class="type">Runtime</span>.getRuntime.availableProcessors()</span><br><span class="line">      <span class="comment">// local[*] estimates the number of cores on the machine; local[N] uses exactly N threads.</span></span><br><span class="line">      <span class="keyword">val</span> threadCount = <span class="keyword">if</span> (threads == <span class="string">"*"</span>) localCpuCount <span class="keyword">else</span> threads.toInt</span><br><span class="line">      <span class="keyword">if</span> (threadCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">SparkException</span>(<span class="string">s"Asked to run locally with <span class="subst">$threadCount</span> threads"</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">val</span> scheduler = <span class="keyword">new</span> <span class="type">TaskSchedulerImpl</span>(sc, <span class="type">MAX_LOCAL_TASK_FAILURES</span>, isLocal = <span class="literal">true</span>)</span><br><span class="line">      <span class="keyword">val</span> backend = <span class="keyword">new</span> <span class="type">LocalSchedulerBackend</span>(sc.getConf, scheduler, threadCount)</span><br><span class="line">      scheduler.initialize(backend)</span><br><span class="line">      (backend, scheduler)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="type">LOCAL_N_FAILURES_REGEX</span>(threads, maxFailures) =&gt;</span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">localCpuCount</span></span>: <span class="type">Int</span> = <span class="type">Runtime</span>.getRuntime.availableProcessors()</span><br><span class="line">      <span class="comment">// local[*, M] means the number of cores on the computer with M failures</span></span><br><span class="line">      <span class="comment">// local[N, M] means exactly N threads with M failures</span></span><br><span class="line">      <span class="keyword">val</span> threadCount = <span class="keyword">if</span> (threads == <span class="string">"*"</span>) localCpuCount <span class="keyword">else</span> threads.toInt</span><br><span class="line">      <span class="keyword">val</span> scheduler = <span class="keyword">new</span> <span class="type">TaskSchedulerImpl</span>(sc, maxFailures.toInt, isLocal = <span class="literal">true</span>)</span><br><span class="line">      <span class="keyword">val</span> backend = <span class="keyword">new</span> <span class="type">LocalSchedulerBackend</span>(sc.getConf, scheduler, threadCount)</span><br><span class="line">      scheduler.initialize(backend)</span><br><span class="line">      (backend, scheduler)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="type">SPARK_REGEX</span>(sparkUrl) =&gt; <span class="comment">//StandaloneSchedulerBackend 模式</span></span><br><span class="line">      <span class="keyword">val</span> scheduler = <span class="keyword">new</span> <span class="type">TaskSchedulerImpl</span>(sc)</span><br><span class="line">      <span class="keyword">val</span> masterUrls = sparkUrl.split(<span class="string">","</span>).map(<span class="string">"spark://"</span> + _)</span><br><span class="line">      <span class="keyword">val</span> backend = <span class="keyword">new</span> <span class="type">StandaloneSchedulerBackend</span>(scheduler, sc, masterUrls)</span><br><span class="line">      scheduler.initialize(backend)</span><br><span class="line">      (backend, scheduler)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="type">LOCAL_CLUSTER_REGEX</span>(numSlaves, coresPerSlave, memoryPerSlave) =&gt;</span><br><span class="line">      <span class="comment">// Check to make sure memory requested &lt;= memoryPerSlave. Otherwise Spark will just hang.</span></span><br><span class="line">      <span class="keyword">val</span> memoryPerSlaveInt = memoryPerSlave.toInt</span><br><span class="line">      <span class="keyword">if</span> (sc.executorMemory &gt; memoryPerSlaveInt) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">SparkException</span>(</span><br><span class="line">          <span class="string">"Asked to launch cluster with %d MB RAM / worker but requested %d MB/worker"</span>.format(</span><br><span class="line">            memoryPerSlaveInt, sc.executorMemory))</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">val</span> scheduler = <span class="keyword">new</span> <span class="type">TaskSchedulerImpl</span>(sc)</span><br><span class="line">      <span class="keyword">val</span> localCluster = <span class="keyword">new</span> <span class="type">LocalSparkCluster</span>(</span><br><span class="line">        numSlaves.toInt, coresPerSlave.toInt, memoryPerSlaveInt, sc.conf)</span><br><span class="line">      <span class="keyword">val</span> masterUrls = localCluster.start()</span><br><span class="line">      <span class="keyword">val</span> backend = <span class="keyword">new</span> <span class="type">StandaloneSchedulerBackend</span>(scheduler, sc, masterUrls)</span><br><span class="line">      scheduler.initialize(backend)</span><br><span class="line">      backend.shutdownCallback = (backend: <span class="type">StandaloneSchedulerBackend</span>) =&gt; &#123;</span><br><span class="line">        localCluster.stop()</span><br><span class="line">      &#125;</span><br><span class="line">      (backend, scheduler)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">case</span> masterUrl =&gt; <span class="comment">//根据你的提交模式 会创建不同的 scheduler backend </span></span><br><span class="line">      <span class="keyword">val</span> cm = getClusterManager(masterUrl) <span class="keyword">match</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">Some</span>(clusterMgr) =&gt; clusterMgr</span><br><span class="line">        <span class="keyword">case</span> <span class="type">None</span> =&gt; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">SparkException</span>(<span class="string">"Could not parse Master URL: '"</span> + master + <span class="string">"'"</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> scheduler = cm.createTaskScheduler(sc, masterUrl)</span><br><span class="line">        <span class="keyword">val</span> backend = cm.createSchedulerBackend(sc, masterUrl, scheduler) </span><br><span class="line">        cm.initialize(scheduler, backend)</span><br><span class="line">        (backend, scheduler)</span><br><span class="line">      &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> se: <span class="type">SparkException</span> =&gt; <span class="keyword">throw</span> se</span><br><span class="line">        <span class="keyword">case</span> <span class="type">NonFatal</span>(e) =&gt;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">SparkException</span>(<span class="string">"External scheduler cannot be instantiated"</span>, e)</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Create and start the scheduler</span></span><br><span class="line">  <span class="keyword">val</span> (sched, ts) = <span class="type">SparkContext</span>.createTaskScheduler(<span class="keyword">this</span>, master, deployMode)</span><br><span class="line">  _schedulerBackend = sched</span><br><span class="line">  _taskScheduler = ts</span><br><span class="line">  _dagScheduler = <span class="keyword">new</span> <span class="type">DAGScheduler</span>(<span class="keyword">this</span>)</span><br><span class="line">  _heartbeatReceiver.ask[<span class="type">Boolean</span>](<span class="type">TaskSchedulerIsSet</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// start TaskScheduler after taskScheduler sets DAGScheduler reference in DAGScheduler's</span></span><br><span class="line">  <span class="comment">// constructor</span></span><br><span class="line">  _taskScheduler.start()  <span class="comment">//启动任务</span></span><br><span class="line"></span><br><span class="line">  _applicationId = _taskScheduler.applicationId()</span><br><span class="line">  _applicationAttemptId = taskScheduler.applicationAttemptId()</span><br><span class="line">  _conf.set(<span class="string">"spark.app.id"</span>, _applicationId)</span><br><span class="line"> <span class="keyword">if</span> (_conf.getBoolean(<span class="string">"spark.ui.reverseProxy"</span>, <span class="literal">false</span>)) &#123;</span><br><span class="line">    <span class="type">System</span>.setProperty(<span class="string">"spark.ui.proxyBase"</span>, <span class="string">"/proxy/"</span> + _applicationId)</span><br><span class="line">  &#125;</span><br><span class="line">  _ui.foreach(_.setAppId(_applicationId))</span><br><span class="line">  _env.blockManager.initialize(_applicationId)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The metrics system for Driver need to be set spark.app.id to app ID.</span></span><br><span class="line">  <span class="comment">// So it should start after we get app ID from the task scheduler and set spark.app.id.</span></span><br><span class="line">  _env.metricsSystem.start()</span><br><span class="line">  <span class="comment">// Attach the driver metrics servlet handler to the web ui after the metrics system is started.</span></span><br><span class="line">  _env.metricsSystem.getServletHandlers.foreach(handler =&gt; ui.foreach(_.attachHandler(handler)))</span><br><span class="line"></span><br><span class="line">  _eventLogger =</span><br><span class="line">    <span class="keyword">if</span> (isEventLogEnabled) &#123;</span><br><span class="line">      <span class="keyword">val</span> logger =</span><br><span class="line">        <span class="keyword">new</span> <span class="type">EventLoggingListener</span>(_applicationId, _applicationAttemptId, _eventLogDir.get,</span><br><span class="line">          _conf, _hadoopConfiguration)</span><br><span class="line">      logger.start()</span><br><span class="line">      listenerBus.addListener(logger)</span><br><span class="line">      <span class="type">Some</span>(logger)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="type">None</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Optionally scale number of executors dynamically based on workload. Exposed for testing.</span></span><br><span class="line">  <span class="keyword">val</span> dynamicAllocationEnabled = <span class="type">Utils</span>.isDynamicAllocationEnabled(_conf)</span><br><span class="line">  _executorAllocationManager =</span><br><span class="line">    <span class="keyword">if</span> (dynamicAllocationEnabled) &#123;</span><br><span class="line">      schedulerBackend <span class="keyword">match</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> b: <span class="type">ExecutorAllocationClient</span> =&gt;</span><br><span class="line">          <span class="type">Some</span>(<span class="keyword">new</span> <span class="type">ExecutorAllocationManager</span>(</span><br><span class="line">            schedulerBackend.asInstanceOf[<span class="type">ExecutorAllocationClient</span>], listenerBus, _conf))</span><br><span class="line">        <span class="keyword">case</span> _ =&gt;</span><br><span class="line">          <span class="type">None</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="type">None</span></span><br><span class="line">    &#125;</span><br><span class="line">  _executorAllocationManager.foreach(_.start())</span><br><span class="line"></span><br><span class="line">  _cleaner =</span><br><span class="line">    <span class="keyword">if</span> (_conf.getBoolean(<span class="string">"spark.cleaner.referenceTracking"</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">      <span class="type">Some</span>(<span class="keyword">new</span> <span class="type">ContextCleaner</span>(<span class="keyword">this</span>))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="type">None</span></span><br><span class="line">    &#125;</span><br><span class="line">  _cleaner.foreach(_.start())</span><br><span class="line"></span><br><span class="line">  setupAndStartListenerBus()</span><br><span class="line">  postEnvironmentUpdate()  </span><br><span class="line">  postApplicationStart()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Post init</span></span><br><span class="line">  _taskScheduler.postStartHook()</span><br><span class="line">  _env.metricsSystem.registerSource(_dagScheduler.metricsSource)</span><br><span class="line">  _env.metricsSystem.registerSource(<span class="keyword">new</span> <span class="type">BlockManagerSource</span>(_env.blockManager))</span><br><span class="line">  _executorAllocationManager.foreach &#123; e =&gt;</span><br><span class="line">    _env.metricsSystem.registerSource(e.executorAllocationManagerSource)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Make sure the context is stopped if the user forgets about it. This avoids leaving</span></span><br><span class="line">  <span class="comment">// unfinished event logs around after the JVM exits cleanly. It doesn't help if the JVM</span></span><br><span class="line">  <span class="comment">// is killed, though.</span></span><br><span class="line">  logDebug(<span class="string">"Adding shutdown hook"</span>) <span class="comment">// force eager creation of logger</span></span><br><span class="line">  _shutdownHookRef = <span class="type">ShutdownHookManager</span>.addShutdownHook( <span class="comment">//注册一个ShutdownHook (钩子函数)</span></span><br><span class="line">    <span class="type">ShutdownHookManager</span>.<span class="type">SPARK_CONTEXT_SHUTDOWN_PRIORITY</span>) &#123; () =&gt;</span><br><span class="line">    logInfo(<span class="string">"Invoking stop() from shutdown hook"</span>)</span><br><span class="line">    stop()</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="type">NonFatal</span>(e) =&gt;</span><br><span class="line">    logError(<span class="string">"Error initializing SparkContext."</span>, e)</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      stop()</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="type">NonFatal</span>(inner) =&gt;</span><br><span class="line">        logError(<span class="string">"Error stopping SparkContext after init error."</span>, inner)</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> e</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Excutor分配"><a href="#Excutor分配" class="headerlink" title="Excutor分配"></a>Excutor分配</h2><h3 id="StandaloneSchedulerBackend"><a href="#StandaloneSchedulerBackend" class="headerlink" title="StandaloneSchedulerBackend"></a>StandaloneSchedulerBackend</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A [[SchedulerBackend]] implementation for Spark's standalone cluster manager.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span>[spark] <span class="class"><span class="keyword">class</span> <span class="title">StandaloneSchedulerBackend</span>(<span class="params"></span></span></span><br><span class="line"><span class="class"><span class="params">    scheduler: <span class="type">TaskSchedulerImpl</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    sc: <span class="type">SparkContext</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    masters: <span class="type">Array</span>[<span class="type">String</span>]</span>)</span></span><br><span class="line"><span class="class">  <span class="keyword">extends</span> <span class="title">CoarseGrainedSchedulerBackend</span>(<span class="params">scheduler, sc.env.rpcEnv</span>)<span class="title">//继承了一个粗粒度schedulerBackend</span>  <span class="title">在应用运行之间就把资源计算好</span>,<span class="title">在应用运行期间资源是不动的固定的</span>. <span class="title">Messon有粗细粒度之分再YARN</span> <span class="title">集群和Stanlone中</span> <span class="title">都为粗粒度的</span></span></span><br><span class="line"><span class="class">  <span class="keyword">with</span> <span class="title">StandaloneAppClientListener</span></span></span><br><span class="line"><span class="class">  <span class="keyword">with</span> <span class="title">Logging</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> client: <span class="type">StandaloneAppClient</span> = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> stopping = <span class="keyword">new</span> <span class="type">AtomicBoolean</span>(<span class="literal">false</span>)</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> launcherBackend = <span class="keyword">new</span> <span class="type">LauncherBackend</span>() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">protected</span> <span class="function"><span class="keyword">def</span> <span class="title">onStopRequest</span></span>(): <span class="type">Unit</span> = stop(<span class="type">SparkAppHandle</span>.<span class="type">State</span>.<span class="type">KILLED</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@volatile</span> <span class="keyword">var</span> shutdownCallback: <span class="type">StandaloneSchedulerBackend</span> =&gt; <span class="type">Unit</span> = _</span><br><span class="line">  <span class="meta">@volatile</span> <span class="keyword">private</span> <span class="keyword">var</span> appId: <span class="type">String</span> = _</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> registrationBarrier = <span class="keyword">new</span> <span class="type">Semaphore</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> maxCores = conf.getOption(<span class="string">"spark.cores.max"</span>).map(_.toInt)</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> totalExpectedCores = maxCores.getOrElse(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">start</span></span>() &#123; <span class="comment">//我们关注一下start的方法</span></span><br><span class="line">    <span class="keyword">super</span>.start()</span><br><span class="line">    launcherBackend.connect()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The endpoint for executors to talk to us</span></span><br><span class="line">    <span class="keyword">val</span> driverUrl = <span class="type">RpcEndpointAddress</span>(</span><br><span class="line">      sc.conf.get(<span class="string">"spark.driver.host"</span>),</span><br><span class="line">      sc.conf.get(<span class="string">"spark.driver.port"</span>).toInt,</span><br><span class="line">      <span class="type">CoarseGrainedSchedulerBackend</span>.<span class="type">ENDPOINT_NAME</span>).toString</span><br><span class="line">    <span class="keyword">val</span> args = <span class="type">Seq</span>(</span><br><span class="line">      <span class="string">"--driver-url"</span>, driverUrl,</span><br><span class="line">      <span class="string">"--executor-id"</span>, <span class="string">"&#123;&#123;EXECUTOR_ID&#125;&#125;"</span>,</span><br><span class="line">      <span class="string">"--hostname"</span>, <span class="string">"&#123;&#123;HOSTNAME&#125;&#125;"</span>,</span><br><span class="line">      <span class="string">"--cores"</span>, <span class="string">"&#123;&#123;CORES&#125;&#125;"</span>,</span><br><span class="line">      <span class="string">"--app-id"</span>, <span class="string">"&#123;&#123;APP_ID&#125;&#125;"</span>,</span><br><span class="line">      <span class="string">"--worker-url"</span>, <span class="string">"&#123;&#123;WORKER_URL&#125;&#125;"</span>)</span><br><span class="line">    <span class="keyword">val</span> extraJavaOpts = sc.conf.getOption(<span class="string">"spark.executor.extraJavaOptions"</span>)</span><br><span class="line">      .map(<span class="type">Utils</span>.splitCommandString).getOrElse(<span class="type">Seq</span>.empty)</span><br><span class="line">    <span class="keyword">val</span> classPathEntries = sc.conf.getOption(<span class="string">"spark.executor.extraClassPath"</span>)</span><br><span class="line">      .map(_.split(java.io.<span class="type">File</span>.pathSeparator).toSeq).getOrElse(<span class="type">Nil</span>)</span><br><span class="line">    <span class="keyword">val</span> libraryPathEntries = sc.conf.getOption(<span class="string">"spark.executor.extraLibraryPath"</span>)</span><br><span class="line">      .map(_.split(java.io.<span class="type">File</span>.pathSeparator).toSeq).getOrElse(<span class="type">Nil</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// When testing, expose the parent class path to the child. This is processed by</span></span><br><span class="line">    <span class="comment">// compute-classpath.&#123;cmd,sh&#125; and makes all needed jars available to child processes</span></span><br><span class="line">    <span class="comment">// when the assembly is built with the "*-provided" profiles enabled.</span></span><br><span class="line">    <span class="keyword">val</span> testingClassPath =</span><br><span class="line">      <span class="keyword">if</span> (sys.props.contains(<span class="string">"spark.testing"</span>)) &#123;</span><br><span class="line">        sys.props(<span class="string">"java.class.path"</span>).split(java.io.<span class="type">File</span>.pathSeparator).toSeq</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">Nil</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start executors with a few necessary configs for registering with the scheduler</span></span><br><span class="line">    <span class="keyword">val</span> sparkJavaOpts = <span class="type">Utils</span>.sparkJavaOpts(conf, <span class="type">SparkConf</span>.isExecutorStartupConf)</span><br><span class="line">    <span class="keyword">val</span> javaOpts = sparkJavaOpts ++ extraJavaOpts</span><br><span class="line">    <span class="keyword">val</span> command = <span class="type">Command</span>(<span class="string">"org.apache.spark.executor.CoarseGrainedExecutorBackend"</span>,</span><br><span class="line">      args, sc.executorEnvs, classPathEntries ++ testingClassPath, libraryPathEntries, javaOpts)</span><br><span class="line">    <span class="keyword">val</span> appUIAddress = sc.ui.map(_.appUIAddress).getOrElse(<span class="string">""</span>)</span><br><span class="line">    <span class="keyword">val</span> coresPerExecutor = conf.getOption(<span class="string">"spark.executor.cores"</span>).map(_.toInt)</span><br><span class="line">    <span class="comment">// If we're using dynamic allocation, set our initial executor limit to 0 for now.</span></span><br><span class="line">    <span class="comment">// ExecutorAllocationManager will send the real initial limit to the Master later.</span></span><br><span class="line">    <span class="keyword">val</span> initialExecutorLimit =</span><br><span class="line">      <span class="keyword">if</span> (<span class="type">Utils</span>.isDynamicAllocationEnabled(conf)) &#123;</span><br><span class="line">        <span class="type">Some</span>(<span class="number">0</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">None</span></span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">val</span> appDesc = <span class="keyword">new</span> <span class="type">ApplicationDescription</span>(sc.appName, maxCores, sc.executorMemory, command,</span><br><span class="line">      appUIAddress, sc.eventLogDir, sc.eventLogCodec, coresPerExecutor, initialExecutorLimit)</span><br><span class="line">    client = <span class="keyword">new</span> <span class="type">StandaloneAppClient</span>(sc.env.rpcEnv, masters, appDesc, <span class="keyword">this</span>, conf)</span><br><span class="line">    client.start()</span><br><span class="line">    launcherBackend.setState(<span class="type">SparkAppHandle</span>.<span class="type">State</span>.<span class="type">SUBMITTED</span>)</span><br><span class="line">    waitForRegistration()</span><br><span class="line">    launcherBackend.setState(<span class="type">SparkAppHandle</span>.<span class="type">State</span>.<span class="type">RUNNING</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">stop</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">    stop(<span class="type">SparkAppHandle</span>.<span class="type">State</span>.<span class="type">FINISHED</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">connected</span></span>(appId: <span class="type">String</span>) &#123;</span><br><span class="line">    logInfo(<span class="string">"Connected to Spark cluster with app ID "</span> + appId)</span><br><span class="line">    <span class="keyword">this</span>.appId = appId</span><br><span class="line">    notifyContext()</span><br><span class="line">    launcherBackend.setAppId(appId)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">disconnected</span></span>() &#123;</span><br><span class="line">    notifyContext()</span><br><span class="line">    <span class="keyword">if</span> (!stopping.get) &#123;</span><br><span class="line">      logWarning(<span class="string">"Disconnected from Spark cluster! Waiting for reconnection..."</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">dead</span></span>(reason: <span class="type">String</span>) &#123;</span><br><span class="line">    notifyContext()</span><br><span class="line">    <span class="keyword">if</span> (!stopping.get) &#123;</span><br><span class="line">      launcherBackend.setState(<span class="type">SparkAppHandle</span>.<span class="type">State</span>.<span class="type">KILLED</span>)</span><br><span class="line">      logError(<span class="string">"Application has been killed. Reason: "</span> + reason)</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        scheduler.error(reason)</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// Ensure the application terminates, as we can no longer run jobs.</span></span><br><span class="line">        sc.stopInNewThread()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="CoarseGrainedSchedulerBackend"><a href="#CoarseGrainedSchedulerBackend" class="headerlink" title="CoarseGrainedSchedulerBackend"></a>CoarseGrainedSchedulerBackend</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">start</span></span>() &#123;</span><br><span class="line">  <span class="keyword">val</span> properties = <span class="keyword">new</span> <span class="type">ArrayBuffer</span>[(<span class="type">String</span>, <span class="type">String</span>)]</span><br><span class="line">  <span class="keyword">for</span> ((key, value) &lt;- scheduler.sc.conf.getAll) &#123;</span><br><span class="line">    <span class="keyword">if</span> (key.startsWith(<span class="string">"spark."</span>)) &#123;</span><br><span class="line">      properties += ((key, value))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// TODO (prashant) send conf instead of properties</span></span><br><span class="line">  driverEndpoint = createDriverEndpointRef(properties)  <span class="comment">//创建了一个driverEndpoint</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="回到StandaloneSchedulerBackend"><a href="#回到StandaloneSchedulerBackend" class="headerlink" title="回到StandaloneSchedulerBackend"></a>回到StandaloneSchedulerBackend</h3><p>我们看一下再start方法中的</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建了一个ApplicationDescription</span></span><br><span class="line"><span class="keyword">val</span> appDesc = <span class="keyword">new</span> <span class="type">ApplicationDescription</span>(sc.appName, maxCores, sc.executorMemory, command,</span><br><span class="line">     appUIAddress, sc.eventLogDir, sc.eventLogCodec, coresPerExecutor, initialExecutorLimit)</span><br><span class="line"><span class="comment">//创建了一个StandaloneAppClient</span></span><br><span class="line">   client = <span class="keyword">new</span> <span class="type">StandaloneAppClient</span>(sc.env.rpcEnv, masters, appDesc, <span class="keyword">this</span>, conf)  <span class="comment">//控制权限转到StandaloneAppClient</span></span><br><span class="line">   client.start() </span><br><span class="line">   launcherBackend.setState(<span class="type">SparkAppHandle</span>.<span class="type">State</span>.<span class="type">SUBMITTED</span>)</span><br><span class="line">   waitForRegistration()</span><br><span class="line">   launcherBackend.setState(<span class="type">SparkAppHandle</span>.<span class="type">State</span>.<span class="type">RUNNING</span>)</span><br></pre></td></tr></table></figure>

<h3 id="跳转StandaloneAppClient"><a href="#跳转StandaloneAppClient" class="headerlink" title="跳转StandaloneAppClient"></a>跳转StandaloneAppClient</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>[spark] <span class="class"><span class="keyword">class</span> <span class="title">StandaloneAppClient</span>(<span class="params"></span></span></span><br><span class="line"><span class="class"><span class="params">    rpcEnv: <span class="type">RpcEnv</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    masterUrls: <span class="type">Array</span>[<span class="type">String</span>],</span></span></span><br><span class="line"><span class="class"><span class="params">    appDescription: <span class="type">ApplicationDescription</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    listener: <span class="type">StandaloneAppClientListener</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    conf: <span class="type">SparkConf</span></span>)</span></span><br><span class="line"><span class="class">  <span class="keyword">extends</span> <span class="title">Logging</span> </span>&#123; <span class="comment">//Client </span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> masterRpcAddresses = masterUrls.map(<span class="type">RpcAddress</span>.fromSparkURL(_))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> <span class="type">REGISTRATION_TIMEOUT_SECONDS</span> = <span class="number">20</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> <span class="type">REGISTRATION_RETRIES</span> = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> endpoint = <span class="keyword">new</span> <span class="type">AtomicReference</span>[<span class="type">RpcEndpointRef</span>]</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> appId = <span class="keyword">new</span> <span class="type">AtomicReference</span>[<span class="type">String</span>]</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> registered = <span class="keyword">new</span> <span class="type">AtomicBoolean</span>(<span class="literal">false</span>)</span><br><span class="line">	<span class="comment">//也是个端点,</span></span><br><span class="line">  <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientEndpoint</span>(<span class="params">override val rpcEnv: <span class="type">RpcEnv</span></span>) <span class="keyword">extends</span> <span class="title">ThreadSafeRpcEndpoint</span></span></span><br><span class="line"><span class="class">    <span class="keyword">with</span> <span class="title">Logging</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> master: <span class="type">Option</span>[<span class="type">RpcEndpointRef</span>] = <span class="type">None</span></span><br><span class="line">    <span class="comment">// To avoid calling listener.disconnected() multiple times</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> alreadyDisconnected = <span class="literal">false</span></span><br><span class="line">    <span class="comment">// To avoid calling listener.dead() multiple times</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> alreadyDead = <span class="keyword">new</span> <span class="type">AtomicBoolean</span>(<span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> registerMasterFutures = <span class="keyword">new</span> <span class="type">AtomicReference</span>[<span class="type">Array</span>[<span class="type">JFuture</span>[_]]]</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> registrationRetryTimer = <span class="keyword">new</span> <span class="type">AtomicReference</span>[<span class="type">JScheduledFuture</span>[_]]</span><br><span class="line">		....</span><br><span class="line">  	<span class="function"><span class="keyword">def</span> <span class="title">start</span></span>() &#123;</span><br><span class="line">    <span class="comment">// Just launch an rpcEndpoint; it will call back into the listener.</span></span><br><span class="line">	<span class="comment">//创建了一个ClientEndpoint</span></span><br><span class="line">    endpoint.set(rpcEnv.setupEndpoint(<span class="string">"AppClient"</span>, <span class="keyword">new</span> <span class="type">ClientEndpoint</span>(rpcEnv))) </span><br><span class="line">  &#125;</span><br><span class="line">   ....</span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">receive</span></span>: <span class="type">PartialFunction</span>[<span class="type">Any</span>, <span class="type">Unit</span>] = &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="type">RegisteredApplication</span>(appId_, masterRef) =&gt;</span><br><span class="line">        <span class="comment">// FIXME How to handle the following cases?</span></span><br><span class="line">        <span class="comment">// 1. A master receives multiple registrations and sends back multiple</span></span><br><span class="line">        <span class="comment">// RegisteredApplications due to an unstable network.</span></span><br><span class="line">        <span class="comment">// 2. Receive multiple RegisteredApplication from different masters because the master is</span></span><br><span class="line">        <span class="comment">// changing.</span></span><br><span class="line">        appId.set(appId_)</span><br><span class="line">        registered.set(<span class="literal">true</span>)</span><br><span class="line">        master = <span class="type">Some</span>(masterRef)</span><br><span class="line">        listener.connected(appId.get)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="type">ApplicationRemoved</span>(message) =&gt;</span><br><span class="line">        markDead(<span class="string">"Master removed our application: %s"</span>.format(message))</span><br><span class="line">        stop()</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="type">ExecutorAdded</span>(id: <span class="type">Int</span>, workerId: <span class="type">String</span>, hostPort: <span class="type">String</span>, cores: <span class="type">Int</span>, memory: <span class="type">Int</span>) =&gt;</span><br><span class="line">        <span class="keyword">val</span> fullId = appId + <span class="string">"/"</span> + id</span><br><span class="line">        logInfo((<span class="string">"Ex"</span> +</span><br><span class="line">          <span class="string">"ecutor added: %s on %s (%s) with %d cores"</span>).format(fullId, workerId, hostPort,</span><br><span class="line">          cores))</span><br><span class="line">        listener.executorAdded(fullId, workerId, hostPort, cores, memory)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="type">ExecutorUpdated</span>(id, state, message, exitStatus, workerLost) =&gt;</span><br><span class="line">        <span class="keyword">val</span> fullId = appId + <span class="string">"/"</span> + id</span><br><span class="line">        <span class="keyword">val</span> messageText = message.map(s =&gt; <span class="string">" ("</span> + s + <span class="string">")"</span>).getOrElse(<span class="string">""</span>)</span><br><span class="line">        logInfo(<span class="string">"Executor updated: %s is now %s%s"</span>.format(fullId, state, messageText))</span><br><span class="line">        <span class="keyword">if</span> (<span class="type">ExecutorState</span>.isFinished(state)) &#123;</span><br><span class="line">          listener.executorRemoved(fullId, message.getOrElse(<span class="string">""</span>), exitStatus, workerLost)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="type">MasterChanged</span>(masterRef, masterWebUiUrl) =&gt;</span><br><span class="line">        logInfo(<span class="string">"Master has changed, new master is at "</span> + masterRef.address.toSparkURL)</span><br><span class="line">        master = <span class="type">Some</span>(masterRef)</span><br><span class="line">        alreadyDisconnected = <span class="literal">false</span></span><br><span class="line">        masterRef.send(<span class="type">MasterChangeAcknowledged</span>(appId.get))</span><br><span class="line">    &#125; </span><br><span class="line">        </span><br><span class="line">   .... </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">receiveAndReply</span></span>(context: <span class="type">RpcCallContext</span>): <span class="type">PartialFunction</span>[<span class="type">Any</span>, <span class="type">Unit</span>] = &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="type">StopAppClient</span> =&gt;</span><br><span class="line">        markDead(<span class="string">"Application has been stopped."</span>)</span><br><span class="line">        sendToMaster(<span class="type">UnregisterApplication</span>(appId.get))</span><br><span class="line">        context.reply(<span class="literal">true</span>)</span><br><span class="line">        stop()      </span><br><span class="line">  &#125;</span><br><span class="line"> <span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">registerWithMaster</span></span>(nthRetry: <span class="type">Int</span>) &#123;  <span class="comment">//向Master 注册</span></span><br><span class="line">      registerMasterFutures.set(tryRegisterAllMasters())  <span class="comment">//查看这个方法</span></span><br><span class="line">      registrationRetryTimer.set(registrationRetryThread.schedule(<span class="keyword">new</span> <span class="type">Runnable</span> &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">          <span class="keyword">if</span> (registered.get) &#123;</span><br><span class="line">            registerMasterFutures.get.foreach(_.cancel(<span class="literal">true</span>))</span><br><span class="line">            registerMasterThreadPool.shutdownNow()</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nthRetry &gt;= <span class="type">REGISTRATION_RETRIES</span>) &#123;</span><br><span class="line">            markDead(<span class="string">"All masters are unresponsive! Giving up."</span>)</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            registerMasterFutures.get.foreach(_.cancel(<span class="literal">true</span>))</span><br><span class="line">            registerWithMaster(nthRetry + <span class="number">1</span>)  <span class="comment">//重试</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, <span class="type">REGISTRATION_TIMEOUT_SECONDS</span>, <span class="type">TimeUnit</span>.<span class="type">SECONDS</span>))</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="tryRegisterAllMasters"><a href="#tryRegisterAllMasters" class="headerlink" title="tryRegisterAllMasters"></a>tryRegisterAllMasters</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">tryRegisterAllMasters</span></span>(): <span class="type">Array</span>[<span class="type">JFuture</span>[_]] = &#123;</span><br><span class="line">   <span class="keyword">for</span> (masterAddress &lt;- masterRpcAddresses) <span class="keyword">yield</span> &#123;</span><br><span class="line">     registerMasterThreadPool.submit(<span class="keyword">new</span> <span class="type">Runnable</span> &#123;</span><br><span class="line">       <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>(): <span class="type">Unit</span> = <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="keyword">if</span> (registered.get) &#123;</span><br><span class="line">           <span class="keyword">return</span></span><br><span class="line">         &#125;</span><br><span class="line">         logInfo(<span class="string">"Connecting to master "</span> + masterAddress.toSparkURL + <span class="string">"..."</span>)</span><br><span class="line">         <span class="keyword">val</span> masterRef = rpcEnv.setupEndpointRef(masterAddress, <span class="type">Master</span>.<span class="type">ENDPOINT_NAME</span>)</span><br><span class="line">            <span class="comment">//给master发送RegisterApplication</span></span><br><span class="line">         masterRef.send(<span class="type">RegisterApplication</span>(appDescription, self)) <span class="comment">//控制权走到Master</span></span><br><span class="line">       &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">         <span class="keyword">case</span> ie: <span class="type">InterruptedException</span> =&gt; <span class="comment">// Cancelled</span></span><br><span class="line">         <span class="keyword">case</span> <span class="type">NonFatal</span>(e) =&gt; logWarning(<span class="string">s"Failed to connect to master <span class="subst">$masterAddress</span>"</span>, e)</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;)</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="回到Master-2"><a href="#回到Master-2" class="headerlink" title="回到Master"></a>回到Master</h3><h3 id="RegisterApplication"><a href="#RegisterApplication" class="headerlink" title="RegisterApplication"></a>RegisterApplication</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="type">RegisterApplication</span>(description, driver) =&gt;</span><br><span class="line">  <span class="comment">// TODO Prevent repeated registrations from some driver</span></span><br><span class="line">  <span class="keyword">if</span> (state == <span class="type">RecoveryState</span>.<span class="type">STANDBY</span>) &#123;</span><br><span class="line">    <span class="comment">// ignore, don't send response</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    logInfo(<span class="string">"Registering app "</span> + description.name)</span><br><span class="line">    <span class="keyword">val</span> app = createApplication(description, driver)</span><br><span class="line">    registerApplication(app)</span><br><span class="line">    logInfo(<span class="string">"Registered app "</span> + description.name + <span class="string">" with ID "</span> + app.id)</span><br><span class="line">    persistenceEngine.addApplication(app)</span><br><span class="line">    driver.send(<span class="type">RegisteredApplication</span>(app.id, self)) <span class="comment">//给driver 送法消息 </span></span><br><span class="line">    <span class="comment">// 启动分配Executor</span></span><br><span class="line">    schedule()</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="schedule-1"><a href="#schedule-1" class="headerlink" title="schedule"></a>schedule</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">schedule</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">if</span> (state != <span class="type">RecoveryState</span>.<span class="type">ALIVE</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Drivers take strict precedence over executors</span></span><br><span class="line">    <span class="keyword">val</span> shuffledAliveWorkers = <span class="type">Random</span>.shuffle(workers.toSeq.filter(_.state == <span class="type">WorkerState</span>.<span class="type">ALIVE</span>))</span><br><span class="line">    <span class="keyword">val</span> numWorkersAlive = shuffledAliveWorkers.size</span><br><span class="line">    <span class="keyword">var</span> curPos = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> (driver &lt;- waitingDrivers.toList) &#123; <span class="comment">// iterate over a copy of waitingDrivers</span></span><br><span class="line">      <span class="comment">// We assign workers to each waiting driver in a round-robin fashion. For each driver, we</span></span><br><span class="line">      <span class="comment">// start from the last worker that was assigned a driver, and continue onwards until we have</span></span><br><span class="line">      <span class="comment">// explored all alive workers.</span></span><br><span class="line">      <span class="keyword">var</span> launched = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">var</span> numWorkersVisited = <span class="number">0</span></span><br><span class="line">      <span class="keyword">while</span> (numWorkersVisited &lt; numWorkersAlive &amp;&amp; !launched) &#123;</span><br><span class="line">        <span class="keyword">val</span> worker = shuffledAliveWorkers(curPos)</span><br><span class="line">        numWorkersVisited += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> (worker.memoryFree &gt;= driver.desc.mem &amp;&amp; worker.coresFree &gt;= driver.desc.cores) &#123;</span><br><span class="line">          launchDriver(worker, driver)</span><br><span class="line">          waitingDrivers -= driver</span><br><span class="line">          launched = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        curPos = (curPos + <span class="number">1</span>) % numWorkersAlive</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    startExecutorsOnWorkers()  <span class="comment">//Worker已经部署 我们需要看这个</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="startExecutorsOnWorkers"><a href="#startExecutorsOnWorkers" class="headerlink" title="startExecutorsOnWorkers"></a>startExecutorsOnWorkers</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">startExecutorsOnWorkers</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">  <span class="comment">// Right now this is a very simple FIFO scheduler. We keep trying to fit in the first app</span></span><br><span class="line">  <span class="comment">// in the queue, then the second app, etc.</span></span><br><span class="line">    <span class="comment">//这里的应用并不能并行执行,因为 再for循环里面 的任务智能一个一个分配</span></span><br><span class="line">  <span class="keyword">for</span> (app &lt;- waitingApps <span class="keyword">if</span> app.coresLeft &gt; <span class="number">0</span>) &#123; <span class="comment">//这里waitingApps保存所有需要分配资源的Driver</span></span><br><span class="line">    <span class="keyword">val</span> coresPerExecutor: <span class="type">Option</span>[<span class="type">Int</span>] = app.desc.coresPerExecutor</span><br><span class="line">    <span class="comment">// Filter out workers that don't have enough resources to launch an executor</span></span><br><span class="line">    <span class="keyword">val</span> usableWorkers = workers.toArray.filter(_.state == <span class="type">WorkerState</span>.<span class="type">ALIVE</span>) <span class="comment">//调出满足应用的Exector需要的Worker </span></span><br><span class="line">      .filter(worker =&gt; worker.memoryFree &gt;= app.desc.memoryPerExecutorMB &amp;&amp; </span><br><span class="line">        worker.coresFree &gt;= coresPerExecutor.getOrElse(<span class="number">1</span>))</span><br><span class="line">      .sortBy(_.coresFree).reverse</span><br><span class="line"></span><br><span class="line">      <span class="comment">//scheduleExecutorsOnWorkers是资源分配的核心算法我们来看一下</span></span><br><span class="line">    <span class="keyword">val</span> assignedCores = scheduleExecutorsOnWorkers(app, usableWorkers, spreadOutApps)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now that we've decided how many cores to allocate on each worker, let's allocate them</span></span><br><span class="line">    <span class="keyword">for</span> (pos &lt;- <span class="number">0</span> until usableWorkers.length <span class="keyword">if</span> assignedCores(pos) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      allocateWorkerResourceToExecutors( </span><br><span class="line">        app, assignedCores(pos), coresPerExecutor, usableWorkers(pos))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="scheduleExecutorsOnWorkers"><a href="#scheduleExecutorsOnWorkers" class="headerlink" title="scheduleExecutorsOnWorkers"></a>scheduleExecutorsOnWorkers</h3><p>资源分配的核心代码</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">scheduleExecutorsOnWorkers</span></span>(</span><br><span class="line">    app: <span class="type">ApplicationInfo</span>,</span><br><span class="line">    usableWorkers: <span class="type">Array</span>[<span class="type">WorkerInfo</span>],</span><br><span class="line">    spreadOutApps: <span class="type">Boolean</span>): <span class="type">Array</span>[<span class="type">Int</span>] = &#123; <span class="comment">//如果参数为True 仅量吧你需要的Executor分配到不同的Worker上</span></span><br><span class="line">  <span class="comment">// 每一个Executor有多少Core</span></span><br><span class="line">  <span class="keyword">val</span> coresPerExecutor = app.desc.coresPerExecutor</span><br><span class="line">  <span class="comment">// minCoresPerExecutor 如果你没定义那么就是1，如果定义了就是coresPerExecutor</span></span><br><span class="line">  <span class="keyword">val</span> minCoresPerExecutor = coresPerExecutor.getOrElse(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 是否允许一个worker上有多个Executor</span></span><br><span class="line">  <span class="keyword">val</span> oneExecutorPerWorker = coresPerExecutor.isEmpty</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 指定Memory 1G</span></span><br><span class="line">  <span class="keyword">val</span> memoryPerExecutor = app.desc.memoryPerExecutorMB</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获得usableWorkers 长度</span></span><br><span class="line">  <span class="keyword">val</span> numUsable = usableWorkers.length</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> assignedCores = <span class="keyword">new</span> <span class="type">Array</span>[<span class="type">Int</span>](numUsable) <span class="comment">// Number of cores to give to each worker</span></span><br><span class="line">  <span class="keyword">val</span> assignedExecutors = <span class="keyword">new</span> <span class="type">Array</span>[<span class="type">Int</span>](numUsable) <span class="comment">// Number of new executors on each worker</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// coresToAssign 保险</span></span><br><span class="line">  <span class="keyword">var</span> coresToAssign = math.min(app.coresLeft, usableWorkers.map(_.coresFree).sum)</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Return whether the specified worker can launch an executor for this app. */</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">canLaunchExecutor</span></span>(pos: <span class="type">Int</span>): <span class="type">Boolean</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> keepScheduling = coresToAssign &gt;= minCoresPerExecutor</span><br><span class="line">    <span class="keyword">val</span> enoughCores = usableWorkers(pos).coresFree - assignedCores(pos) &gt;= minCoresPerExecutor</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we allow multiple executors per worker, then we can always launch new executors.</span></span><br><span class="line">    <span class="comment">// Otherwise, if there is already an executor on this worker, just give it more cores.</span></span><br><span class="line">    <span class="keyword">val</span> launchingNewExecutor = !oneExecutorPerWorker || assignedExecutors(pos) == <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> (launchingNewExecutor) &#123;</span><br><span class="line">      <span class="keyword">val</span> assignedMemory = assignedExecutors(pos) * memoryPerExecutor</span><br><span class="line">      <span class="keyword">val</span> enoughMemory = usableWorkers(pos).memoryFree - assignedMemory &gt;= memoryPerExecutor</span><br><span class="line">      <span class="keyword">val</span> underLimit = assignedExecutors.sum + app.executors.size &lt; app.executorLimit</span><br><span class="line">      keepScheduling &amp;&amp; enoughCores &amp;&amp; enoughMemory &amp;&amp; underLimit</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// We're adding cores to an existing executor, so no need</span></span><br><span class="line">      <span class="comment">// to check memory and executor limits</span></span><br><span class="line">      keepScheduling &amp;&amp; enoughCores</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Keep launching executors until no more workers can accommodate any</span></span><br><span class="line">  <span class="comment">// more executors, or if we have reached this application's limits</span></span><br><span class="line">  <span class="keyword">var</span> freeWorkers = (<span class="number">0</span> until numUsable).filter(canLaunchExecutor)</span><br><span class="line">  <span class="keyword">while</span> (freeWorkers.nonEmpty) &#123;</span><br><span class="line">    freeWorkers.foreach &#123; pos =&gt;</span><br><span class="line">      <span class="keyword">var</span> keepScheduling = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">while</span> (keepScheduling &amp;&amp; canLaunchExecutor(pos)) &#123;</span><br><span class="line">        coresToAssign -= minCoresPerExecutor</span><br><span class="line">        assignedCores(pos) += minCoresPerExecutor</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If we are launching one executor per worker, then every iteration assigns 1 core</span></span><br><span class="line">        <span class="comment">// to the executor. Otherwise, every iteration assigns cores to a new executor.</span></span><br><span class="line">        <span class="keyword">if</span> (oneExecutorPerWorker) &#123;</span><br><span class="line">          assignedExecutors(pos) = <span class="number">1</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          assignedExecutors(pos) += <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Spreading out an application means spreading out its executors across as</span></span><br><span class="line">        <span class="comment">// many workers as possible. If we are not spreading out, then we should keep</span></span><br><span class="line">        <span class="comment">// scheduling executors on this worker until we use all of its resources.</span></span><br><span class="line">        <span class="comment">// Otherwise, just move on to the next worker.</span></span><br><span class="line">        <span class="keyword">if</span> (spreadOutApps) &#123;</span><br><span class="line">          keepScheduling = <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    freeWorkers = freeWorkers.filter(canLaunchExecutor)</span><br><span class="line">  &#125;</span><br><span class="line">  assignedCores</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="startExecutorsOnWorkers-1"><a href="#startExecutorsOnWorkers-1" class="headerlink" title="startExecutorsOnWorkers"></a>startExecutorsOnWorkers</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Schedule and launch executors on workers</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">startExecutorsOnWorkers</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">  <span class="comment">// Right now this is a very simple FIFO scheduler. We keep trying to fit in the first app</span></span><br><span class="line">  <span class="comment">// in the queue, then the second app, etc.</span></span><br><span class="line">  <span class="keyword">for</span> (app &lt;- waitingApps <span class="keyword">if</span> app.coresLeft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">val</span> coresPerExecutor: <span class="type">Option</span>[<span class="type">Int</span>] = app.desc.coresPerExecutor</span><br><span class="line">    <span class="comment">// Filter out workers that don't have enough resources to launch an executor</span></span><br><span class="line">    <span class="keyword">val</span> usableWorkers = workers.toArray.filter(_.state == <span class="type">WorkerState</span>.<span class="type">ALIVE</span>)</span><br><span class="line">      .filter(worker =&gt; worker.memoryFree &gt;= app.desc.memoryPerExecutorMB &amp;&amp;</span><br><span class="line">        worker.coresFree &gt;= coresPerExecutor.getOrElse(<span class="number">1</span>))</span><br><span class="line">      .sortBy(_.coresFree).reverse</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> assignedCores = scheduleExecutorsOnWorkers(app, usableWorkers, spreadOutApps)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now that we've decided how many cores to allocate on each worker, let's allocate them</span></span><br><span class="line">    <span class="keyword">for</span> (pos &lt;- <span class="number">0</span> until usableWorkers.length <span class="keyword">if</span> assignedCores(pos) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      allocateWorkerResourceToExecutors(  <span class="comment">//控制权 回到allocateWorkerResourceToExecutors</span></span><br><span class="line">        app, assignedCores(pos), coresPerExecutor, usableWorkers(pos))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="allocateWorkerResourceToExecutors"><a href="#allocateWorkerResourceToExecutors" class="headerlink" title="allocateWorkerResourceToExecutors"></a>allocateWorkerResourceToExecutors</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">allocateWorkerResourceToExecutors</span></span>(</span><br><span class="line">    app: <span class="type">ApplicationInfo</span>,</span><br><span class="line">    assignedCores: <span class="type">Int</span>,</span><br><span class="line">    coresPerExecutor: <span class="type">Option</span>[<span class="type">Int</span>],</span><br><span class="line">    worker: <span class="type">WorkerInfo</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">  <span class="comment">// If the number of cores per executor is specified, we divide the cores assigned</span></span><br><span class="line">  <span class="comment">// to this worker evenly among the executors with no remainder.</span></span><br><span class="line">  <span class="comment">// Otherwise, we launch a single executor that grabs all the assignedCores on this worker.</span></span><br><span class="line">  <span class="keyword">val</span> numExecutors = coresPerExecutor.map &#123; assignedCores / _ &#125;.getOrElse(<span class="number">1</span>)</span><br><span class="line">  <span class="keyword">val</span> coresToAssign = coresPerExecutor.getOrElse(assignedCores)</span><br><span class="line">  <span class="keyword">for</span> (i &lt;- <span class="number">1</span> to numExecutors) &#123;</span><br><span class="line">    <span class="keyword">val</span> exec = app.addExecutor(worker, coresToAssign)</span><br><span class="line">    launchExecutor(worker, exec) <span class="comment">//启动Executor  给 Worker</span></span><br><span class="line">    app.state = <span class="type">ApplicationState</span>.<span class="type">RUNNING</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="launchExecutor"><a href="#launchExecutor" class="headerlink" title="launchExecutor"></a>launchExecutor</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">launchExecutor</span></span>(worker: <span class="type">WorkerInfo</span>, exec: <span class="type">ExecutorDesc</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">   logInfo(<span class="string">"Launching executor "</span> + exec.fullId + <span class="string">" on worker "</span> + worker.id)</span><br><span class="line">   worker.addExecutor(exec)</span><br><span class="line">   worker.endpoint.send(<span class="type">LaunchExecutor</span>(masterUrl, <span class="comment">//给worker发送 LaunchExecutor</span></span><br><span class="line">     exec.application.id, exec.id, exec.application.desc, exec.cores, exec.memory))</span><br><span class="line">   exec.application.driver.send(</span><br><span class="line">     <span class="type">ExecutorAdded</span>(exec.id, worker.id, worker.hostPort, exec.cores, exec.memory))</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="回到Worker-1"><a href="#回到Worker-1" class="headerlink" title="回到Worker"></a>回到Worker</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="type">LaunchExecutor</span>(masterUrl, appId, execId, appDesc, cores_, memory_) =&gt;</span><br><span class="line">      <span class="keyword">if</span> (masterUrl != activeMasterUrl) &#123;</span><br><span class="line">        logWarning(<span class="string">"Invalid Master ("</span> + masterUrl + <span class="string">") attempted to launch executor."</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          logInfo(<span class="string">"Asked to launch executor %s/%d for %s"</span>.format(appId, execId, appDesc.name))</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Create the executor's working directory</span></span><br><span class="line">          <span class="keyword">val</span> executorDir = <span class="keyword">new</span> <span class="type">File</span>(workDir, appId + <span class="string">"/"</span> + execId) <span class="comment">//创建工作目录</span></span><br><span class="line">          <span class="keyword">if</span> (!executorDir.mkdirs()) &#123; <span class="comment">//如果没有创建</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IOException</span>(<span class="string">"Failed to create directory "</span> + executorDir)</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Create local dirs for the executor. These are passed to the executor via the</span></span><br><span class="line">          <span class="comment">// SPARK_EXECUTOR_DIRS environment variable, and deleted by the Worker when the</span></span><br><span class="line">          <span class="comment">// application finishes.</span></span><br><span class="line">          <span class="keyword">val</span> appLocalDirs = appDirectories.getOrElse(appId,</span><br><span class="line">            <span class="type">Utils</span>.getOrCreateLocalRootDirs(conf).map &#123; dir =&gt;</span><br><span class="line">              <span class="keyword">val</span> appDir = <span class="type">Utils</span>.createDirectory(dir, namePrefix = <span class="string">"executor"</span>)</span><br><span class="line">              <span class="type">Utils</span>.chmod700(appDir)</span><br><span class="line">              appDir.getAbsolutePath()</span><br><span class="line">            &#125;.toSeq)</span><br><span class="line">          appDirectories(appId) = appLocalDirs </span><br><span class="line">          <span class="keyword">val</span> manager = <span class="keyword">new</span> <span class="type">ExecutorRunner</span>( <span class="comment">//如果可以</span></span><br><span class="line">            appId,</span><br><span class="line">            execId,</span><br><span class="line">            appDesc.copy(command = <span class="type">Worker</span>.maybeUpdateSSLSettings(appDesc.command, conf)),</span><br><span class="line">            cores_,</span><br><span class="line">            memory_,</span><br><span class="line">            self,</span><br><span class="line">            workerId,</span><br><span class="line">            host,</span><br><span class="line">            webUi.boundPort,</span><br><span class="line">            publicAddress,</span><br><span class="line">            sparkHome,</span><br><span class="line">            executorDir,</span><br><span class="line">            workerUri,</span><br><span class="line">            conf,</span><br><span class="line">            appLocalDirs, <span class="type">ExecutorState</span>.<span class="type">RUNNING</span>)</span><br><span class="line">          executors(appId + <span class="string">"/"</span> + execId) = manager</span><br><span class="line">          manager.start() <span class="comment">//控制权到了这里</span></span><br><span class="line">          coresUsed += cores_</span><br><span class="line">          memoryUsed += memory_</span><br><span class="line">          sendToMaster(<span class="type">ExecutorStateChanged</span>(appId, execId, manager.state, <span class="type">None</span>, <span class="type">None</span>)) <span class="comment">//给Master发送Executor的资源分配已经好了 </span></span><br><span class="line">        &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">          <span class="keyword">case</span> e: <span class="type">Exception</span> =&gt;</span><br><span class="line">            logError(<span class="string">s"Failed to launch executor <span class="subst">$appId</span>/<span class="subst">$execId</span> for <span class="subst">$&#123;appDesc.name&#125;</span>."</span>, e)</span><br><span class="line">            <span class="keyword">if</span> (executors.contains(appId + <span class="string">"/"</span> + execId)) &#123;</span><br><span class="line">              executors(appId + <span class="string">"/"</span> + execId).kill()</span><br><span class="line">              executors -= appId + <span class="string">"/"</span> + execId</span><br><span class="line">            &#125;</span><br><span class="line">            sendToMaster(<span class="type">ExecutorStateChanged</span>(appId, execId, <span class="type">ExecutorState</span>.<span class="type">FAILED</span>,</span><br><span class="line">              <span class="type">Some</span>(e.toString), <span class="type">None</span>))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<h3 id="跳转到ExecutorRunner"><a href="#跳转到ExecutorRunner" class="headerlink" title="跳转到ExecutorRunner"></a>跳转到ExecutorRunner</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>[worker] <span class="function"><span class="keyword">def</span> <span class="title">start</span></span>() &#123;</span><br><span class="line">  workerThread = <span class="keyword">new</span> <span class="type">Thread</span>(<span class="string">"ExecutorRunner for "</span> + fullId) &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>() &#123; fetchAndRunExecutor() &#125; <span class="comment">//启动Executro我们点进来看一下</span></span><br><span class="line">  &#125;</span><br><span class="line">  workerThread.start()</span><br><span class="line">  <span class="comment">// Shutdown hook that kills actors on shutdown.</span></span><br><span class="line">  shutdownHook = <span class="type">ShutdownHookManager</span>.addShutdownHook &#123; () =&gt;</span><br><span class="line">    <span class="comment">// It's possible that we arrive here before calling `fetchAndRunExecutor`, then `state` will</span></span><br><span class="line">    <span class="comment">// be `ExecutorState.RUNNING`. In this case, we should set `state` to `FAILED`.</span></span><br><span class="line">    <span class="keyword">if</span> (state == <span class="type">ExecutorState</span>.<span class="type">RUNNING</span>) &#123;</span><br><span class="line">      state = <span class="type">ExecutorState</span>.<span class="type">FAILED</span></span><br><span class="line">    &#125;</span><br><span class="line">    killProcess(<span class="type">Some</span>(<span class="string">"Worker shutting down"</span>)) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="fetchAndRunExecutor"><a href="#fetchAndRunExecutor" class="headerlink" title="fetchAndRunExecutor"></a>fetchAndRunExecutor</h3><p>没有特别指出</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">fetchAndRunExecutor</span></span>() &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// Launch the process</span></span><br><span class="line">    <span class="keyword">val</span> builder = <span class="type">CommandUtils</span>.buildProcessBuilder(appDesc.command, <span class="keyword">new</span> <span class="type">SecurityManager</span>(conf),</span><br><span class="line">      memory, sparkHome.getAbsolutePath, substituteVariables)</span><br><span class="line">    <span class="keyword">val</span> command = builder.command() <span class="comment">//这里的builder应该是processbuilder 运行一个本地命令</span></span><br><span class="line">    <span class="keyword">val</span> formattedCommand = command.asScala.mkString(<span class="string">"\""</span>, <span class="string">"\" \""</span>, <span class="string">"\""</span>)</span><br><span class="line">    logInfo(<span class="string">s"Launch command: <span class="subst">$formattedCommand</span>"</span>)</span><br><span class="line"></span><br><span class="line">    builder.directory(executorDir)</span><br><span class="line">    builder.environment.put(<span class="string">"SPARK_EXECUTOR_DIRS"</span>, appLocalDirs.mkString(<span class="type">File</span>.pathSeparator))</span><br><span class="line">    <span class="comment">// In case we are running this from within the Spark Shell, avoid creating a "scala"</span></span><br><span class="line">    <span class="comment">// parent process for the executor command</span></span><br><span class="line">    builder.environment.put(<span class="string">"SPARK_LAUNCH_WITH_SCALA"</span>, <span class="string">"0"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add webUI log urls</span></span><br><span class="line">    <span class="keyword">val</span> baseUrl =</span><br><span class="line">      <span class="keyword">if</span> (conf.getBoolean(<span class="string">"spark.ui.reverseProxy"</span>, <span class="literal">false</span>)) &#123;</span><br><span class="line">        <span class="string">s"/proxy/<span class="subst">$workerId</span>/logPage/?appId=<span class="subst">$appId</span>&amp;executorId=<span class="subst">$execId</span>&amp;logType="</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="string">s"http://<span class="subst">$publicAddress</span>:<span class="subst">$webUiPort</span>/logPage/?appId=<span class="subst">$appId</span>&amp;executorId=<span class="subst">$execId</span>&amp;logType="</span></span><br><span class="line">      &#125;</span><br><span class="line">    builder.environment.put(<span class="string">"SPARK_LOG_URL_STDERR"</span>, <span class="string">s"<span class="subst">$&#123;baseUrl&#125;</span>stderr"</span>)</span><br><span class="line">    builder.environment.put(<span class="string">"SPARK_LOG_URL_STDOUT"</span>, <span class="string">s"<span class="subst">$&#123;baseUrl&#125;</span>stdout"</span>)</span><br><span class="line"></span><br><span class="line">    process = builder.start() <span class="comment">// 根据流程图 会创建一个 CoarseGrainedSchedulerBackend 我们去哪里看下</span></span><br><span class="line">    <span class="keyword">val</span> header = <span class="string">"Spark Executor Command: %s\n%s\n\n"</span>.format(</span><br><span class="line">      formattedCommand, <span class="string">"="</span> * <span class="number">40</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Redirect its stdout and stderr to files</span></span><br><span class="line">    <span class="keyword">val</span> stdout = <span class="keyword">new</span> <span class="type">File</span>(executorDir, <span class="string">"stdout"</span>)</span><br><span class="line">    stdoutAppender = <span class="type">FileAppender</span>(process.getInputStream, stdout, conf)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> stderr = <span class="keyword">new</span> <span class="type">File</span>(executorDir, <span class="string">"stderr"</span>)</span><br><span class="line">    <span class="type">Files</span>.write(header, stderr, <span class="type">StandardCharsets</span>.<span class="type">UTF_8</span>)</span><br><span class="line">    stderrAppender = <span class="type">FileAppender</span>(process.getErrorStream, stderr, conf)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Wait for it to exit; executor may exit with code 0 (when driver instructs it to shutdown)</span></span><br><span class="line">    <span class="comment">// or with nonzero exit code</span></span><br><span class="line">    <span class="keyword">val</span> exitCode = process.waitFor()</span><br><span class="line">    state = <span class="type">ExecutorState</span>.<span class="type">EXITED</span></span><br><span class="line">    <span class="keyword">val</span> message = <span class="string">"Command exited with code "</span> + exitCode</span><br><span class="line">    worker.send(<span class="type">ExecutorStateChanged</span>(appId, execId, state, <span class="type">Some</span>(message), <span class="type">Some</span>(exitCode)))</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> interrupted: <span class="type">InterruptedException</span> =&gt;</span><br><span class="line">      logInfo(<span class="string">"Runner thread for executor "</span> + fullId + <span class="string">" interrupted"</span>)</span><br><span class="line">      state = <span class="type">ExecutorState</span>.<span class="type">KILLED</span></span><br><span class="line">      killProcess(<span class="type">None</span>)</span><br><span class="line">    <span class="keyword">case</span> e: <span class="type">Exception</span> =&gt;</span><br><span class="line">      logError(<span class="string">"Error running executor"</span>, e)</span><br><span class="line">      state = <span class="type">ExecutorState</span>.<span class="type">FAILED</span></span><br><span class="line">      killProcess(<span class="type">Some</span>(e.toString))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="回到Master-3"><a href="#回到Master-3" class="headerlink" title="回到Master"></a>回到Master</h3><p>因为<code>sendToMaster(ExecutorStateChanged(appId, execId, manager.state, None, None))</code>给Master发送了一条消息</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">case</span> <span class="type">ExecutorStateChanged</span>(appId, execId, state, message, exitStatus) =&gt;</span><br><span class="line">   <span class="keyword">val</span> execOption = idToApp.get(appId).flatMap(app =&gt; app.executors.get(execId))</span><br><span class="line">   execOption <span class="keyword">match</span> &#123;</span><br><span class="line">     <span class="keyword">case</span> <span class="type">Some</span>(exec) =&gt;</span><br><span class="line">       <span class="keyword">val</span> appInfo = idToApp(appId)</span><br><span class="line">       <span class="keyword">val</span> oldState = exec.state</span><br><span class="line">       exec.state = state</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (state == <span class="type">ExecutorState</span>.<span class="type">RUNNING</span>) &#123;</span><br><span class="line">         assert(oldState == <span class="type">ExecutorState</span>.<span class="type">LAUNCHING</span>,</span><br><span class="line">           <span class="string">s"executor <span class="subst">$execId</span> state transfer from <span class="subst">$oldState</span> to RUNNING is illegal"</span>)</span><br><span class="line">         appInfo.resetRetryCount()</span><br><span class="line">       &#125;</span><br><span class="line"><span class="comment">//查看一下ExecutorUpdated 再StandaloneAppClient中</span></span><br><span class="line">       exec.application.driver.send(<span class="type">ExecutorUpdated</span>(execId, state, message, exitStatus, <span class="literal">false</span>))</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="跳转到StandaloneAppClient"><a href="#跳转到StandaloneAppClient" class="headerlink" title="跳转到StandaloneAppClient"></a>跳转到StandaloneAppClient</h3><h3 id="ExecutorUpdated"><a href="#ExecutorUpdated" class="headerlink" title="ExecutorUpdated"></a>ExecutorUpdated</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="type">ExecutorAdded</span>(id: <span class="type">Int</span>, workerId: <span class="type">String</span>, hostPort: <span class="type">String</span>, cores: <span class="type">Int</span>, memory: <span class="type">Int</span>) =&gt;</span><br><span class="line">     <span class="keyword">val</span> fullId = appId + <span class="string">"/"</span> + id</span><br><span class="line">     logInfo((<span class="string">"Ex"</span> +</span><br><span class="line">       <span class="string">"ecutor added: %s on %s (%s) with %d cores"</span>).format(fullId, workerId, hostPort,</span><br><span class="line">       cores))</span><br><span class="line">     listener.executorAdded(fullId, workerId, hostPort, cores, memory) <span class="comment">//这里的listener</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">case</span> <span class="type">ExecutorUpdated</span>(id, state, message, exitStatus, workerLost) =&gt;</span><br><span class="line">     <span class="keyword">val</span> fullId = appId + <span class="string">"/"</span> + id</span><br><span class="line">     <span class="keyword">val</span> messageText = message.map(s =&gt; <span class="string">" ("</span> + s + <span class="string">")"</span>).getOrElse(<span class="string">""</span>)</span><br><span class="line">     logInfo(<span class="string">"Executor updated: %s is now %s%s"</span>.format(fullId, state, messageText))</span><br><span class="line">     <span class="keyword">if</span> (<span class="type">ExecutorState</span>.isFinished(state)) &#123;</span><br><span class="line">       listener.executorRemoved(fullId, message.getOrElse(<span class="string">""</span>), exitStatus, workerLost)</span><br><span class="line">     &#125;  <span class="comment">//Executor资源基本完成</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">case</span> <span class="type">MasterChanged</span>(masterRef, masterWebUiUrl) =&gt;</span><br><span class="line">     logInfo(<span class="string">"Master has changed, new master is at "</span> + masterRef.address.toSparkURL)</span><br><span class="line">     master = <span class="type">Some</span>(masterRef)</span><br><span class="line">     alreadyDisconnected = <span class="literal">false</span></span><br><span class="line">     masterRef.send(<span class="type">MasterChangeAcknowledged</span>(appId.get)) </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="listener"><a href="#listener" class="headerlink" title="listener"></a>listener</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>[spark] <span class="class"><span class="keyword">class</span> <span class="title">StandaloneAppClient</span>(<span class="params"></span></span></span><br><span class="line"><span class="class"><span class="params">    rpcEnv: <span class="type">RpcEnv</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    masterUrls: <span class="type">Array</span>[<span class="type">String</span>],</span></span></span><br><span class="line"><span class="class"><span class="params">    appDescription: <span class="type">ApplicationDescription</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    listener: <span class="type">StandaloneAppClientListener</span>, //这就是<span class="type">Executor</span>中的listener</span></span></span><br><span class="line"><span class="class"><span class="params">    conf: <span class="type">SparkConf</span></span>)</span></span><br></pre></td></tr></table></figure>

<h3 id="回到StandaloneSchedulerBackend-1"><a href="#回到StandaloneSchedulerBackend-1" class="headerlink" title="回到StandaloneSchedulerBackend"></a>回到StandaloneSchedulerBackend</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>[spark] <span class="class"><span class="keyword">class</span> <span class="title">StandaloneSchedulerBackend</span>(<span class="params"></span></span></span><br><span class="line"><span class="class"><span class="params">    scheduler: <span class="type">TaskSchedulerImpl</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    sc: <span class="type">SparkContext</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    masters: <span class="type">Array</span>[<span class="type">String</span>]</span>)</span></span><br><span class="line"><span class="class">  <span class="keyword">extends</span> <span class="title">CoarseGrainedSchedulerBackend</span>(<span class="params">scheduler, sc.env.rpcEnv</span>) </span></span><br><span class="line"><span class="class">  <span class="keyword">with</span> <span class="title">StandaloneAppClientListener</span>  <span class="title">//继承了那个listner</span></span>;</span><br><span class="line">  <span class="keyword">with</span> <span class="type">Logging</span> &#123;</span><br><span class="line">      ....</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="StandaloneAppClientListener"><a href="#StandaloneAppClientListener" class="headerlink" title="StandaloneAppClientListener"></a>StandaloneAppClientListener</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>[spark] <span class="class"><span class="keyword">trait</span> <span class="title">StandaloneAppClientListener</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">connected</span></span>(appId: <span class="type">String</span>): <span class="type">Unit</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Disconnection may be a temporary state, as we fail over to a new Master. */</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">disconnected</span></span>(): <span class="type">Unit</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/** An application death is an unrecoverable failure condition. */</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">dead</span></span>(reason: <span class="type">String</span>): <span class="type">Unit</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">executorAdded</span></span>(</span><br><span class="line">      fullId: <span class="type">String</span>, workerId: <span class="type">String</span>, hostPort: <span class="type">String</span>, cores: <span class="type">Int</span>, memory: <span class="type">Int</span>): <span class="type">Unit</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">executorRemoved</span></span>(</span><br><span class="line">      fullId: <span class="type">String</span>, message: <span class="type">String</span>, exitStatus: <span class="type">Option</span>[<span class="type">Int</span>], workerLost: <span class="type">Boolean</span>): <span class="type">Unit</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="查看executorAdded"><a href="#查看executorAdded" class="headerlink" title="查看executorAdded"></a>查看executorAdded</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">executorAdded</span></span>(fullId: <span class="type">String</span>, workerId: <span class="type">String</span>, hostPort: <span class="type">String</span>, cores: <span class="type">Int</span>,</span><br><span class="line">    memory: <span class="type">Int</span>) &#123;</span><br><span class="line">    logInfo(<span class="string">"Granted executor ID %s on hostPort %s with %d cores, %s RAM"</span>.format(</span><br><span class="line">      fullId, hostPort, cores, <span class="type">Utils</span>.megabytesToString(memory)))</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>到此为止步,Executor进程启动完成.</p>
<h2 id="任务提交和反馈"><a href="#任务提交和反馈" class="headerlink" title="任务提交和反馈"></a>任务提交和反馈</h2><p>通过对RDD的观察行动算子最终调用的方法runJob</p>
<h3 id="SparkContext"><a href="#SparkContext" class="headerlink" title="SparkContext"></a>SparkContext</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Run a function on a given set of partitions in an RDD and pass the results to the given</span></span><br><span class="line"><span class="comment"> * handler function. This is the main entry point for all actions in Spark.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runJob</span></span>[<span class="type">T</span>, <span class="type">U</span>: <span class="type">ClassTag</span>](</span><br><span class="line">    rdd: <span class="type">RDD</span>[<span class="type">T</span>],</span><br><span class="line">    func: (<span class="type">TaskContext</span>, <span class="type">Iterator</span>[<span class="type">T</span>]) =&gt; <span class="type">U</span>,</span><br><span class="line">    partitions: <span class="type">Seq</span>[<span class="type">Int</span>],</span><br><span class="line">    resultHandler: (<span class="type">Int</span>, <span class="type">U</span>) =&gt; <span class="type">Unit</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">  <span class="keyword">if</span> (stopped.get()) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IllegalStateException</span>(<span class="string">"SparkContext has been shutdown"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">val</span> callSite = getCallSite</span><br><span class="line">  <span class="keyword">val</span> cleanedFunc = clean(func)</span><br><span class="line">  logInfo(<span class="string">"Starting job: "</span> + callSite.shortForm)</span><br><span class="line">  <span class="keyword">if</span> (conf.getBoolean(<span class="string">"spark.logLineage"</span>, <span class="literal">false</span>)) &#123;</span><br><span class="line">    logInfo(<span class="string">"RDD's recursive dependencies:\n"</span> + rdd.toDebugString)</span><br><span class="line">  &#125;  <span class="comment">//我们查看一下dagScheduler</span></span><br><span class="line">  dagScheduler.runJob(rdd, cleanedFunc, partitions, callSite, resultHandler, localProperties.get)</span><br><span class="line">  progressBar.foreach(_.finishAll())</span><br><span class="line">  rdd.doCheckpoint()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Run a function on a given set of partitions in an RDD and return the results as an array.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runJob</span></span>[<span class="type">T</span>, <span class="type">U</span>: <span class="type">ClassTag</span>](</span><br><span class="line">    rdd: <span class="type">RDD</span>[<span class="type">T</span>],</span><br><span class="line">    func: (<span class="type">TaskContext</span>, <span class="type">Iterator</span>[<span class="type">T</span>]) =&gt; <span class="type">U</span>,</span><br><span class="line">    partitions: <span class="type">Seq</span>[<span class="type">Int</span>]): <span class="type">Array</span>[<span class="type">U</span>] = &#123;</span><br><span class="line">  <span class="keyword">val</span> results = <span class="keyword">new</span> <span class="type">Array</span>[<span class="type">U</span>](partitions.size)</span><br><span class="line">  runJob[<span class="type">T</span>, <span class="type">U</span>](rdd, func, partitions, (index, res) =&gt; results(index) = res)</span><br><span class="line">  results</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="DAGScheduler"><a href="#DAGScheduler" class="headerlink" title="DAGScheduler"></a>DAGScheduler</h3><h3 id="runrunJob"><a href="#runrunJob" class="headerlink" title="runrunJob"></a>runrunJob</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Run an action job on the given RDD and pass all the results to the resultHandler function as</span></span><br><span class="line"><span class="comment"> * they arrive.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param rdd target RDD to run tasks on</span></span><br><span class="line"><span class="comment"> * @param func a function to run on each partition of the RDD</span></span><br><span class="line"><span class="comment"> * @param partitions set of partitions to run on; some jobs may not want to compute on all</span></span><br><span class="line"><span class="comment"> *   partitions of the target RDD, e.g. for operations like first()</span></span><br><span class="line"><span class="comment"> * @param callSite where in the user program this job was called</span></span><br><span class="line"><span class="comment"> * @param resultHandler callback to pass each result to</span></span><br><span class="line"><span class="comment"> * @param properties scheduler properties to attach to this job, e.g. fair scheduler pool name</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @throws Exception when the job fails</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runJob</span></span>[<span class="type">T</span>, <span class="type">U</span>](</span><br><span class="line">    rdd: <span class="type">RDD</span>[<span class="type">T</span>],</span><br><span class="line">    func: (<span class="type">TaskContext</span>, <span class="type">Iterator</span>[<span class="type">T</span>]) =&gt; <span class="type">U</span>,</span><br><span class="line">    partitions: <span class="type">Seq</span>[<span class="type">Int</span>],</span><br><span class="line">    callSite: <span class="type">CallSite</span>,</span><br><span class="line">    resultHandler: (<span class="type">Int</span>, <span class="type">U</span>) =&gt; <span class="type">Unit</span>,</span><br><span class="line">    properties: <span class="type">Properties</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">  <span class="keyword">val</span> start = <span class="type">System</span>.nanoTime    <span class="comment">/**提交Job**/</span></span><br><span class="line">  <span class="keyword">val</span> waiter = submitJob(rdd, func, partitions, callSite, resultHandler, properties) </span><br><span class="line">  <span class="comment">// Note: Do not call Await.ready(future) because that calls `scala.concurrent.blocking`,</span></span><br><span class="line">  <span class="comment">// which causes concurrent SQL executions to fail if a fork-join pool is used. Note that</span></span><br><span class="line">  <span class="comment">// due to idiosyncrasies in Scala, `awaitPermission` is not actually used anywhere so it's</span></span><br><span class="line">  <span class="comment">// safe to pass in null here. For more detail, see SPARK-13747.</span></span><br><span class="line">  <span class="keyword">val</span> awaitPermission = <span class="literal">null</span>.asInstanceOf[scala.concurrent.<span class="type">CanAwait</span>]</span><br><span class="line">  waiter.completionFuture.ready(<span class="type">Duration</span>.<span class="type">Inf</span>)(awaitPermission)</span><br><span class="line">  waiter.completionFuture.value.get <span class="keyword">match</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> scala.util.<span class="type">Success</span>(_) =&gt;</span><br><span class="line">      logInfo(<span class="string">"Job %d finished: %s, took %f s"</span>.format</span><br><span class="line">        (waiter.jobId, callSite.shortForm, (<span class="type">System</span>.nanoTime - start) / <span class="number">1e9</span>))</span><br><span class="line">    <span class="keyword">case</span> scala.util.<span class="type">Failure</span>(exception) =&gt;</span><br><span class="line">      logInfo(<span class="string">"Job %d failed: %s, took %f s"</span>.format</span><br><span class="line">        (waiter.jobId, callSite.shortForm, (<span class="type">System</span>.nanoTime - start) / <span class="number">1e9</span>))</span><br><span class="line">      <span class="comment">// SPARK-8644: Include user stack trace in exceptions coming from DAGScheduler.</span></span><br><span class="line">      <span class="keyword">val</span> callerStackTrace = <span class="type">Thread</span>.currentThread().getStackTrace.tail</span><br><span class="line">      exception.setStackTrace(exception.getStackTrace ++ callerStackTrace)</span><br><span class="line">      <span class="keyword">throw</span> exception</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="submitJob"><a href="#submitJob" class="headerlink" title="submitJob"></a>submitJob</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">submitJob</span></span>[<span class="type">T</span>, <span class="type">U</span>](</span><br><span class="line">    rdd: <span class="type">RDD</span>[<span class="type">T</span>],</span><br><span class="line">    func: (<span class="type">TaskContext</span>, <span class="type">Iterator</span>[<span class="type">T</span>]) =&gt; <span class="type">U</span>,</span><br><span class="line">    partitions: <span class="type">Seq</span>[<span class="type">Int</span>],</span><br><span class="line">    callSite: <span class="type">CallSite</span>,</span><br><span class="line">    resultHandler: (<span class="type">Int</span>, <span class="type">U</span>) =&gt; <span class="type">Unit</span>,</span><br><span class="line">    properties: <span class="type">Properties</span>): <span class="type">JobWaiter</span>[<span class="type">U</span>] = &#123;</span><br><span class="line">  <span class="comment">// Check to make sure we are not launching a task on a partition that does not exist.</span></span><br><span class="line">  <span class="keyword">val</span> maxPartitions = rdd.partitions.length</span><br><span class="line">  partitions.find(p =&gt; p &gt;= maxPartitions || p &lt; <span class="number">0</span>).foreach &#123; p =&gt;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IllegalArgumentException</span>(</span><br><span class="line">      <span class="string">"Attempting to access a non-existent partition: "</span> + p + <span class="string">". "</span> +</span><br><span class="line">        <span class="string">"Total number of partitions: "</span> + maxPartitions)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> jobId = nextJobId.getAndIncrement()</span><br><span class="line">  <span class="keyword">if</span> (partitions.size == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// Return immediately if the job is running 0 tasks</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">JobWaiter</span>[<span class="type">U</span>](<span class="keyword">this</span>, jobId, <span class="number">0</span>, resultHandler)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  assert(partitions.size &gt; <span class="number">0</span>)</span><br><span class="line">  <span class="keyword">val</span> func2 = func.asInstanceOf[(<span class="type">TaskContext</span>, <span class="type">Iterator</span>[_]) =&gt; _]</span><br><span class="line">  <span class="keyword">val</span> waiter = <span class="keyword">new</span> <span class="type">JobWaiter</span>(<span class="keyword">this</span>, jobId, partitions.size, resultHandler)</span><br><span class="line">  eventProcessLoop.post(<span class="type">JobSubmitted</span>( <span class="comment">//post一个JobSubmitted事件</span></span><br><span class="line">    jobId, rdd, func2, partitions.toArray, callSite, waiter,</span><br><span class="line">    <span class="type">SerializationUtils</span>.clone(properties)))</span><br><span class="line">  waiter</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="eventProcessLoop"><a href="#eventProcessLoop" class="headerlink" title="eventProcessLoop"></a>eventProcessLoop</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>[scheduler] <span class="keyword">val</span> eventProcessLoop = <span class="keyword">new</span> <span class="type">DAGSchedulerEventProcessLoop</span>(<span class="keyword">this</span>) </span><br><span class="line">taskScheduler.setDAGScheduler(<span class="keyword">this</span>)</span><br></pre></td></tr></table></figure>

<h3 id="DAGSchedulerEventProcessLoop"><a href="#DAGSchedulerEventProcessLoop" class="headerlink" title="DAGSchedulerEventProcessLoop"></a>DAGSchedulerEventProcessLoop</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>[scheduler] <span class="class"><span class="keyword">class</span> <span class="title">DAGSchedulerEventProcessLoop</span>(<span class="params">dagScheduler: <span class="type">DAGScheduler</span></span>)</span></span><br><span class="line"><span class="class">  <span class="keyword">extends</span> <span class="title">EventLoop</span>[<span class="type">DAGSchedulerEvent</span>](<span class="params">"dag-scheduler-event-loop"</span>) <span class="keyword">with</span> <span class="title">Logging</span> </span>&#123; <span class="comment">//点击EventLoop</span></span><br><span class="line"></span><br><span class="line">....</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="EventLoop"><a href="#EventLoop" class="headerlink" title="EventLoop"></a>EventLoop</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>[spark] <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">EventLoop</span>[<span class="type">E</span>](<span class="params">name: <span class="type">String</span></span>) <span class="keyword">extends</span> <span class="title">Logging</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> eventQueue: <span class="type">BlockingQueue</span>[<span class="type">E</span>] = <span class="keyword">new</span> <span class="type">LinkedBlockingDeque</span>[<span class="type">E</span>]() <span class="comment">//阻塞队列</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> stopped = <span class="keyword">new</span> <span class="type">AtomicBoolean</span>(<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> eventThread = <span class="keyword">new</span> <span class="type">Thread</span>(name) &#123;</span><br><span class="line">    setDaemon(<span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>(): <span class="type">Unit</span> = &#123; <span class="comment">//run方法</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (!stopped.get) &#123;</span><br><span class="line">          <span class="keyword">val</span> event = eventQueue.take() <span class="comment">//循环读取队列</span></span><br><span class="line">          <span class="keyword">try</span> &#123; <span class="comment">//读到序列</span></span><br><span class="line">            onReceive(event)  <span class="comment">//开启</span></span><br><span class="line">          &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="type">NonFatal</span>(e) =&gt;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                onError(e)</span><br><span class="line">              &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="type">NonFatal</span>(e) =&gt; logError(<span class="string">"Unexpected error in "</span> + name, e)</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> ie: <span class="type">InterruptedException</span> =&gt; <span class="comment">// exit even if eventQueue is not empty</span></span><br><span class="line">        <span class="keyword">case</span> <span class="type">NonFatal</span>(e) =&gt; logError(<span class="string">"Unexpected error in "</span> + name, e)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">....</span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">def</span> <span class="title">onReceive</span></span>(event: <span class="type">E</span>): <span class="type">Unit</span>  <span class="comment">//抽象方法</span></span><br></pre></td></tr></table></figure>

<h3 id="回到DAGSchedulerEventProcessLoop"><a href="#回到DAGSchedulerEventProcessLoop" class="headerlink" title="回到DAGSchedulerEventProcessLoop"></a>回到DAGSchedulerEventProcessLoop</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">onReceive</span></span>(event: <span class="type">DAGSchedulerEvent</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> timerContext = timer.time()</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      doOnReceive(event)</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      timerContext.stop()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;  </span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">doOnReceive</span></span>(event: <span class="type">DAGSchedulerEvent</span>): <span class="type">Unit</span> = event <span class="keyword">match</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">JobSubmitted</span>(jobId, rdd, func, partitions, callSite, listener, properties) =&gt;</span><br><span class="line">      dagScheduler.handleJobSubmitted(jobId, rdd, func, partitions, callSite, listener, properties)  <span class="comment">//我们关住一下handleJobSubmitted</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="type">MapStageSubmitted</span>(jobId, dependency, callSite, listener, properties) =&gt;</span><br><span class="line">      dagScheduler.handleMapStageSubmitted(jobId, dependency, callSite, listener, properties)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="type">StageCancelled</span>(stageId) =&gt;</span><br><span class="line">      dagScheduler.handleStageCancellation(stageId)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="type">JobCancelled</span>(jobId) =&gt;</span><br><span class="line">      dagScheduler.handleJobCancellation(jobId)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="type">JobGroupCancelled</span>(groupId) =&gt;</span><br><span class="line">      dagScheduler.handleJobGroupCancelled(groupId)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="type">AllJobsCancelled</span> =&gt;</span><br><span class="line">      dagScheduler.doCancelAllJobs()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="type">ExecutorAdded</span>(execId, host) =&gt;</span><br><span class="line">      dagScheduler.handleExecutorAdded(execId, host)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="type">ExecutorLost</span>(execId, reason) =&gt;</span><br><span class="line">      <span class="keyword">val</span> filesLost = reason <span class="keyword">match</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">SlaveLost</span>(_, <span class="literal">true</span>) =&gt; <span class="literal">true</span></span><br><span class="line">        <span class="keyword">case</span> _ =&gt; <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">      dagScheduler.handleExecutorLost(execId, filesLost)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="type">BeginEvent</span>(task, taskInfo) =&gt;</span><br><span class="line">      dagScheduler.handleBeginEvent(task, taskInfo)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="type">GettingResultEvent</span>(taskInfo) =&gt;</span><br><span class="line">      dagScheduler.handleGetTaskResult(taskInfo)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> completion: <span class="type">CompletionEvent</span> =&gt;</span><br><span class="line">      dagScheduler.handleTaskCompletion(completion)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="type">TaskSetFailed</span>(taskSet, reason, exception) =&gt;</span><br><span class="line">      dagScheduler.handleTaskSetFailed(taskSet, reason, exception)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="type">ResubmitFailedStages</span> =&gt;</span><br><span class="line">      dagScheduler.resubmitFailedStages()</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="handleJobSubmitted"><a href="#handleJobSubmitted" class="headerlink" title="handleJobSubmitted"></a>handleJobSubmitted</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>[scheduler] <span class="function"><span class="keyword">def</span> <span class="title">handleJobSubmitted</span></span>(jobId: <span class="type">Int</span>,</span><br><span class="line">    finalRDD: <span class="type">RDD</span>[_],</span><br><span class="line">    func: (<span class="type">TaskContext</span>, <span class="type">Iterator</span>[_]) =&gt; _,</span><br><span class="line">    partitions: <span class="type">Array</span>[<span class="type">Int</span>],</span><br><span class="line">    callSite: <span class="type">CallSite</span>,</span><br><span class="line">    listener: <span class="type">JobListener</span>,</span><br><span class="line">    properties: <span class="type">Properties</span>) &#123;</span><br><span class="line">    <span class="comment">//一下代码是如何将代码拆分成一个个stage 再把</span></span><br><span class="line">  <span class="keyword">var</span> finalStage: <span class="type">ResultStage</span> = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// New stage creation may throw an exception if, for example, jobs are run on a</span></span><br><span class="line">    <span class="comment">// HadoopRDD whose underlying HDFS files have been deleted.</span></span><br><span class="line"></span><br><span class="line">    finalStage = createResultStage(finalRDD, func, partitions, jobId, callSite)</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> e: <span class="type">Exception</span> =&gt;</span><br><span class="line">      logWarning(<span class="string">"Creating new stage failed due to exception - job: "</span> + jobId, e)</span><br><span class="line">      listener.jobFailed(e)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> job = <span class="keyword">new</span> <span class="type">ActiveJob</span>(jobId, finalStage, callSite, listener, properties)</span><br><span class="line">  clearCacheLocs()</span><br><span class="line">  logInfo(<span class="string">"Got job %s (%s) with %d output partitions"</span>.format(</span><br><span class="line">    job.jobId, callSite.shortForm, partitions.length))</span><br><span class="line">  logInfo(<span class="string">"Final stage: "</span> + finalStage + <span class="string">" ("</span> + finalStage.name + <span class="string">")"</span>)</span><br><span class="line">  logInfo(<span class="string">"Parents of final stage: "</span> + finalStage.parents)</span><br><span class="line">  logInfo(<span class="string">"Missing parents: "</span> + getMissingParentStages(finalStage))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> jobSubmissionTime = clock.getTimeMillis()</span><br><span class="line">  jobIdToActiveJob(jobId) = job</span><br><span class="line">  activeJobs += job</span><br><span class="line">  finalStage.setActiveJob(job)</span><br><span class="line">  <span class="keyword">val</span> stageIds = jobIdToStageIds(jobId).toArray</span><br><span class="line">  <span class="keyword">val</span> stageInfos = stageIds.flatMap(id =&gt; stageIdToStage.get(id).map(_.latestInfo))</span><br><span class="line">  listenerBus.post(</span><br><span class="line">    <span class="type">SparkListenerJobStart</span>(job.jobId, jobSubmissionTime, stageInfos, properties))</span><br><span class="line">    <span class="comment">//最后提交了submitStage</span></span><br><span class="line">  submitStage(finalStage)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="submitStage"><a href="#submitStage" class="headerlink" title="submitStage"></a>submitStage</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Submits stage, but first recursively submits any missing parents. */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">submitStage</span></span>(stage: <span class="type">Stage</span>) &#123;</span><br><span class="line">  <span class="keyword">val</span> jobId = activeJobForStage(stage)</span><br><span class="line">  <span class="keyword">if</span> (jobId.isDefined) &#123;</span><br><span class="line">    logDebug(<span class="string">"submitStage("</span> + stage + <span class="string">")"</span>)</span><br><span class="line">    <span class="keyword">if</span> (!waitingStages(stage) &amp;&amp; !runningStages(stage) &amp;&amp; !failedStages(stage)) &#123;</span><br><span class="line">        <span class="comment">//stage是从后往前划分</span></span><br><span class="line">      <span class="keyword">val</span> missing = getMissingParentStages(stage).sortBy(_.id)</span><br><span class="line">      logDebug(<span class="string">"missing: "</span> + missing)</span><br><span class="line">      <span class="keyword">if</span> (missing.isEmpty) &#123; </span><br><span class="line">        logInfo(<span class="string">"Submitting "</span> + stage + <span class="string">" ("</span> + stage.rdd + <span class="string">"), which has no missing parents"</span>)</span><br><span class="line">        submitMissingTasks(stage, jobId.get)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123; <span class="comment">//如果获得了missing 我们卡产一下是怎么处理的</span></span><br><span class="line">        <span class="keyword">for</span> (parent &lt;- missing) &#123;</span><br><span class="line">          submitStage(parent)</span><br><span class="line">        &#125;</span><br><span class="line">        waitingStages += stage</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    abortStage(stage, <span class="string">"No active job for stage "</span> + stage.id, <span class="type">None</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="getMissingParentStages"><a href="#getMissingParentStages" class="headerlink" title="getMissingParentStages"></a>getMissingParentStages</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">getMissingParentStages</span></span>(stage: <span class="type">Stage</span>): <span class="type">List</span>[<span class="type">Stage</span>] = &#123;</span><br><span class="line">  <span class="keyword">val</span> missing = <span class="keyword">new</span> <span class="type">HashSet</span>[<span class="type">Stage</span>]</span><br><span class="line">  <span class="keyword">val</span> visited = <span class="keyword">new</span> <span class="type">HashSet</span>[<span class="type">RDD</span>[_]]</span><br><span class="line">  <span class="comment">// We are manually maintaining a stack here to prevent StackOverflowError</span></span><br><span class="line">  <span class="comment">// caused by recursively visiting</span></span><br><span class="line">  <span class="keyword">val</span> waitingForVisit = <span class="keyword">new</span> <span class="type">Stack</span>[<span class="type">RDD</span>[_]] <span class="comment">//栈结构的 这是为什么Stage划分从后往前 压栈执行</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">visit</span></span>(rdd: <span class="type">RDD</span>[_]) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!visited(rdd)) &#123;</span><br><span class="line">      visited += rdd</span><br><span class="line">      <span class="keyword">val</span> rddHasUncachedPartitions = getCacheLocs(rdd).contains(<span class="type">Nil</span>)</span><br><span class="line">      <span class="keyword">if</span> (rddHasUncachedPartitions) &#123;</span><br><span class="line">        <span class="keyword">for</span> (dep &lt;- rdd.dependencies) &#123;</span><br><span class="line">          dep <span class="keyword">match</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> shufDep: <span class="type">ShuffleDependency</span>[_, _, _] =&gt; <span class="comment">//如果是 宽依赖</span></span><br><span class="line">              <span class="keyword">val</span> mapStage = getOrCreateShuffleMapStage(shufDep, stage.firstJobId)</span><br><span class="line">              <span class="keyword">if</span> (!mapStage.isAvailable) &#123; </span><br><span class="line">                missing += mapStage</span><br><span class="line">              &#125;</span><br><span class="line">            <span class="keyword">case</span> narrowDep: <span class="type">NarrowDependency</span>[_] =&gt; <span class="comment">//如果是窄依赖</span></span><br><span class="line">              waitingForVisit.push(narrowDep.rdd)  <span class="comment">//主要是填充stage</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  waitingForVisit.push(stage.rdd)</span><br><span class="line">  <span class="keyword">while</span> (waitingForVisit.nonEmpty) &#123;</span><br><span class="line">    visit(waitingForVisit.pop())</span><br><span class="line">  &#125;</span><br><span class="line">  missing.toList</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="submitStage-1"><a href="#submitStage-1" class="headerlink" title="submitStage"></a>submitStage</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Submits stage, but first recursively submits any missing parents. */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">submitStage</span></span>(stage: <span class="type">Stage</span>) &#123;</span><br><span class="line">  <span class="keyword">val</span> jobId = activeJobForStage(stage)</span><br><span class="line">  <span class="keyword">if</span> (jobId.isDefined) &#123;</span><br><span class="line">    logDebug(<span class="string">"submitStage("</span> + stage + <span class="string">")"</span>) </span><br><span class="line">    <span class="keyword">if</span> (!waitingStages(stage) &amp;&amp; !runningStages(stage) &amp;&amp; !failedStages(stage)) &#123;</span><br><span class="line">      <span class="keyword">val</span> missing = getMissingParentStages(stage).sortBy(_.id)</span><br><span class="line">      logDebug(<span class="string">"missing: "</span> + missing) </span><br><span class="line">      <span class="keyword">if</span> (missing.isEmpty) &#123; </span><br><span class="line">        logInfo(<span class="string">"Submitting "</span> + stage + <span class="string">" ("</span> + stage.rdd + <span class="string">"), which has no missing parents"</span>)</span><br><span class="line">        submitMissingTasks(stage, jobId.get)<span class="comment">//递归调用</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (parent &lt;- missing) &#123;</span><br><span class="line">          submitStage(parent) <span class="comment">//递归</span></span><br><span class="line">        &#125;</span><br><span class="line">        waitingStages += stage</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    abortStage(stage, <span class="string">"No active job for stage "</span> + stage.id, <span class="type">None</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="submitMissingTasks"><a href="#submitMissingTasks" class="headerlink" title="submitMissingTasks"></a>submitMissingTasks</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Called when stage's parents are available and we can now do its task. */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">submitMissingTasks</span></span>(stage: <span class="type">Stage</span>, jobId: <span class="type">Int</span>) &#123;</span><br><span class="line">  logDebug(<span class="string">"submitMissingTasks("</span> + stage + <span class="string">")"</span>)</span><br><span class="line">  <span class="comment">// Get our pending tasks and remember them in our pendingTasks entry</span></span><br><span class="line">  stage.pendingPartitions.clear()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// First figure out the indexes of partition ids to compute.</span></span><br><span class="line">  <span class="keyword">val</span> partitionsToCompute: <span class="type">Seq</span>[<span class="type">Int</span>] = stage.findMissingPartitions()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Use the scheduling pool, job group, description, etc. from an ActiveJob associated</span></span><br><span class="line">  <span class="comment">// with this Stage</span></span><br><span class="line">  <span class="keyword">val</span> properties = jobIdToActiveJob(jobId).properties</span><br><span class="line"></span><br><span class="line">  runningStages += stage</span><br><span class="line">  <span class="comment">// SparkListenerStageSubmitted should be posted before testing whether tasks are</span></span><br><span class="line">  <span class="comment">// serializable. If tasks are not serializable, a SparkListenerStageCompleted event</span></span><br><span class="line">  <span class="comment">// will be posted, which should always come after a corresponding SparkListenerStageSubmitted</span></span><br><span class="line">  <span class="comment">// event.</span></span><br><span class="line">  stage <span class="keyword">match</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> s: <span class="type">ShuffleMapStage</span> =&gt;</span><br><span class="line">      outputCommitCoordinator.stageStart(stage = s.id, maxPartitionId = s.numPartitions - <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">case</span> s: <span class="type">ResultStage</span> =&gt;</span><br><span class="line">      outputCommitCoordinator.stageStart(</span><br><span class="line">        stage = s.id, maxPartitionId = s.rdd.partitions.length - <span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">val</span> taskIdToLocations: <span class="type">Map</span>[<span class="type">Int</span>, <span class="type">Seq</span>[<span class="type">TaskLocation</span>]] = <span class="keyword">try</span> &#123;</span><br><span class="line">    stage <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> s: <span class="type">ShuffleMapStage</span> =&gt;</span><br><span class="line">        partitionsToCompute.map &#123; id =&gt; (id, getPreferredLocs(stage.rdd, id))&#125;.toMap</span><br><span class="line">      <span class="keyword">case</span> s: <span class="type">ResultStage</span> =&gt;</span><br><span class="line">        partitionsToCompute.map &#123; id =&gt;</span><br><span class="line">          <span class="keyword">val</span> p = s.partitions(id)</span><br><span class="line">          (id, getPreferredLocs(stage.rdd, p))</span><br><span class="line">        &#125;.toMap</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">NonFatal</span>(e) =&gt;</span><br><span class="line">      stage.makeNewStageAttempt(partitionsToCompute.size)</span><br><span class="line">      listenerBus.post(<span class="type">SparkListenerStageSubmitted</span>(stage.latestInfo, properties))</span><br><span class="line">      abortStage(stage, <span class="string">s"Task creation failed: <span class="subst">$e</span>\n<span class="subst">$&#123;Utils.exceptionString(e)&#125;</span>"</span>, <span class="type">Some</span>(e))</span><br><span class="line">      runningStages -= stage</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stage.makeNewStageAttempt(partitionsToCompute.size, taskIdToLocations.values.toSeq)</span><br><span class="line">  listenerBus.post(<span class="type">SparkListenerStageSubmitted</span>(stage.latestInfo, properties))</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Maybe we can keep the taskBinary in Stage to avoid serializing it multiple times.</span></span><br><span class="line">  <span class="comment">// Broadcasted binary for the task, used to dispatch tasks to executors. Note that we broadcast</span></span><br><span class="line">  <span class="comment">// the serialized copy of the RDD and for each task we will deserialize it, which means each</span></span><br><span class="line">  <span class="comment">// task gets a different copy of the RDD. This provides stronger isolation between tasks that</span></span><br><span class="line">  <span class="comment">// might modify state of objects referenced in their closures. This is necessary in Hadoop</span></span><br><span class="line">  <span class="comment">// where the JobConf/Configuration object is not thread-safe.</span></span><br><span class="line">  <span class="keyword">var</span> taskBinary: <span class="type">Broadcast</span>[<span class="type">Array</span>[<span class="type">Byte</span>]] = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// For ShuffleMapTask, serialize and broadcast (rdd, shuffleDep).</span></span><br><span class="line">    <span class="comment">// For ResultTask, serialize and broadcast (rdd, func).</span></span><br><span class="line">    <span class="keyword">val</span> taskBinaryBytes: <span class="type">Array</span>[<span class="type">Byte</span>] = stage <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> stage: <span class="type">ShuffleMapStage</span> =&gt;</span><br><span class="line">        <span class="type">JavaUtils</span>.bufferToArray(</span><br><span class="line">          closureSerializer.serialize((stage.rdd, stage.shuffleDep): <span class="type">AnyRef</span>))</span><br><span class="line">      <span class="keyword">case</span> stage: <span class="type">ResultStage</span> =&gt;</span><br><span class="line">        <span class="type">JavaUtils</span>.bufferToArray(closureSerializer.serialize((stage.rdd, stage.func): <span class="type">AnyRef</span>))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    taskBinary = sc.broadcast(taskBinaryBytes)</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="comment">// In the case of a failure during serialization, abort the stage.</span></span><br><span class="line">    <span class="keyword">case</span> e: <span class="type">NotSerializableException</span> =&gt;</span><br><span class="line">      abortStage(stage, <span class="string">"Task not serializable: "</span> + e.toString, <span class="type">Some</span>(e))</span><br><span class="line">      runningStages -= stage</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Abort execution</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">NonFatal</span>(e) =&gt;</span><br><span class="line">      abortStage(stage, <span class="string">s"Task serialization failed: <span class="subst">$e</span>\n<span class="subst">$&#123;Utils.exceptionString(e)&#125;</span>"</span>, <span class="type">Some</span>(e))</span><br><span class="line">      runningStages -= stage</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> tasks: <span class="type">Seq</span>[<span class="type">Task</span>[_]] = <span class="keyword">try</span> &#123;  <span class="comment">//转换成一系列Task任务</span></span><br><span class="line">    stage <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> stage: <span class="type">ShuffleMapStage</span> =&gt;</span><br><span class="line">        partitionsToCompute.map &#123; id =&gt;</span><br><span class="line">          <span class="keyword">val</span> locs = taskIdToLocations(id)</span><br><span class="line">          <span class="keyword">val</span> part = stage.rdd.partitions(id)</span><br><span class="line">          <span class="keyword">new</span> <span class="type">ShuffleMapTask</span>(stage.id, stage.latestInfo.attemptId,</span><br><span class="line">            taskBinary, part, locs, stage.latestInfo.taskMetrics, properties, <span class="type">Option</span>(jobId),</span><br><span class="line">            <span class="type">Option</span>(sc.applicationId), sc.applicationAttemptId)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> stage: <span class="type">ResultStage</span> =&gt;</span><br><span class="line">        partitionsToCompute.map &#123; id =&gt;</span><br><span class="line">          <span class="keyword">val</span> p: <span class="type">Int</span> = stage.partitions(id)</span><br><span class="line">          <span class="keyword">val</span> part = stage.rdd.partitions(p)</span><br><span class="line">          <span class="keyword">val</span> locs = taskIdToLocations(id)</span><br><span class="line">          <span class="keyword">new</span> <span class="type">ResultTask</span>(stage.id, stage.latestInfo.attemptId,</span><br><span class="line">            taskBinary, part, locs, id, properties, stage.latestInfo.taskMetrics,</span><br><span class="line">            <span class="type">Option</span>(jobId), <span class="type">Option</span>(sc.applicationId), sc.applicationAttemptId)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">NonFatal</span>(e) =&gt;</span><br><span class="line">      abortStage(stage, <span class="string">s"Task creation failed: <span class="subst">$e</span>\n<span class="subst">$&#123;Utils.exceptionString(e)&#125;</span>"</span>, <span class="type">Some</span>(e))</span><br><span class="line">      runningStages -= stage</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (tasks.size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    logInfo(<span class="string">"Submitting "</span> + tasks.size + <span class="string">" missing tasks from "</span> + stage + <span class="string">" ("</span> + stage.rdd + <span class="string">")"</span>)</span><br><span class="line">    stage.pendingPartitions ++= tasks.map(_.partitionId)</span><br><span class="line">    logDebug(<span class="string">"New pending partitions: "</span> + stage.pendingPartitions)</span><br><span class="line">    taskScheduler.submitTasks(<span class="keyword">new</span> <span class="type">TaskSet</span>( <span class="comment">//提交我们的任务,把我们所有的的任务封装成了一个对象</span></span><br><span class="line">      tasks.toArray, stage.id, stage.latestInfo.attemptId, jobId, properties))</span><br><span class="line">    stage.latestInfo.submissionTime = <span class="type">Some</span>(clock.getTimeMillis())</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Because we posted SparkListenerStageSubmitted earlier, we should mark</span></span><br><span class="line">    <span class="comment">// the stage as completed here in case there are no tasks to run</span></span><br><span class="line">    markStageAsFinished(stage, <span class="type">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> debugString = stage <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> stage: <span class="type">ShuffleMapStage</span> =&gt;</span><br><span class="line">        <span class="string">s"Stage <span class="subst">$&#123;stage&#125;</span> is actually done; "</span> +</span><br><span class="line">          <span class="string">s"(available: <span class="subst">$&#123;stage.isAvailable&#125;</span>,"</span> +</span><br><span class="line">          <span class="string">s"available outputs: <span class="subst">$&#123;stage.numAvailableOutputs&#125;</span>,"</span> +</span><br><span class="line">          <span class="string">s"partitions: <span class="subst">$&#123;stage.numPartitions&#125;</span>)"</span></span><br><span class="line">      <span class="keyword">case</span> stage : <span class="type">ResultStage</span> =&gt;</span><br><span class="line">        <span class="string">s"Stage <span class="subst">$&#123;stage&#125;</span> is actually done; (partitions: <span class="subst">$&#123;stage.numPartitions&#125;</span>)"</span></span><br><span class="line">    &#125;</span><br><span class="line">    logDebug(debugString)</span><br><span class="line"></span><br><span class="line">    submitWaitingChildStages(stage)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="submitTasks"><a href="#submitTasks" class="headerlink" title="submitTasks"></a>submitTasks</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">submitTasks</span></span>(taskSet: <span class="type">TaskSet</span>): <span class="type">Unit</span></span><br></pre></td></tr></table></figure>

<p><img src="https://hphimages-1253879422.cos.ap-beijing.myqcloud.com/%E5%A4%A7%E6%95%B0%E6%8D%AE/Spark/%E5%86%85%E6%A0%B8/20190611230725.png" alt=""></p>
<p>找到实现类</p>
<h3 id="跳转TaskSchedulerImpl"><a href="#跳转TaskSchedulerImpl" class="headerlink" title="跳转TaskSchedulerImpl"></a>跳转TaskSchedulerImpl</h3><h3 id="submitTasks-1"><a href="#submitTasks-1" class="headerlink" title="submitTasks"></a>submitTasks</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">submitTasks</span></span>(taskSet: <span class="type">TaskSet</span>) &#123;</span><br><span class="line">  <span class="keyword">val</span> tasks = taskSet.tasks</span><br><span class="line">  logInfo(<span class="string">"Adding task set "</span> + taskSet.id + <span class="string">" with "</span> + tasks.length + <span class="string">" tasks"</span>)</span><br><span class="line">  <span class="keyword">this</span>.synchronized &#123;  <span class="comment">//同步</span></span><br><span class="line">    <span class="keyword">val</span> manager = createTaskSetManager(taskSet, maxTaskFailures)</span><br><span class="line">    <span class="keyword">val</span> stage = taskSet.stageId</span><br><span class="line">    <span class="keyword">val</span> stageTaskSets =</span><br><span class="line">      taskSetsByStageIdAndAttempt.getOrElseUpdate(stage, <span class="keyword">new</span> <span class="type">HashMap</span>[<span class="type">Int</span>, <span class="type">TaskSetManager</span>])</span><br><span class="line">    stageTaskSets(taskSet.stageAttemptId) = manager</span><br><span class="line">    <span class="keyword">val</span> conflictingTaskSet = stageTaskSets.exists &#123; <span class="keyword">case</span> (_, ts) =&gt;</span><br><span class="line">      ts.taskSet != taskSet &amp;&amp; !ts.isZombie</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (conflictingTaskSet) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IllegalStateException</span>(<span class="string">s"more than one active taskSet for stage <span class="subst">$stage</span>:"</span> +</span><br><span class="line">        <span class="string">s" <span class="subst">$&#123;stageTaskSets.toSeq.map&#123;_._2.taskSet.id&#125;</span>.mkString("</span>,<span class="string">")&#125;"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    schedulableBuilder.addTaskSetManager(manager, manager.taskSet.properties)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isLocal &amp;&amp; !hasReceivedTask) &#123;</span><br><span class="line">      starvationTimer.scheduleAtFixedRate(<span class="keyword">new</span> <span class="type">TimerTask</span>() &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>() &#123;</span><br><span class="line">          <span class="keyword">if</span> (!hasLaunchedTask) &#123;</span><br><span class="line">            logWarning(<span class="string">"Initial job has not accepted any resources; "</span> +</span><br><span class="line">              <span class="string">"check your cluster UI to ensure that workers are registered "</span> +</span><br><span class="line">              <span class="string">"and have sufficient resources"</span>)</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.cancel()</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, <span class="type">STARVATION_TIMEOUT_MS</span>, <span class="type">STARVATION_TIMEOUT_MS</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    hasReceivedTask = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  backend.reviveOffers() <span class="comment">//这个backend再StandaloneSchedulerBackend出现过</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在tandaloneSchedulerBackend没有找到.我们去<code>CoarseGrainedSchedulerBackend</code>中寻找一下</p>
<h3 id="回到CoarseGrainedSchedulerBackend"><a href="#回到CoarseGrainedSchedulerBackend" class="headerlink" title="回到CoarseGrainedSchedulerBackend"></a>回到CoarseGrainedSchedulerBackend</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="type">ReviveOffers</span> =&gt;</span><br><span class="line">        makeOffers() <span class="comment">//跳转到</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">reviveOffers</span></span>() &#123;</span><br><span class="line">    driverEndpoint.send(<span class="type">ReviveOffers</span>) <span class="comment">//</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="makeOffers"><a href="#makeOffers" class="headerlink" title="makeOffers"></a>makeOffers</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Make fake resource offers on all executors</span></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">makeOffers</span></span>() &#123;</span><br><span class="line">    <span class="comment">// Filter out executors under killing</span></span><br><span class="line">    <span class="keyword">val</span> activeExecutors = executorDataMap.filterKeys(executorIsAlive)</span><br><span class="line">    <span class="keyword">val</span> workOffers = activeExecutors.map &#123; <span class="keyword">case</span> (id, executorData) =&gt;</span><br><span class="line">      <span class="keyword">new</span> <span class="type">WorkerOffer</span>(id, executorData.executorHost, executorData.freeCores)</span><br><span class="line">    &#125;.toIndexedSeq</span><br><span class="line">    launchTasks(scheduler.resourceOffers(workOffers <span class="comment">//运行任务 申请资源  resourceOffers 具体做关键资源</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="跳转TaskSchedulerImpl-1"><a href="#跳转TaskSchedulerImpl-1" class="headerlink" title="跳转TaskSchedulerImpl"></a>跳转TaskSchedulerImpl</h3><h3 id="resourceOffers"><a href="#resourceOffers" class="headerlink" title="resourceOffers"></a>resourceOffers</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called by cluster manager to offer resources on slaves. We respond by asking our active task</span></span><br><span class="line"><span class="comment">   * sets for tasks in order of priority. We fill each node with tasks in a round-robin manner so</span></span><br><span class="line"><span class="comment">   * that tasks are balanced across the cluster.</span></span><br><span class="line"><span class="comment">   */</span>  </span><br><span class="line"><span class="comment">//  该类具体做具体的资源分配</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">resourceOffers</span></span>(offers: <span class="type">IndexedSeq</span>[<span class="type">WorkerOffer</span>]): <span class="type">Seq</span>[<span class="type">Seq</span>[<span class="type">TaskDescription</span>]] = synchronized &#123;</span><br><span class="line">    <span class="comment">// Mark each slave as alive and remember its hostname</span></span><br><span class="line">    <span class="comment">// Also track if new executor is added</span></span><br><span class="line">    <span class="keyword">var</span> newExecAvail = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">for</span> (o &lt;- offers) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!hostToExecutors.contains(o.host)) &#123;</span><br><span class="line">        hostToExecutors(o.host) = <span class="keyword">new</span> <span class="type">HashSet</span>[<span class="type">String</span>]()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!executorIdToRunningTaskIds.contains(o.executorId)) &#123;</span><br><span class="line">        hostToExecutors(o.host) += o.executorId</span><br><span class="line">        executorAdded(o.executorId, o.host)</span><br><span class="line">        executorIdToHost(o.executorId) = o.host</span><br><span class="line">        executorIdToRunningTaskIds(o.executorId) = <span class="type">HashSet</span>[<span class="type">Long</span>]()</span><br><span class="line">        newExecAvail = <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (rack &lt;- getRackForHost(o.host)) &#123;</span><br><span class="line">        hostsByRack.getOrElseUpdate(rack, <span class="keyword">new</span> <span class="type">HashSet</span>[<span class="type">String</span>]()) += o.host</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Randomly shuffle offers to avoid always placing tasks on the same set of workers.</span></span><br><span class="line">    <span class="keyword">val</span> shuffledOffers = <span class="type">Random</span>.shuffle(offers)</span><br><span class="line">    <span class="comment">// Build a list of tasks to assign to each worker.</span></span><br><span class="line">    <span class="keyword">val</span> tasks = shuffledOffers.map(o =&gt; <span class="keyword">new</span> <span class="type">ArrayBuffer</span>[<span class="type">TaskDescription</span>](o.cores))</span><br><span class="line">    <span class="keyword">val</span> availableCpus = shuffledOffers.map(o =&gt; o.cores).toArray</span><br><span class="line">    <span class="keyword">val</span> sortedTaskSets = rootPool.getSortedTaskSetQueue</span><br><span class="line">    <span class="keyword">for</span> (taskSet &lt;- sortedTaskSets) &#123;</span><br><span class="line">      logDebug(<span class="string">"parentName: %s, name: %s, runningTasks: %s"</span>.format(</span><br><span class="line">        taskSet.parent.name, taskSet.name, taskSet.runningTasks))</span><br><span class="line">      <span class="keyword">if</span> (newExecAvail) &#123;</span><br><span class="line">        taskSet.executorAdded()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Take each TaskSet in our scheduling order, and then offer it each node in increasing order</span></span><br><span class="line">    <span class="comment">// of locality levels so that it gets a chance to launch local tasks on all of them.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> the preferredLocality order: PROCESS_LOCAL, NODE_LOCAL, NO_PREF, RACK_LOCAL, ANY</span></span><br><span class="line">    <span class="keyword">for</span> (taskSet &lt;- sortedTaskSets) &#123;</span><br><span class="line">      <span class="keyword">var</span> launchedAnyTask = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">var</span> launchedTaskAtCurrentMaxLocality = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">for</span> (currentMaxLocality &lt;- taskSet.myLocalityLevels) &#123;</span><br><span class="line">        do &#123;</span><br><span class="line">          launchedTaskAtCurrentMaxLocality = resourceOfferSingleTaskSet(</span><br><span class="line">            taskSet, currentMaxLocality, shuffledOffers, availableCpus, tasks)</span><br><span class="line">          launchedAnyTask |= launchedTaskAtCurrentMaxLocality</span><br><span class="line">        &#125; <span class="keyword">while</span> (launchedTaskAtCurrentMaxLocality)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!launchedAnyTask) &#123;</span><br><span class="line">        taskSet.abortIfCompletelyBlacklisted(hostToExecutors)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tasks.size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      hasLaunchedTask = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tasks</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="回到CoarseGrainedSchedulerBackend-1"><a href="#回到CoarseGrainedSchedulerBackend-1" class="headerlink" title="回到CoarseGrainedSchedulerBackend"></a>回到CoarseGrainedSchedulerBackend</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Launch tasks returned by a set of resource offers</span></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">launchTasks</span></span>(tasks: <span class="type">Seq</span>[<span class="type">Seq</span>[<span class="type">TaskDescription</span>]]) &#123;</span><br><span class="line">    <span class="keyword">for</span> (task &lt;- tasks.flatten) &#123;</span><br><span class="line">      <span class="keyword">val</span> serializedTask = ser.serialize(task)</span><br><span class="line">      <span class="keyword">if</span> (serializedTask.limit &gt;= maxRpcMessageSize) &#123;</span><br><span class="line">        scheduler.taskIdToTaskSetManager.get(task.taskId).foreach &#123; taskSetMgr =&gt;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> msg = <span class="string">"Serialized task %s:%d was %d bytes, which exceeds max allowed: "</span> +</span><br><span class="line">              <span class="string">"spark.rpc.message.maxSize (%d bytes). Consider increasing "</span> +</span><br><span class="line">              <span class="string">"spark.rpc.message.maxSize or using broadcast variables for large values."</span></span><br><span class="line">            msg = msg.format(task.taskId, task.index, serializedTask.limit, maxRpcMessageSize)</span><br><span class="line">            taskSetMgr.abort(msg)</span><br><span class="line">          &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> e: <span class="type">Exception</span> =&gt; logError(<span class="string">"Exception in error callback"</span>, e)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> executorData = executorDataMap(task.executorId)</span><br><span class="line">        executorData.freeCores -= scheduler.<span class="type">CPUS_PER_TASK</span></span><br><span class="line"></span><br><span class="line">        logDebug(<span class="string">s"Launching task <span class="subst">$&#123;task.taskId&#125;</span> on executor id: <span class="subst">$&#123;task.executorId&#125;</span> hostname: "</span> +</span><br><span class="line">          <span class="string">s"<span class="subst">$&#123;executorData.executorHost&#125;</span>."</span>)</span><br><span class="line"><span class="comment">//控制权转到CoarseGrainedExecutorBackend的LaunchTask</span></span><br><span class="line">        executorData.executorEndpoint.send(<span class="type">LaunchTask</span>(<span class="keyword">new</span> <span class="type">SerializableBuffer</span>(serializedTask)))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="跳转CoarseGrainedExecutorBackend"><a href="#跳转CoarseGrainedExecutorBackend" class="headerlink" title="跳转CoarseGrainedExecutorBackend"></a>跳转CoarseGrainedExecutorBackend</h3><h3 id="LaunchTask"><a href="#LaunchTask" class="headerlink" title="LaunchTask"></a>LaunchTask</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="type">LaunchTask</span>(data) =&gt;</span><br><span class="line">   <span class="keyword">if</span> (executor == <span class="literal">null</span>) &#123;</span><br><span class="line">     exitExecutor(<span class="number">1</span>, <span class="string">"Received LaunchTask command but executor was null"</span>)</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="keyword">val</span> taskDesc = ser.deserialize[<span class="type">TaskDescription</span>](data.value)</span><br><span class="line">     logInfo(<span class="string">"Got assigned task "</span> + taskDesc.taskId) <span class="comment">//调用executor的launchTask</span></span><br><span class="line">     executor.launchTask(<span class="keyword">this</span>, taskId = taskDesc.taskId, attemptNumber = taskDesc.attemptNumber,</span><br><span class="line">       taskDesc.name, taskDesc.serializedTask)</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="跳转到Executor"><a href="#跳转到Executor" class="headerlink" title="跳转到Executor"></a>跳转到Executor</h3><h3 id="launchTask"><a href="#launchTask" class="headerlink" title="launchTask"></a>launchTask</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">launchTask</span></span>(</span><br><span class="line">    context: <span class="type">ExecutorBackend</span>,</span><br><span class="line">    taskId: <span class="type">Long</span>,</span><br><span class="line">    attemptNumber: <span class="type">Int</span>,</span><br><span class="line">    taskName: <span class="type">String</span>,</span><br><span class="line">    serializedTask: <span class="type">ByteBuffer</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    		<span class="comment">//创建一个TaskRunner</span></span><br><span class="line">  <span class="keyword">val</span> tr = <span class="keyword">new</span> <span class="type">TaskRunner</span>(context, taskId = taskId, attemptNumber = attemptNumber, taskName,</span><br><span class="line">    serializedTask)</span><br><span class="line">  runningTasks.put(taskId, tr)</span><br><span class="line">  threadPool.execute(tr)  <span class="comment">//线程池 </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="TaskRunner"><a href="#TaskRunner" class="headerlink" title="TaskRunner"></a>TaskRunner</h3><p>我们关注一下run方法 上面的西线程池运行的是此处的润方法</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">    threadId = <span class="type">Thread</span>.currentThread.getId</span><br><span class="line">    <span class="type">Thread</span>.currentThread.setName(threadName)</span><br><span class="line">    <span class="keyword">val</span> threadMXBean = <span class="type">ManagementFactory</span>.getThreadMXBean</span><br><span class="line">    <span class="keyword">val</span> taskMemoryManager = <span class="keyword">new</span> <span class="type">TaskMemoryManager</span>(env.memoryManager, taskId)</span><br><span class="line">    <span class="keyword">val</span> deserializeStartTime = <span class="type">System</span>.currentTimeMillis()</span><br><span class="line">    <span class="keyword">val</span> deserializeStartCpuTime = <span class="keyword">if</span> (threadMXBean.isCurrentThreadCpuTimeSupported) &#123;</span><br><span class="line">      threadMXBean.getCurrentThreadCpuTime</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="number">0</span>L</span><br><span class="line">    <span class="type">Thread</span>.currentThread.setContextClassLoader(replClassLoader)</span><br><span class="line">    <span class="keyword">val</span> ser = env.closureSerializer.newInstance()</span><br><span class="line">    logInfo(<span class="string">s"Running <span class="subst">$taskName</span> (TID <span class="subst">$taskId</span>)"</span>)</span><br><span class="line">    execBackend.statusUpdate(taskId, <span class="type">TaskState</span>.<span class="type">RUNNING</span>, <span class="type">EMPTY_BYTE_BUFFER</span>)</span><br><span class="line">    <span class="keyword">var</span> taskStart: <span class="type">Long</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> taskStartCpu: <span class="type">Long</span> = <span class="number">0</span></span><br><span class="line">    startGCTime = computeTotalGcTime()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">val</span> (taskFiles, taskJars, taskProps, taskBytes) =</span><br><span class="line">        <span class="type">Task</span>.deserializeWithDependencies(serializedTask)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Must be set before updateDependencies() is called, in case fetching dependencies</span></span><br><span class="line">      <span class="comment">// requires access to properties contained within (e.g. for access control).</span></span><br><span class="line">      <span class="type">Executor</span>.taskDeserializationProps.set(taskProps)</span><br><span class="line"></span><br><span class="line">      updateDependencies(taskFiles, taskJars)</span><br><span class="line">      task = ser.deserialize[<span class="type">Task</span>[<span class="type">Any</span>]](taskBytes, <span class="type">Thread</span>.currentThread.getContextClassLoader)</span><br><span class="line">      task.localProperties = taskProps</span><br><span class="line">      task.setTaskMemoryManager(taskMemoryManager)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If this task has been killed before we deserialized it, let's quit now. Otherwise,</span></span><br><span class="line">      <span class="comment">// continue executing the task.</span></span><br><span class="line">      <span class="keyword">if</span> (killed) &#123;</span><br><span class="line">        <span class="comment">// Throw an exception rather than returning, because returning within a try&#123;&#125; block</span></span><br><span class="line">        <span class="comment">// causes a NonLocalReturnControl exception to be thrown. The NonLocalReturnControl</span></span><br><span class="line">        <span class="comment">// exception will be caught by the catch block, leading to an incorrect ExceptionFailure</span></span><br><span class="line">        <span class="comment">// for the task.</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">TaskKilledException</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      logDebug(<span class="string">"Task "</span> + taskId + <span class="string">"'s epoch is "</span> + task.epoch)</span><br><span class="line">      env.mapOutputTracker.updateEpoch(task.epoch)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Run the actual task and measure its runtime.</span></span><br><span class="line">      taskStart = <span class="type">System</span>.currentTimeMillis()</span><br><span class="line">      taskStartCpu = <span class="keyword">if</span> (threadMXBean.isCurrentThreadCpuTimeSupported) &#123;</span><br><span class="line">        threadMXBean.getCurrentThreadCpuTime</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="number">0</span>L</span><br><span class="line">      <span class="keyword">var</span> threwException = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">val</span> value = <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> res = task.run(</span><br><span class="line">          taskAttemptId = taskId,</span><br><span class="line">          attemptNumber = attemptNumber,</span><br><span class="line">          metricsSystem = env.metricsSystem)</span><br><span class="line">        threwException = <span class="literal">false</span></span><br><span class="line">        res</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> releasedLocks = env.blockManager.releaseAllLocksForTask(taskId)</span><br><span class="line">        <span class="keyword">val</span> freedMemory = taskMemoryManager.cleanUpAllAllocatedMemory()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (freedMemory &gt; <span class="number">0</span> &amp;&amp; !threwException) &#123;</span><br><span class="line">          <span class="keyword">val</span> errMsg = <span class="string">s"Managed memory leak detected; size = <span class="subst">$freedMemory</span> bytes, TID = <span class="subst">$taskId</span>"</span></span><br><span class="line">          <span class="keyword">if</span> (conf.getBoolean(<span class="string">"spark.unsafe.exceptionOnMemoryLeak"</span>, <span class="literal">false</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">SparkException</span>(errMsg)</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logWarning(errMsg)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (releasedLocks.nonEmpty &amp;&amp; !threwException) &#123;</span><br><span class="line">          <span class="keyword">val</span> errMsg =</span><br><span class="line">            <span class="string">s"<span class="subst">$&#123;releasedLocks.size&#125;</span> block locks were not released by TID = <span class="subst">$taskId</span>:\n"</span> +</span><br><span class="line">              releasedLocks.mkString(<span class="string">"["</span>, <span class="string">", "</span>, <span class="string">"]"</span>)</span><br><span class="line">          <span class="keyword">if</span> (conf.getBoolean(<span class="string">"spark.storage.exceptionOnPinLeak"</span>, <span class="literal">false</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">SparkException</span>(errMsg)</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logWarning(errMsg)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">val</span> taskFinish = <span class="type">System</span>.currentTimeMillis()</span><br><span class="line">      <span class="keyword">val</span> taskFinishCpu = <span class="keyword">if</span> (threadMXBean.isCurrentThreadCpuTimeSupported) &#123;</span><br><span class="line">        threadMXBean.getCurrentThreadCpuTime</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="number">0</span>L</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If the task has been killed, let's fail it.</span></span><br><span class="line">      <span class="keyword">if</span> (task.killed) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">TaskKilledException</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">val</span> resultSer = env.serializer.newInstance()</span><br><span class="line">      <span class="keyword">val</span> beforeSerialization = <span class="type">System</span>.currentTimeMillis()</span><br><span class="line">      <span class="keyword">val</span> valueBytes = resultSer.serialize(value)</span><br><span class="line">      <span class="keyword">val</span> afterSerialization = <span class="type">System</span>.currentTimeMillis()</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Deserialization happens in two parts: first, we deserialize a Task object, which</span></span><br><span class="line">      <span class="comment">// includes the Partition. Second, Task.run() deserializes the RDD and function to be run.</span></span><br><span class="line">      task.metrics.setExecutorDeserializeTime(</span><br><span class="line">        (taskStart - deserializeStartTime) + task.executorDeserializeTime)</span><br><span class="line">      task.metrics.setExecutorDeserializeCpuTime(</span><br><span class="line">        (taskStartCpu - deserializeStartCpuTime) + task.executorDeserializeCpuTime)</span><br><span class="line">      <span class="comment">// We need to subtract Task.run()'s deserialization time to avoid double-counting</span></span><br><span class="line">      task.metrics.setExecutorRunTime((taskFinish - taskStart) - task.executorDeserializeTime)</span><br><span class="line">      task.metrics.setExecutorCpuTime(</span><br><span class="line">        (taskFinishCpu - taskStartCpu) - task.executorDeserializeCpuTime)</span><br><span class="line">      task.metrics.setJvmGCTime(computeTotalGcTime() - startGCTime)</span><br><span class="line">      task.metrics.setResultSerializationTime(afterSerialization - beforeSerialization)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Note: accumulator updates must be collected after TaskMetrics is updated</span></span><br><span class="line">      <span class="keyword">val</span> accumUpdates = task.collectAccumulatorUpdates()</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> do not serialize value twice</span></span><br><span class="line">      <span class="keyword">val</span> directResult = <span class="keyword">new</span> <span class="type">DirectTaskResult</span>(valueBytes, accumUpdates)</span><br><span class="line">      <span class="keyword">val</span> serializedDirectResult = ser.serialize(directResult)</span><br><span class="line">      <span class="keyword">val</span> resultSize = serializedDirectResult.limit</span><br><span class="line"></span><br><span class="line">      <span class="comment">// directSend = sending directly back to the driver</span></span><br><span class="line">      <span class="keyword">val</span> serializedResult: <span class="type">ByteBuffer</span> = &#123;</span><br><span class="line">        <span class="keyword">if</span> (maxResultSize &gt; <span class="number">0</span> &amp;&amp; resultSize &gt; maxResultSize) &#123;</span><br><span class="line">          logWarning(<span class="string">s"Finished <span class="subst">$taskName</span> (TID <span class="subst">$taskId</span>). Result is larger than maxResultSize "</span> +</span><br><span class="line">            <span class="string">s"(<span class="subst">$&#123;Utils.bytesToString(resultSize)&#125;</span> &gt; <span class="subst">$&#123;Utils.bytesToString(maxResultSize)&#125;</span>), "</span> +</span><br><span class="line">            <span class="string">s"dropping it."</span>)</span><br><span class="line">          ser.serialize(<span class="keyword">new</span> <span class="type">IndirectTaskResult</span>[<span class="type">Any</span>](<span class="type">TaskResultBlockId</span>(taskId), resultSize))</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resultSize &gt; maxDirectResultSize) &#123;</span><br><span class="line">          <span class="keyword">val</span> blockId = <span class="type">TaskResultBlockId</span>(taskId)</span><br><span class="line">          env.blockManager.putBytes(</span><br><span class="line">            blockId,</span><br><span class="line">            <span class="keyword">new</span> <span class="type">ChunkedByteBuffer</span>(serializedDirectResult.duplicate()),</span><br><span class="line">            <span class="type">StorageLevel</span>.<span class="type">MEMORY_AND_DISK_SER</span>)</span><br><span class="line">          logInfo(</span><br><span class="line">            <span class="string">s"Finished <span class="subst">$taskName</span> (TID <span class="subst">$taskId</span>). <span class="subst">$resultSize</span> bytes result sent via BlockManager)"</span>)</span><br><span class="line">          ser.serialize(<span class="keyword">new</span> <span class="type">IndirectTaskResult</span>[<span class="type">Any</span>](blockId, resultSize))</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          logInfo(<span class="string">s"Finished <span class="subst">$taskName</span> (TID <span class="subst">$taskId</span>). <span class="subst">$resultSize</span> bytes result sent to driver"</span>)</span><br><span class="line">          serializedDirectResult</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//无论失败与否发送一个状态statusUpdate  点击statusUpdate 我们查看一下</span></span><br><span class="line">      execBackend.statusUpdate(taskId, <span class="type">TaskState</span>.<span class="type">FINISHED</span>, serializedResult)</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> ffe: <span class="type">FetchFailedException</span> =&gt;</span><br><span class="line">        <span class="keyword">val</span> reason = ffe.toTaskFailedReason</span><br><span class="line">        setTaskFinishedAndClearInterruptStatus()</span><br><span class="line">        execBackend.statusUpdate(taskId, <span class="type">TaskState</span>.<span class="type">FAILED</span>, ser.serialize(reason))</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> _: <span class="type">TaskKilledException</span> =&gt;</span><br><span class="line">        logInfo(<span class="string">s"Executor killed <span class="subst">$taskName</span> (TID <span class="subst">$taskId</span>)"</span>)</span><br><span class="line">        setTaskFinishedAndClearInterruptStatus()</span><br><span class="line">        execBackend.statusUpdate(taskId, <span class="type">TaskState</span>.<span class="type">KILLED</span>, ser.serialize(<span class="type">TaskKilled</span>))</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> _: <span class="type">InterruptedException</span> <span class="keyword">if</span> task.killed =&gt;</span><br><span class="line">        logInfo(<span class="string">s"Executor interrupted and killed <span class="subst">$taskName</span> (TID <span class="subst">$taskId</span>)"</span>)</span><br><span class="line">        setTaskFinishedAndClearInterruptStatus()</span><br><span class="line">        execBackend.statusUpdate(taskId, <span class="type">TaskState</span>.<span class="type">KILLED</span>, ser.serialize(<span class="type">TaskKilled</span>))</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="type">CausedBy</span>(cDE: <span class="type">CommitDeniedException</span>) =&gt;</span><br><span class="line">        <span class="keyword">val</span> reason = cDE.toTaskFailedReason</span><br><span class="line">        setTaskFinishedAndClearInterruptStatus()</span><br><span class="line">        execBackend.statusUpdate(taskId, <span class="type">TaskState</span>.<span class="type">FAILED</span>, ser.serialize(reason))</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> t: <span class="type">Throwable</span> =&gt;</span><br><span class="line">        <span class="comment">// Attempt to exit cleanly by informing the driver of our failure.</span></span><br><span class="line">        <span class="comment">// If anything goes wrong (or this was a fatal exception), we will delegate to</span></span><br><span class="line">        <span class="comment">// the default uncaught exception handler, which will terminate the Executor.</span></span><br><span class="line">        logError(<span class="string">s"Exception in <span class="subst">$taskName</span> (TID <span class="subst">$taskId</span>)"</span>, t)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Collect latest accumulator values to report back to the driver</span></span><br><span class="line">        <span class="keyword">val</span> accums: <span class="type">Seq</span>[<span class="type">AccumulatorV2</span>[_, _]] =</span><br><span class="line">          <span class="keyword">if</span> (task != <span class="literal">null</span>) &#123;</span><br><span class="line">            task.metrics.setExecutorRunTime(<span class="type">System</span>.currentTimeMillis() - taskStart)</span><br><span class="line">            task.metrics.setJvmGCTime(computeTotalGcTime() - startGCTime)</span><br><span class="line">            task.collectAccumulatorUpdates(taskFailed = <span class="literal">true</span>)</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Seq</span>.empty</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> accUpdates = accums.map(acc =&gt; acc.toInfo(<span class="type">Some</span>(acc.value), <span class="type">None</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> serializedTaskEndReason = &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            ser.serialize(<span class="keyword">new</span> <span class="type">ExceptionFailure</span>(t, accUpdates).withAccums(accums))</span><br><span class="line">          &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> _: <span class="type">NotSerializableException</span> =&gt;</span><br><span class="line">              <span class="comment">// t is not serializable so just send the stacktrace</span></span><br><span class="line">              ser.serialize(<span class="keyword">new</span> <span class="type">ExceptionFailure</span>(t, accUpdates, <span class="literal">false</span>).withAccums(accums))</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        setTaskFinishedAndClearInterruptStatus()</span><br><span class="line">        execBackend.statusUpdate(taskId, <span class="type">TaskState</span>.<span class="type">FAILED</span>, serializedTaskEndReason)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Don't forcibly exit unless the exception was inherently fatal, to avoid</span></span><br><span class="line">        <span class="comment">// stopping other tasks unnecessarily.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="type">Utils</span>.isFatalError(t)) &#123;</span><br><span class="line">          <span class="type">SparkUncaughtExceptionHandler</span>.uncaughtException(t)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      runningTasks.remove(taskId)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="statusUpdate"><a href="#statusUpdate" class="headerlink" title="statusUpdate"></a>statusUpdate</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>[spark] <span class="class"><span class="keyword">trait</span> <span class="title">ExecutorBackend</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">statusUpdate</span></span>(taskId: <span class="type">Long</span>, state: <span class="type">TaskState</span>, data: <span class="type">ByteBuffer</span>): <span class="type">Unit</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://hphimages-1253879422.cos.ap-beijing.myqcloud.com/%E5%A4%A7%E6%95%B0%E6%8D%AE/Spark/%E5%86%85%E6%A0%B8/20190611233512.png" alt=""></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">statusUpdate</span></span>(taskId: <span class="type">Long</span>, state: <span class="type">TaskState</span>, data: <span class="type">ByteBuffer</span>) &#123;</span><br><span class="line">  <span class="keyword">val</span> msg = <span class="type">StatusUpdate</span>(executorId, taskId, state, data)</span><br><span class="line">  driver <span class="keyword">match</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Some</span>(driverRef) =&gt; driverRef.send(msg)  <span class="comment">//给driver发送了一条消息 控制权回到Driver</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">None</span> =&gt; logWarning(<span class="string">s"Drop <span class="subst">$msg</span> because has not yet connected to driver"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="回到CoarseGrainedSchedulerBackend-2"><a href="#回到CoarseGrainedSchedulerBackend-2" class="headerlink" title="回到CoarseGrainedSchedulerBackend"></a>回到CoarseGrainedSchedulerBackend</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">receive</span></span>: <span class="type">PartialFunction</span>[<span class="type">Any</span>, <span class="type">Unit</span>] = &#123;</span><br><span class="line">   <span class="keyword">case</span> <span class="type">StatusUpdate</span>(executorId, taskId, state, data) =&gt;</span><br><span class="line">     scheduler.statusUpdate(taskId, state, data.value) <span class="comment">//调用了scheduler(TaskSchedulerImpl)的statusUpdate方法</span></span><br><span class="line">     <span class="keyword">if</span> (<span class="type">TaskState</span>.isFinished(state)) &#123; <span class="comment">//如果任务结束了</span></span><br><span class="line">       executorDataMap.get(executorId) <span class="keyword">match</span> &#123;</span><br><span class="line">         <span class="keyword">case</span> <span class="type">Some</span>(executorInfo) =&gt; <span class="comment">//如果还有executor的资源</span></span><br><span class="line">           executorInfo.freeCores += scheduler.<span class="type">CPUS_PER_TASK</span></span><br><span class="line">           makeOffers(executorId) <span class="comment">//继续调度</span></span><br><span class="line">         <span class="keyword">case</span> <span class="type">None</span> =&gt;</span><br><span class="line">           <span class="comment">// Ignoring the update since we don't know about the executor.</span></span><br><span class="line">           logWarning(<span class="string">s"Ignored task status update (<span class="subst">$taskId</span> state <span class="subst">$state</span>) "</span> +</span><br><span class="line">             <span class="string">s"from unknown executor with ID <span class="subst">$executorId</span>"</span>)</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<h3 id="回到TaskSchedulerImpl"><a href="#回到TaskSchedulerImpl" class="headerlink" title="回到TaskSchedulerImpl"></a>回到TaskSchedulerImpl</h3><h3 id="statusUpdate-1"><a href="#statusUpdate-1" class="headerlink" title="statusUpdate"></a>statusUpdate</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">statusUpdate</span></span>(tid: <span class="type">Long</span>, state: <span class="type">TaskState</span>, serializedData: <span class="type">ByteBuffer</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> failedExecutor: <span class="type">Option</span>[<span class="type">String</span>] = <span class="type">None</span></span><br><span class="line">  <span class="keyword">var</span> reason: <span class="type">Option</span>[<span class="type">ExecutorLossReason</span>] = <span class="type">None</span></span><br><span class="line">  synchronized &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      taskIdToTaskSetManager.get(tid) <span class="keyword">match</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">Some</span>(taskSet) =&gt;</span><br><span class="line">          <span class="keyword">if</span> (state == <span class="type">TaskState</span>.<span class="type">LOST</span>) &#123; <span class="comment">//如果所有的任务状态都完成了</span></span><br><span class="line">            <span class="comment">// TaskState.LOST is only used by the deprecated Mesos fine-grained scheduling mode,</span></span><br><span class="line">            <span class="comment">// where each executor corresponds to a single task, so mark the executor as failed.</span></span><br><span class="line">            <span class="keyword">val</span> execId = taskIdToExecutorId.getOrElse(tid, <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IllegalStateException</span>(</span><br><span class="line">              <span class="string">"taskIdToTaskSetManager.contains(tid) &lt;=&gt; taskIdToExecutorId.contains(tid)"</span>))</span><br><span class="line">            <span class="keyword">if</span> (executorIdToRunningTaskIds.contains(execId)) &#123;</span><br><span class="line">              reason = <span class="type">Some</span>(</span><br><span class="line">                <span class="type">SlaveLost</span>(<span class="string">s"Task <span class="subst">$tid</span> was lost, so marking the executor as lost as well."</span>))</span><br><span class="line">              removeExecutor(execId, reason.get)  <span class="comment">//删除Executor</span></span><br><span class="line">              failedExecutor = <span class="type">Some</span>(execId)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (<span class="type">TaskState</span>.isFinished(state)) &#123;</span><br><span class="line">            cleanupTaskState(tid)</span><br><span class="line">            taskSet.removeRunningTask(tid)</span><br><span class="line">            <span class="keyword">if</span> (state == <span class="type">TaskState</span>.<span class="type">FINISHED</span>) &#123;</span><br><span class="line">              taskResultGetter.enqueueSuccessfulTask(taskSet, tid, serializedData)</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="type">Set</span>(<span class="type">TaskState</span>.<span class="type">FAILED</span>, <span class="type">TaskState</span>.<span class="type">KILLED</span>, <span class="type">TaskState</span>.<span class="type">LOST</span>).contains(state)) &#123;</span><br><span class="line">              taskResultGetter.enqueueFailedTask(taskSet, tid, state, serializedData)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">None</span> =&gt;</span><br><span class="line">          logError(</span><br><span class="line">            (<span class="string">"Ignoring update with state %s for TID %s because its task set is gone (this is "</span> +</span><br><span class="line">              <span class="string">"likely the result of receiving duplicate task finished status updates) or its "</span> +</span><br><span class="line">              <span class="string">"executor has been marked as failed."</span>)</span><br><span class="line">              .format(state, tid))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> e: <span class="type">Exception</span> =&gt; logError(<span class="string">"Exception in statusUpdate"</span>, e)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Update the DAGScheduler without holding a lock on this, since that can deadlock</span></span><br><span class="line">  <span class="keyword">if</span> (failedExecutor.isDefined) &#123;</span><br><span class="line">    assert(reason.isDefined)</span><br><span class="line">    dagScheduler.executorLost(failedExecutor.get, reason.get)</span><br><span class="line">    backend.reviveOffers()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此任务提交已经基本完成。</p>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a  href="/2019/06/10/Spark%E5%86%85%E6%A0%B8%E8%A7%A3%E6%9E%903/">Spark内核解析3</a></p>
        <p><span>文章作者:</span><a  href="/" title="访问 清风笑丶 的个人博客">清风笑丶</a></p>
        <p><span>发布时间:</span>2019年06月10日 - 12时37分</p>
        <p><span>最后更新:</span>2020年01月12日 - 21时08分</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2019/06/10/Spark%E5%86%85%E6%A0%B8%E8%A7%A3%E6%9E%903/" title="Spark内核解析3">https://www.hphblog.cn/2019/06/10/Spark%E5%86%85%E6%A0%B8%E8%A7%A3%E6%9E%903/</a>
            <span class="copy-path" data-clipboard-text="原文: https://www.hphblog.cn/2019/06/10/Spark%E5%86%85%E6%A0%B8%E8%A7%A3%E6%9E%903/　　作者: 清风笑丶" title=""></span>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



<nav id="article-nav">
  
    <a  href="/2020/01/05/Flink%E5%88%9D%E8%AF%86/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          Flink初识
        
      </div>
    </a>
  
  
    <a  href="/2019/06/09/Spark%E5%86%85%E6%A0%B8%E8%A7%A3%E6%9E%902/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Spark内核解析2</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>


  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#步骤"><span class="toc-number">1.</span> <span class="toc-text">步骤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#应用提交"><span class="toc-number">2.</span> <span class="toc-text">应用提交</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SparkSubumit"><span class="toc-number">2.1.</span> <span class="toc-text">SparkSubumit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#submit"><span class="toc-number">2.2.</span> <span class="toc-text">submit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#runMain"><span class="toc-number">2.3.</span> <span class="toc-text">runMain</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#prepareSubmitEnvironment"><span class="toc-number">2.4.</span> <span class="toc-text">prepareSubmitEnvironment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Client"><span class="toc-number">2.5.</span> <span class="toc-text">Client</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ClientEndpoint"><span class="toc-number">2.6.</span> <span class="toc-text">ClientEndpoint</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回到Master"><span class="toc-number">2.7.</span> <span class="toc-text">回到Master</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回到Clinet"><span class="toc-number">2.8.</span> <span class="toc-text">回到Clinet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pollAndReportStatus"><span class="toc-number">2.9.</span> <span class="toc-text">pollAndReportStatus</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回到Master-1"><span class="toc-number">2.10.</span> <span class="toc-text">回到Master</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#schedule"><span class="toc-number">2.11.</span> <span class="toc-text">schedule</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#launchDriver"><span class="toc-number">2.12.</span> <span class="toc-text">launchDriver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回到Worker"><span class="toc-number">2.13.</span> <span class="toc-text">回到Worker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LaunchDriver"><span class="toc-number">2.14.</span> <span class="toc-text">LaunchDriver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#调转DriverRunner"><span class="toc-number">2.15.</span> <span class="toc-text">调转DriverRunner</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#driver-star"><span class="toc-number">2.16.</span> <span class="toc-text">driver.star</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#prepareAndRunDriver"><span class="toc-number">2.17.</span> <span class="toc-text">prepareAndRunDriver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#runDriver"><span class="toc-number">2.18.</span> <span class="toc-text">runDriver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#runCommandWithRetry"><span class="toc-number">2.19.</span> <span class="toc-text">runCommandWithRetry</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#进入DriverWrapper"><span class="toc-number">2.20.</span> <span class="toc-text">进入DriverWrapper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回到Driver"><span class="toc-number">2.21.</span> <span class="toc-text">回到Driver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#handleDriverStateChanged"><span class="toc-number">2.22.</span> <span class="toc-text">handleDriverStateChanged</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sendToMaster"><span class="toc-number">2.23.</span> <span class="toc-text">sendToMaster</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回到Master-Driver启动完毕"><span class="toc-number">2.24.</span> <span class="toc-text">回到Master(Driver启动完毕)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#注册Application"><span class="toc-number">3.</span> <span class="toc-text">注册Application</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SparkEnv"><span class="toc-number">3.1.</span> <span class="toc-text">SparkEnv</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#主要初始化方法"><span class="toc-number">3.2.</span> <span class="toc-text">主要初始化方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#createTaskScheduler"><span class="toc-number">3.3.</span> <span class="toc-text">createTaskScheduler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动"><span class="toc-number">3.4.</span> <span class="toc-text">启动</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Excutor分配"><span class="toc-number">4.</span> <span class="toc-text">Excutor分配</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#StandaloneSchedulerBackend"><span class="toc-number">4.1.</span> <span class="toc-text">StandaloneSchedulerBackend</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CoarseGrainedSchedulerBackend"><span class="toc-number">4.2.</span> <span class="toc-text">CoarseGrainedSchedulerBackend</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回到StandaloneSchedulerBackend"><span class="toc-number">4.3.</span> <span class="toc-text">回到StandaloneSchedulerBackend</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#跳转StandaloneAppClient"><span class="toc-number">4.4.</span> <span class="toc-text">跳转StandaloneAppClient</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tryRegisterAllMasters"><span class="toc-number">4.5.</span> <span class="toc-text">tryRegisterAllMasters</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回到Master-2"><span class="toc-number">4.6.</span> <span class="toc-text">回到Master</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RegisterApplication"><span class="toc-number">4.7.</span> <span class="toc-text">RegisterApplication</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#schedule-1"><span class="toc-number">4.8.</span> <span class="toc-text">schedule</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#startExecutorsOnWorkers"><span class="toc-number">4.9.</span> <span class="toc-text">startExecutorsOnWorkers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#scheduleExecutorsOnWorkers"><span class="toc-number">4.10.</span> <span class="toc-text">scheduleExecutorsOnWorkers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#startExecutorsOnWorkers-1"><span class="toc-number">4.11.</span> <span class="toc-text">startExecutorsOnWorkers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#allocateWorkerResourceToExecutors"><span class="toc-number">4.12.</span> <span class="toc-text">allocateWorkerResourceToExecutors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#launchExecutor"><span class="toc-number">4.13.</span> <span class="toc-text">launchExecutor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回到Worker-1"><span class="toc-number">4.14.</span> <span class="toc-text">回到Worker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#跳转到ExecutorRunner"><span class="toc-number">4.15.</span> <span class="toc-text">跳转到ExecutorRunner</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fetchAndRunExecutor"><span class="toc-number">4.16.</span> <span class="toc-text">fetchAndRunExecutor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回到Master-3"><span class="toc-number">4.17.</span> <span class="toc-text">回到Master</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#跳转到StandaloneAppClient"><span class="toc-number">4.18.</span> <span class="toc-text">跳转到StandaloneAppClient</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ExecutorUpdated"><span class="toc-number">4.19.</span> <span class="toc-text">ExecutorUpdated</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#listener"><span class="toc-number">4.20.</span> <span class="toc-text">listener</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回到StandaloneSchedulerBackend-1"><span class="toc-number">4.21.</span> <span class="toc-text">回到StandaloneSchedulerBackend</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StandaloneAppClientListener"><span class="toc-number">4.22.</span> <span class="toc-text">StandaloneAppClientListener</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看executorAdded"><span class="toc-number">4.23.</span> <span class="toc-text">查看executorAdded</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#任务提交和反馈"><span class="toc-number">5.</span> <span class="toc-text">任务提交和反馈</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SparkContext"><span class="toc-number">5.1.</span> <span class="toc-text">SparkContext</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DAGScheduler"><span class="toc-number">5.2.</span> <span class="toc-text">DAGScheduler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#runrunJob"><span class="toc-number">5.3.</span> <span class="toc-text">runrunJob</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#submitJob"><span class="toc-number">5.4.</span> <span class="toc-text">submitJob</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#eventProcessLoop"><span class="toc-number">5.5.</span> <span class="toc-text">eventProcessLoop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DAGSchedulerEventProcessLoop"><span class="toc-number">5.6.</span> <span class="toc-text">DAGSchedulerEventProcessLoop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EventLoop"><span class="toc-number">5.7.</span> <span class="toc-text">EventLoop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回到DAGSchedulerEventProcessLoop"><span class="toc-number">5.8.</span> <span class="toc-text">回到DAGSchedulerEventProcessLoop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#handleJobSubmitted"><span class="toc-number">5.9.</span> <span class="toc-text">handleJobSubmitted</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#submitStage"><span class="toc-number">5.10.</span> <span class="toc-text">submitStage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getMissingParentStages"><span class="toc-number">5.11.</span> <span class="toc-text">getMissingParentStages</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#submitStage-1"><span class="toc-number">5.12.</span> <span class="toc-text">submitStage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#submitMissingTasks"><span class="toc-number">5.13.</span> <span class="toc-text">submitMissingTasks</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#submitTasks"><span class="toc-number">5.14.</span> <span class="toc-text">submitTasks</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#跳转TaskSchedulerImpl"><span class="toc-number">5.15.</span> <span class="toc-text">跳转TaskSchedulerImpl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#submitTasks-1"><span class="toc-number">5.16.</span> <span class="toc-text">submitTasks</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回到CoarseGrainedSchedulerBackend"><span class="toc-number">5.17.</span> <span class="toc-text">回到CoarseGrainedSchedulerBackend</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#makeOffers"><span class="toc-number">5.18.</span> <span class="toc-text">makeOffers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#跳转TaskSchedulerImpl-1"><span class="toc-number">5.19.</span> <span class="toc-text">跳转TaskSchedulerImpl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#resourceOffers"><span class="toc-number">5.20.</span> <span class="toc-text">resourceOffers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回到CoarseGrainedSchedulerBackend-1"><span class="toc-number">5.21.</span> <span class="toc-text">回到CoarseGrainedSchedulerBackend</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#跳转CoarseGrainedExecutorBackend"><span class="toc-number">5.22.</span> <span class="toc-text">跳转CoarseGrainedExecutorBackend</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LaunchTask"><span class="toc-number">5.23.</span> <span class="toc-text">LaunchTask</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#跳转到Executor"><span class="toc-number">5.24.</span> <span class="toc-text">跳转到Executor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#launchTask"><span class="toc-number">5.25.</span> <span class="toc-text">launchTask</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TaskRunner"><span class="toc-number">5.26.</span> <span class="toc-text">TaskRunner</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#statusUpdate"><span class="toc-number">5.27.</span> <span class="toc-text">statusUpdate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回到CoarseGrainedSchedulerBackend-2"><span class="toc-number">5.28.</span> <span class="toc-text">回到CoarseGrainedSchedulerBackend</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回到TaskSchedulerImpl"><span class="toc-number">5.29.</span> <span class="toc-text">回到TaskSchedulerImpl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#statusUpdate-1"><span class="toc-number">5.30.</span> <span class="toc-text">statusUpdate</span></a></li></ol></li></ol>
</div>
<style>
    .left-col .switch-btn {
        display: none;
    }
    .left-col .switch-area {
        display: none;
    }
</style>
<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>

<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";
    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }
    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
            $(".switch-btn, .switch-area").fadeOut(300);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
            $(".switch-btn, .switch-area").fadeIn(500);
        }
    })
    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
        $(".switch-btn, .switch-area").show();
    }
</script>




<div class="bdsharebuttonbox">
	<a href="#" class="fx fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
	<a href="#" class="fx fa-weixin bds_weixin" data-cmd="weixin" title="分享到微信"></a>
	<a href="#" class="fx fa-qq bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
	<a href="#" class="fx fa-facebook-official bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
	<a href="#" class="fx fa-twitter bds_twi" data-cmd="twi" title="分享到Twitter"></a>
	<a href="#" class="fx fa-linkedin bds_linkedin" data-cmd="linkedin" title="分享到linkedin"></a>
	<a href="#" class="fx fa-files-o bds_copy" data-cmd="copy" title="分享到复制网址"></a>
</div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>




    
        <section class="changyan" id="comments">
  <!--<div id="uyan_frame"></div>-->
  <div id="SOHUCS"></div>
  <script charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/changyan.js"></script>
  <script type="text/javascript">
    window.changyan.api.config({
      appid: 'cyu9wWYgq',
      conf: 'prod_cca6a7c58b43f725f8489bdcee045320'
    });
  </script>
  <style>#feedAv{ margin-top: -250px !important;transform: scale(0) !important;}</style>
  <style>#pop_ad{ margin-top: -250px !important;transform: scale(0) !important;}</style>
</section>

    



    <div class="scroll" id="post-nav-button">
        
            <a  href="/2020/01/05/Flink%E5%88%9D%E8%AF%86/" title="上一篇: Flink初识">
                <i class="fa fa-angle-left"></i>
            </a>
        
        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>
        
            <a  href="/2019/06/09/Spark%E5%86%85%E6%A0%B8%E8%A7%A3%E6%9E%902/" title="下一篇: Spark内核解析2">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>
    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/01/05/Flink%E5%88%9D%E8%AF%86/">Flink初识</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/10/Spark%E5%86%85%E6%A0%B8%E8%A7%A3%E6%9E%903/">Spark内核解析3</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/09/Spark%E5%86%85%E6%A0%B8%E8%A7%A3%E6%9E%902/">Spark内核解析2</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/09/Spark%E5%86%85%E6%A0%B8%E8%A7%A3%E6%9E%90/">Spark内核解析1</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/08/Spark%E4%B9%8BGraphX/">Spark之GraphX</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/07/Spark%E4%B9%8BStructuredStreaming/">Spark之StructuredStreaming</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/06/Spark%E4%B9%8BSparkStreaming%E7%9A%84DStream%E6%93%8D%E4%BD%9C/">Spark之SparkStreaming的DStream操作</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/05/Spark%E4%B9%8BSparkStreaming%E6%95%B0%E6%8D%AE%E6%BA%90/">Spark之SparkStreaming数据源</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/03/Spark%E4%B9%8BSparkStreaming%E7%90%86%E8%AE%BA%E7%AF%87/">Spark之SparkStreaming理论篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/01/Spark%E4%B9%8BSparkSQL%E6%95%B0%E6%8D%AE%E6%BA%90/">Spark之SparkSQL数据源</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/30/Spark%E4%B9%8BSparkSQL%E5%AE%9E%E6%88%98/">Spark之SparkSQL实战</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/30/Spark%E4%B9%8BSparkSQL/">Spark之SparkSQL理论篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/29/Spark%E4%B9%8BRDD%E5%AE%9E%E6%88%98%E7%AF%873/">Spark之RDD实战篇3</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/28/Spark%E4%B9%8BRDD%E5%AE%9E%E6%88%98%E7%AF%872/">Spark之RDD实战2</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/27/Spark%E4%B9%8BRDD%E5%AE%9E%E6%88%98%E7%AF%87/">Spark之RDD实战篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/27/Spark%E4%B9%8BRDD/">Spark之RDD理论篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/27/Spark%E4%B9%8BRDD%E7%90%86%E8%AE%BA%E7%AF%87/">Spark之RDD理论篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/26/Spark%E7%94%9F%E6%80%81%E5%9C%88%E5%8F%8A%E5%AE%89%E8%A3%85/">Spark生态圈及安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/26/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8B%E5%93%88%E5%B8%8C%E8%A1%A8/">数据结构之哈希表</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/23/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8B%E7%BA%A2%E9%BB%91%E6%A0%91/">数据结构之红黑树</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/22/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8BAVL%E6%A0%91/">数据结构之AVL树</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/14/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8B%E5%B9%B6%E6%9F%A5%E9%9B%86/">数据结构之并查集</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/14/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8B%E5%AD%97%E5%85%B8%E6%A0%91/">数据结构之字典树</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/10/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8B%E5%A0%86%E4%B8%8E%E4%BC%98%E5%85%88%E9%98%9F%E5%88%97/">数据结构之堆与优先队列</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/07/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8B%E4%BA%8C%E5%8F%89%E6%A0%91/">数据结构之二叉树</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/06/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8B%E9%80%92%E5%BD%92/">数据结构之递归</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/04/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8B%E9%93%BE%E8%A1%A8/">数据结构之链表</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/03/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8B%E9%98%9F%E5%88%97/">数据结构之队列</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/03/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8B%E6%A0%88/">数据结构之栈</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/02/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8B%E6%95%B0%E7%BB%84/">数据结构之数组</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/02/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95%E5%89%8D%E6%8F%90/">数据结构与算法前置</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/28/Java%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84%E6%BC%94%E8%BF%9B%E5%92%8CSpringCloud%E6%80%BB%E7%BB%93/">Java项目架构演进和SpringCloud总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/27/SpringCloud%E4%B8%8ESpringConfig%E5%88%86%E5%B8%83%E5%BC%8F%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/">SpringCloud与SpringConfig分布式配置中心</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/27/SpringCloud%E4%B8%8Ezuul/">SpringCloud与zuul</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/27/SpringCloud%E4%B8%8EHystrix%E6%96%AD%E8%B7%AF%E5%99%A8/">SpringCloud与Hystrix断路器</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/26/SpringCloud%E4%B8%8EFeign%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/">SpringCloud与Feign</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/25/SpringCloud%E7%9A%84Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/">SpringCloud的Ribbon负载均衡</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/23/SpringCloud%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0Eureka/">SpringCloud注册与发现Eureka</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/SpringCloud%E4%B8%8EREST%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%84%E5%BB%BA/">微服务与SpringCloud</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/18/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%8ESpringCloud/">微服务与SpringCloud</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/14/SpringBoot%E5%92%8C%E7%9B%91%E6%8E%A7%E7%AE%A1%E7%90%86/">SpringBoot和监控管理</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/14/SpringBoot%E4%B8%8ESpringCloud%E9%9B%86%E6%88%90/">SpringBoot与SpringCloud集成</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/13/SpringBoot%E4%B8%8EDubbo%E9%9B%86%E6%88%90/">SpringBoot与Dubbo集成</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/13/SpringBoot%E5%AE%89%E5%85%A8/">SpringBoot与安全</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/13/SpringBoot%E4%B8%8E%E4%BB%BB%E5%8A%A1/">SpringBoot与任务</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/12/SpringBoot%E5%92%8CElasticSearch%E9%9B%86%E6%88%90/">SpringBoot和Elasticsearch集成</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/12/Elasticsearch%E7%AE%80%E4%BB%8B/">Elasticsearch简介</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/11/SpringBoot%E5%92%8CRabbitMQ%E9%9B%86%E6%88%90/">SpringBoot和RabbitMQ集成</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/11/SpringBoot%E5%92%8C%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列RabbitMQ</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/10/SpringBoot%E4%B8%8ERedis%E7%BC%93%E5%AD%98/">SpringBoot与Redis缓存</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/09/SpringBoot%E5%92%8C%E7%BC%93%E5%AD%98/">SpringBoot和缓存</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/09/SpringBoot%E4%B8%8EJPA/">SpringBoot与JPA</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/08/SpringBoot%E4%B8%8EMybatis%E7%9A%84%E9%9B%86%E6%88%90/">SpringBoot与Mybatis的集成</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/08/SpringBoot%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE/">SpringBoot数据访问</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/07/DockerFile/">DockerFile</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/06/Docker%E5%AD%98%E5%82%A8%E5%8D%B7/">Docker存储卷</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/06/Dokcer%E7%BD%91%E7%BB%9C/">Dokcer网络</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/05/Docker%E7%9A%84%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4/">Docker的基础命令</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/04/Docker%E5%88%9D%E8%AF%86%E4%B8%8E%E5%AE%89%E8%A3%85/">Docker初识与安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/03/SpringBoot%E4%BD%BF%E7%94%A8%E5%A4%96%E7%BD%AE%E7%9A%84Servlet%E5%AE%B9%E5%99%A8/">SpringBoot使用外置的Servlet容器</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/02/SpringBoot%E9%85%8D%E7%BD%AE%E5%B5%8C%E5%85%A5%E5%BC%8FServlet%E5%AE%B9%E5%99%A8/">SpringBoot配置嵌入式Servlet容器</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/29/SpringBoot%E4%B9%8BSpringMVC%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE/">SpringBoot之SpringMVC自动配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/29/SpringBoot%E4%B9%8BThymeleaf/">SpringBoot之Thymeleaf</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/29/SpringBoot%E7%9A%84Web%E5%BC%80%E5%8F%91/">SpringBoot的Web开发</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/28/SpringBoot%E7%9A%84%E6%97%A5%E5%BF%97%E6%A1%86%E6%9E%B6/">SpringBoot的日志框架</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/28/SpringBoot%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D%E6%8E%A2%E7%A9%B6/">SpringBoot自动装配探究</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/25/SpringBoot%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/">SpringBoot的配置文件</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/25/SpringBoot%E5%88%9D%E8%AF%86/">SpringBoot初识</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/24/SSM%E9%9B%86%E6%88%90/">SSM集成</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/19/SSM%E6%95%B4%E5%90%88/">SSM整合</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/19/Mybatis%E4%B9%8B%E5%8A%A8%E6%80%81SQL/">Mybatis之动态SQL</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/19/Mybatis%E7%9A%84resultMap%E8%87%AA%E5%AE%9A%E4%B9%89%E6%98%A0%E5%B0%84/">Mybatis的resultMap自定义映射</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/18/MyBatis%E7%9A%84CURD/">MyBatis的CURD</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/18/MyBatis%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%92%8C%E6%98%A0%E5%B0%84%E6%96%87%E4%BB%B6/">MyBatis全局配置文件和映射文件</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/16/Mybatis%E5%85%A5%E9%97%A8/">Mybatis入门</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/13/Spring%E5%92%8CSpringMVC%E6%95%B4%E5%90%88/">Spring和SpringMVC整合</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/12/SpringMV%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/">SpringMV工作流程分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/11/SpringMVC%E8%BF%9B%E9%98%B6/">SpringMVC处理Json、文件上传、拦截器</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/07/Spring%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%E6%88%96%E5%93%8D%E5%BA%94%E6%95%B0%E6%8D%AE/">SpringMVC处理请求或响应数据</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/06/SpringMVC%E6%A6%82%E8%BF%B0/">SpringMVC概述</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/05/Spring%E4%BA%8B%E5%8A%A1%E6%A6%82%E8%BF%B0/">Spring声明式事务</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/05/JdbcTemplate/">JdbcTemplate</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/03/AOP%E6%A6%82%E8%BF%B0/">AOP概述</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/02/SpringIOC%E5%AE%B9%E5%99%A8%E5%92%8CBean%E7%9A%84%E9%85%8D%E7%BD%AE/">Spring IOC容器和Bean的配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/02/Spring%E6%A6%82%E8%BF%B0/">Spring概述</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/18/Hive%E8%B0%83%E4%BC%98/">Hive调优</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/17/Hive%E6%9F%A5%E8%AF%A2/">Hive查询</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/16/Hive%E6%95%B0%E6%8D%AE%E6%8D%AE%E7%B1%BB%E5%9E%8B/">Hive数据据类型 DDL DML</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/15/Kafka-API%E5%AE%9E%E6%88%98/">KafkaAPI实战</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/11/Git%E4%BD%BF%E7%94%A8/">Git使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/10/Oozie/">Oozie</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/08/Sqoop/">Sqoop</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/07/Flume%E6%A1%88%E4%BE%8BGanglia%E7%9B%91%E6%8E%A7/">Flume案例Ganglia监控</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/06/ZooKeeper%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8CAPI/">ZooKeeper的安装和API</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/05/Zookeeper%E5%85%A5%E9%97%A8/">Zookeeper入门</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/31/HBase%E4%BC%98%E5%8C%96/">HBase优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/31/HBase%E7%9A%84Shell%E5%91%BD%E4%BB%A4%E5%92%8CJavaAPI/">HBase的Shell命令和JavaAPI</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/30/HBase%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E5%92%8C%E8%AF%BB%E5%86%99%E5%8E%9F%E7%90%86/">HBase数据模型和读写原理</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/30/Hbase%E5%8E%9F%E7%90%86%E5%92%8C%E5%AE%89%E8%A3%85/">HBase原理和安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/28/MapReduce%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B2/">MapReduce高级编程2</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/28/MapReduce%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/">MapReduce高级编程</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/25/MapReduce%E7%BC%96%E7%A8%8B%E5%88%A8%E6%9E%90/">MapReduce源码刨析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/24/MapReduce%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6/">MapReduce的工作机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/22/Mapreduce/">MapReduce入门和优化方案</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/20/Hadoop%E7%9A%84RPC/">Hadoop的RPC工作原理</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/20/Hadoop%E7%9A%84IO%E6%93%8D%E4%BD%9C/">Hadoop的I/O操作</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/19/Yarn/">Yarn</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/19/HDFS%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD/">HDFS高级功能</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/18/HDFS%E7%9A%84%E6%93%8D%E4%BD%9CSHELL%E5%92%8CAPI/">HDFS的操作SHELL和API</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/17/Hadoop%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9FHDFS/">Hadoop分布式文件系统HDFS</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/17/Hadoop%E7%AE%80%E4%BB%8B%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%89%E8%A3%85/">Hadoop简介与分布式安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/16/Elasticsearch%E7%9A%84JavaAPI/">Elasticsearch的JavaAPI</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/16/Elasticsearch%E5%88%86%E5%B8%83%E5%BC%8F%E6%9C%BA%E5%88%B6%E6%8E%A2%E7%A9%B6/">Elasticsearch分布式机制探究</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/16/Elasticsearch%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90/">Elasticsearch聚合分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/16/Elasticsearch%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5/">Elasticsearch增删改查</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/15/ElasticSearch%E7%B4%A2%E5%BC%95/">ElasticSearch索引</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/15/Elasticsearch%E7%AE%80%E4%BB%8B%E4%B8%8E%E5%AE%89%E8%A3%85/">Elasticsearch简介与安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/12/MongoDB%E8%BF%9B%E9%98%B6/">MongoDB进阶</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/11/MongoDB%E8%81%9A%E5%90%88/">MongoDB聚合</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/10/MongoDB%E7%B4%A2%E5%BC%95/">MongoDB索引</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/09/MongoDB%E6%9F%A5%E8%AF%A2/">MongoDB查询</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/09/MongoDB%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4/">MongoDB基础命令</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/08/MongoDB%E5%85%A5%E9%97%A8/">MongoDB入门</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/07/Redis%E7%9A%84%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F/">Redis的集群模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/07/Redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/">Redis主从复制</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/07/Redis%E6%8C%81%E4%B9%85%E5%8C%96/">Redis持久化</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/07/Redis%E4%BA%8B%E5%8A%A1/">Redis事务</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/04/memcached/">Memcached</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/03/Redis/">Redis</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/03/Hive/">Hive</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/16/Flume/">Flume架构</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/16/kafka%E5%B7%A5%E4%BD%9C%E6%B5%81%E5%88%86%E6%9E%90/">Kafka深度解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/14/Kafka%E5%91%BD%E4%BB%A4%E6%93%8D%E4%BD%9C/">Kafka命令操作</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/14/Kafka%E4%BB%8B%E7%BB%8D%E4%B8%8E%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">Kafka与消息队列</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/14/Kafka%E7%9A%84%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/">Kafka和的安装与配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/12/Java%E8%99%9A%E6%8B%9F%E6%9C%BA------JVM%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7/">Java虚拟机------JVM分析工具</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/12/Java%E8%99%9A%E6%8B%9F%E6%9C%BA-JVM%E5%B8%B8%E8%A7%81%E5%8F%82%E6%95%B0/">Java虚拟机--------JVM常见参数</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/11/Java%E8%99%9A%E6%8B%9F%E6%9C%BA------%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8/">Java虚拟机------垃圾收集器</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/10/Java%E8%99%9A%E6%8B%9F%E6%9C%BA------JVM%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F/">Java虚拟机------JVM内存区域</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/10/Java%E8%99%9A%E6%8B%9F%E6%9C%BA------JVM%E4%BB%8B%E7%BB%8D/">Java虚拟机------JVM介绍</a></li></ul>
    
<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>

    <script>
        $(".post-list").addClass("toc-article");
        // $(".post-list-item a").attr("target","_blank");
        $("#post-nav-button > a:nth-child(2)").click(function() {
            $(".fa-bars, .fa-times").toggle();
            $(".post-list").toggle(300);
            if ($(".toc").length > 0) {
                $("#toc, #tocButton").toggle(200, function() {
                    if ($(".switch-area").is(":visible")) {
                        $("#toc, .switch-btn, .switch-area").toggle();
                        $("#tocButton").attr("value", valueHide);
                        }
                    })
            }
            else {
                $(".switch-btn, .switch-area").fadeToggle(300);
            }
        })
    </script>




    <script>
        
    </script>

</div>
      <footer id="footer">

    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2020 清风笑丶
            </div>
            <div class="footer-right">
                <a href="http://beian.miit.gov.cn" target="_blank"> 豫ICP备18042969号-1	</a><a href="" target="_blank"></a>
                <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >极客到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    
<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>


<script src="/js/main.js"></script>


    <script>
        $(document).ready(function() {
            var backgroundnum = 2;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-129731340-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?a138f5cac94c7795df86f17cea34efc4";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(
            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>


  </div>
</body>
</html>